name: CI

on:
  pull_request:
  push:
    branches: [ main ]

# Concurrency: Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RAILS_ENV: test
  DISABLE_DATABASE_ENVIRONMENT_CHECK: 1
  RUBY_VERSION: '3.4.3'
  NODE_VERSION: '20'

jobs:
  # ============================================
  # STAGE 1: Quick checks (parallel, no DB needed)
  # ============================================
  scan_ruby:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - run: gem install brakeman
      - run: brakeman --no-pager

  scan_js:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - run: bundle exec importmap audit || echo "Skipping importmap audit"

  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - run: gem install rubocop rubocop-rails
      - run: rubocop -f github || true

  # ============================================
  # STAGE 2: Build assets (shared by all test jobs)
  # ============================================
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate cache key
        id: cache-key
        run: echo "key=assets-${{ hashFiles('app/assets/**', 'app/javascript/**', 'package-lock.json', 'Gemfile.lock') }}" >> $GITHUB_OUTPUT

      - name: Cache built assets
        id: cache-assets
        uses: actions/cache@v4
        with:
          path: |
            app/assets/builds
            node_modules
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            assets-

      - name: Set up Ruby
        if: steps.cache-assets.outputs.cache-hit != 'true'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Set up Node.js
        if: steps.cache-assets.outputs.cache-hit != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies and build assets
        if: steps.cache-assets.outputs.cache-hit != 'true'
        run: |
          npm install
          mkdir -p app/assets/builds
          
          # Build CSS
          AA_PATH=$(bundle info activeadmin --path)
          npx sass ./app/assets/stylesheets/application.sass.scss:./app/assets/builds/application.css --no-source-map --load-path=node_modules
          npx sass ./app/assets/stylesheets/active_admin.scss:./app/assets/builds/active_admin.css --no-source-map --load-path=node_modules --load-path="$AA_PATH/app/assets/stylesheets"
          
          # Build JS
          npx esbuild app/javascript/application.js --bundle --outfile=app/assets/builds/application.js
          
          # Build Tailwind
          chmod +x bin/build-tailwind-standalone.sh
          SKIP_SOLID_QUEUE_SETUP=true ./bin/build-tailwind-standalone.sh

      - name: Upload built assets
        uses: actions/upload-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
          retention-days: 1

  # ============================================
  # STAGE 3: Test jobs (depend on build)
  # Split tests for parallel execution (<10min target)
  # ============================================
  
  # Model tests - split into 3 groups
  test_models_1:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run model tests (group 1)
        run: |
          chmod +x bin/split_model_tests.rb
          TESTS=$(./bin/split_model_tests.rb 1)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi

  test_models_2:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run model tests (group 2)
        run: |
          chmod +x bin/split_model_tests.rb
          TESTS=$(./bin/split_model_tests.rb 2)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi

  test_models_3:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run model tests (group 3)
        run: |
          chmod +x bin/split_model_tests.rb
          TESTS=$(./bin/split_model_tests.rb 3)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi

  # Request tests - split into 3 groups
  test_requests_1:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run request tests (group 1)
        run: |
          chmod +x bin/split_request_tests.rb
          TESTS=$(./bin/split_request_tests.rb 1)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi

  test_requests_2:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run request tests (group 2)
        run: |
          chmod +x bin/split_request_tests.rb
          TESTS=$(./bin/split_request_tests.rb 2)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi

  test_requests_3:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run request tests (group 3)
        run: |
          chmod +x bin/split_request_tests.rb
          TESTS=$(./bin/split_request_tests.rb 3)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi

  # Service tests - split into 5 groups
  test_services_1:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run service tests (group 1)
        run: |
          chmod +x bin/split_service_tests.rb
          TESTS=$(./bin/split_service_tests.rb 1)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi

  test_services_2:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run service tests (group 2)
        run: |
          chmod +x bin/split_service_tests.rb
          TESTS=$(./bin/split_service_tests.rb 2)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi

  test_services_3:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run service tests (group 3)
        run: |
          chmod +x bin/split_service_tests.rb
          TESTS=$(./bin/split_service_tests.rb 3)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi

  test_services_4:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run service tests (group 4)
        run: |
          chmod +x bin/split_service_tests.rb
          TESTS=$(./bin/split_service_tests.rb 4)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi

  test_services_5:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run service tests (group 5)
        run: |
          chmod +x bin/split_service_tests.rb
          TESTS=$(./bin/split_service_tests.rb 5)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi

  # Integration/feature/mailer tests
  test_integration:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - run: bundle exec rspec spec/integration spec/features spec/mailers --format progress

  # Other tests (controllers, helpers, lib, views, security, channels) - split into 2 groups
  test_other_1:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run other tests (group 1)
        run: |
          chmod +x bin/split_other_tests.rb
          TESTS=$(./bin/split_other_tests.rb 1)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi

  test_other_2:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run other tests (group 2)
        run: |
          chmod +x bin/split_other_tests.rb
          TESTS=$(./bin/split_other_tests.rb 2)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi

  # System tests - split into 7 groups (browser tests are slowest)
  test_system_1:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      CI: true
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - run: sudo apt-get update && sudo apt-get install -y google-chrome-stable
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run system tests (group 1)
        run: |
          chmod +x bin/split_system_tests.rb
          TESTS=$(./bin/split_system_tests.rb 1)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots-system-1
          path: tmp/screenshots
          if-no-files-found: ignore

  test_system_2:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      CI: true
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - run: sudo apt-get update && sudo apt-get install -y google-chrome-stable
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run system tests (group 2)
        run: |
          chmod +x bin/split_system_tests.rb
          TESTS=$(./bin/split_system_tests.rb 2)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots-system-2
          path: tmp/screenshots
          if-no-files-found: ignore

  test_system_3:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      CI: true
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - run: sudo apt-get update && sudo apt-get install -y google-chrome-stable
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run system tests (group 3)
        run: |
          chmod +x bin/split_system_tests.rb
          TESTS=$(./bin/split_system_tests.rb 3)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots-system-3
          path: tmp/screenshots
          if-no-files-found: ignore

  test_system_4:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      CI: true
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - run: sudo apt-get update && sudo apt-get install -y google-chrome-stable
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run system tests (group 4)
        run: |
          chmod +x bin/split_system_tests.rb
          TESTS=$(./bin/split_system_tests.rb 4)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots-system-4
          path: tmp/screenshots
          if-no-files-found: ignore

  test_system_5:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      CI: true
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - run: sudo apt-get update && sudo apt-get install -y google-chrome-stable
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run system tests (group 5)
        run: |
          chmod +x bin/split_system_tests.rb
          TESTS=$(./bin/split_system_tests.rb 5)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots-system-5
          path: tmp/screenshots
          if-no-files-found: ignore

  test_system_6:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      CI: true
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - run: sudo apt-get update && sudo apt-get install -y google-chrome-stable
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run system tests (group 6)
        run: |
          chmod +x bin/split_system_tests.rb
          TESTS=$(./bin/split_system_tests.rb 6)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots-system-6
          path: tmp/screenshots
          if-no-files-found: ignore

  test_system_7:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      CI: true
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - run: sudo apt-get update && sudo apt-get install -y google-chrome-stable
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - run: bundle exec rails db:create db:schema:load
      - name: Run system tests (group 7)
        run: |
          chmod +x bin/split_system_tests.rb
          TESTS=$(./bin/split_system_tests.rb 7)
          if [ -n "$TESTS" ]; then
            bundle exec rspec $TESTS --format progress
          fi
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots-system-7
          path: tmp/screenshots
          if-no-files-found: ignore

  # Performance test - runs on all PRs and main
  performance_test:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      RAILS_ENV: test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
      - name: Setup database with seed data
        run: |
          bundle exec rails db:create db:schema:load db:seed
          bundle exec rake ci:create_performance_test_data
      - name: Run performance test
        run: |
          # Start server in background
          bundle exec rails server -p 3000 -b 0.0.0.0 &
          SERVER_PID=$!
          
          # Wait for server to be ready (up to 60 seconds)
          echo "Waiting for server to start..."
          for i in $(seq 1 60); do
            # Check if we can connect to the server (any response means it's running)
            if curl -s --connect-timeout 2 --max-time 5 http://127.0.0.1:3000/ > /dev/null 2>&1; then
              echo "Server is ready after ${i} seconds"
              break
            fi
            if [ "$i" -eq 60 ]; then
              echo "Server failed to start within 60 seconds"
              kill $SERVER_PID 2>/dev/null || true
              exit 1
            fi
            sleep 1
          done
          
          # Run performance test using 127.0.0.1 with Host header
          ruby script/performance_test.rb -u "http://127.0.0.1:3000/calendar" -n 100 -c 10 -H "consultllc.lvh.me"
          
          # Cleanup
          kill $SERVER_PID 2>/dev/null || true

  # ============================================
  # STAGE 4: Deploy (only on main after all tests pass)
  # ============================================
  deploy:
    needs: [scan_ruby, scan_js, lint, test_models_1, test_models_2, test_models_3, test_requests_1, test_requests_2, test_requests_3, test_services_1, test_services_2, test_services_3, test_services_4, test_services_5, test_integration, test_other_1, test_other_2, test_system_1, test_system_2, test_system_3, test_system_4, test_system_5, test_system_6, test_system_7, performance_test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          curl -X POST https://api.render.com/v1/deploys \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"serviceId": "srv-cvlj0jfgi27c73e3u680"}'
