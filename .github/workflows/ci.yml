name: CI

on:
  pull_request:
  push:
    branches: [ main ]

# Concurrency: Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RAILS_ENV: test
  DISABLE_DATABASE_ENVIRONMENT_CHECK: 1
  RUBY_VERSION: '3.4.3'
  NODE_VERSION: '20'

jobs:
  # ============================================
  # STAGE 1: Quick checks (parallel, no DB needed)
  # ============================================
  scan_ruby:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - run: gem install brakeman
      - run: brakeman --no-pager

  scan_js:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - run: bundle exec importmap audit || echo "Skipping importmap audit"

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - run: gem install rubocop rubocop-rails
      - run: rubocop -f github || true

  # ============================================
  # STAGE 2: Build assets (shared by all test jobs)
  # ============================================
  build:
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate cache key
        id: cache-key
        run: echo "key=assets-${{ hashFiles('app/assets/**', 'app/javascript/**', 'package-lock.json', 'Gemfile.lock') }}" >> $GITHUB_OUTPUT

      - name: Cache built assets
        id: cache-assets
        uses: actions/cache@v4
        with:
          path: |
            app/assets/builds
            node_modules
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            assets-

      - name: Set up Ruby
        if: steps.cache-assets.outputs.cache-hit != 'true'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Set up Node.js
        if: steps.cache-assets.outputs.cache-hit != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies and build assets
        if: steps.cache-assets.outputs.cache-hit != 'true'
        run: |
          npm install
          mkdir -p app/assets/builds
          
          # Build CSS
          AA_PATH=$(bundle info activeadmin --path)
          npx sass ./app/assets/stylesheets/application.sass.scss:./app/assets/builds/application.css --no-source-map --load-path=node_modules
          npx sass ./app/assets/stylesheets/active_admin.scss:./app/assets/builds/active_admin.css --no-source-map --load-path=node_modules --load-path="$AA_PATH/app/assets/stylesheets"
          
          # Build JS
          npx esbuild app/javascript/application.js --bundle --outfile=app/assets/builds/application.js
          
          # Build Tailwind
          chmod +x bin/build-tailwind-standalone.sh
          SKIP_SOLID_QUEUE_SETUP=true ./bin/build-tailwind-standalone.sh

      - name: Upload built assets
        uses: actions/upload-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds
          retention-days: 1

  # ============================================
  # STAGE 3: Test jobs (depend on build)
  # ============================================
  
  # Model tests - fast, no browser
  test_models:
    needs: build
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Download built assets
        uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds

      - name: Setup database
        run: |
          bundle exec rails db:create db:schema:load

      - name: Run model tests
        run: bundle exec rspec spec/models --format progress

  # Request tests - combined into single job
  test_requests:
    needs: build
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Download built assets
        uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds

      - name: Setup database
        run: bundle exec rails db:create db:schema:load

      - name: Run request tests
        run: bundle exec rspec spec/requests --format progress

  # Service/job/policy tests - combined
  test_services:
    needs: build
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Download built assets
        uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds

      - name: Setup database
        run: bundle exec rails db:create db:schema:load

      - name: Run service tests
        run: bundle exec rspec spec/services spec/jobs spec/policies --format progress

  # Integration/feature/mailer tests
  test_integration:
    needs: build
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Download built assets
        uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds

      - name: Setup database
        run: bundle exec rails db:create db:schema:load

      - name: Run integration tests
        run: bundle exec rspec spec/integration spec/features spec/mailers --format progress

  # Other tests (controllers, helpers, lib, views)
  test_other:
    needs: build
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Download built assets
        uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds

      - name: Setup database
        run: bundle exec rails db:create db:schema:load

      - name: Run other tests
        run: bundle exec rspec spec/controllers spec/helpers spec/lib spec/views spec/security spec/channels --format progress

  # System tests - split into 3 parallel jobs (browser-based, slowest)
  test_system_1:
    needs: build
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      CI: true
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
      - uses: actions/checkout@v4
      
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Download built assets
        uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds

      - name: Setup database
        run: bundle exec rails db:create db:schema:load

      - name: Run system tests (group 1)
        run: |
          chmod +x bin/split_system_tests.rb
          TESTS=$(./bin/split_system_tests.rb 1)
          [ -n "$TESTS" ] && bundle exec rspec $TESTS --format progress || echo "No tests in group 1"

      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots-system-1
          path: tmp/screenshots
          if-no-files-found: ignore

  test_system_2:
    needs: build
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      CI: true
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
      - uses: actions/checkout@v4
      
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Download built assets
        uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds

      - name: Setup database
        run: bundle exec rails db:create db:schema:load

      - name: Run system tests (group 2)
        run: |
          chmod +x bin/split_system_tests.rb
          TESTS=$(./bin/split_system_tests.rb 2)
          [ -n "$TESTS" ] && bundle exec rspec $TESTS --format progress || echo "No tests in group 2"

      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots-system-2
          path: tmp/screenshots
          if-no-files-found: ignore

  test_system_3:
    needs: build
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      CI: true
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}
      DISABLE_SIMPLECOV_BRANCH: true

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
      - uses: actions/checkout@v4
      
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Download built assets
        uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds

      - name: Setup database
        run: bundle exec rails db:create db:schema:load

      - name: Run system tests (group 3)
        run: |
          chmod +x bin/split_system_tests.rb
          TESTS=$(./bin/split_system_tests.rb 3)
          [ -n "$TESTS" ] && bundle exec rspec $TESTS --format progress || echo "No tests in group 3"

      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots-system-3
          path: tmp/screenshots
          if-no-files-found: ignore

  # Performance test - separate, only on main
  performance_test:
    needs: [test_models, test_requests, test_services]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bizblasts_test
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY }}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY }}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${{ secrets.ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT }}

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ['5432:5432']
        options: --health-cmd="pg_isready" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Download built assets
        uses: actions/download-artifact@v4
        with:
          name: built-assets
          path: app/assets/builds

      - name: Setup database with seed data
        run: |
          bundle exec rails db:create db:schema:load db:seed
          bundle exec rake ci:create_performance_test_data

      - name: Run performance test
        run: |
          bundle exec rails server -p 3000 &
          sleep 10
          ruby script/performance_test.rb -u "http://consultllc.lvh.me:3000/calendar" -n 100 -c 10
          kill %1 || true

  # ============================================
  # STAGE 4: Deploy (only on main after all tests pass)
  # ============================================
  deploy:
    needs: [scan_ruby, scan_js, lint, test_models, test_requests, test_services, test_integration, test_other, test_system_1, test_system_2, test_system_3]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          curl -X POST https://api.render.com/v1/deploys \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"serviceId": "srv-cvlj0jfgi27c73e3u680"}'
