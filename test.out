4 processes for 25 specs, ~ 6 specs per process
TEST_ENV_NUMBER= PARALLEL_TEST_GROUPS=4 bundle exec rspec --format documentation -O spec/spec.opts spec/controllers/home_controller_spec.rb spec/features/booking_spec.rb spec/features/marketing_spec.rb spec/features/mobile_spec.rb spec/models/tenant_scoped_spec.rb spec/requests/health_spec.rb spec/system/admin/companies_spec.rb spec/system/authentication_spec.rb
TEST_ENV_NUMBER=2 PARALLEL_TEST_GROUPS=4 bundle exec rspec --format documentation -O spec/spec.opts spec/integration/multi_tenant_registration_spec.rb spec/jobs/application_job_spec.rb spec/models/service_provider_spec.rb spec/models/service_spec.rb spec/models/user_spec.rb
TEST_ENV_NUMBER=3 PARALLEL_TEST_GROUPS=4 bundle exec rspec --format documentation -O spec/spec.opts spec/models/business_spec.rb spec/models/tenant_customer_spec.rb spec/requests/admin/dashboard_spec.rb spec/requests/maintenance_spec.rb spec/seeds/seeds_spec.rb
TEST_ENV_NUMBER=4 PARALLEL_TEST_GROUPS=4 bundle exec rspec --format documentation -O spec/spec.opts spec/mailers/application_mailer_spec.rb spec/models/booking_spec.rb spec/models/staff_member_spec.rb spec/requests/admin/companies_spec.rb spec/requests/home_spec.rb spec/requests/multi_tenant_registration_spec.rb spec/services/availability_service_spec.rb
Applying early Sprockets/Propshaft conflict fix...
Sprockets::Manifest successfully patched.

Randomized with seed 21883

StaffMember
  scopes
Applying early Sprockets/Propshaft conflict fix...
Sprockets::Manifest successfully patched.

Randomized with seed 29868

Health Checks
  GET /healthcheck
Applying early Sprockets/Propshaft conflict fix...
Sprockets::Manifest successfully patched.

Randomized with seed 13496

Maintenance
  GET /maintenance
Applying early Sprockets/Propshaft conflict fix...
Sprockets::Manifest successfully patched.

Randomized with seed 63550

Admin Companies
  ActiveAdmin configuration
    .active returns only active staff members
  validations
    returns JSON with status ok
    returns a successful response
  GET /up
    returns a successful response for the Rails health check
  GET /db-check
    returns appropriate error when database connection fails
    returns a successful response when database is connected

Admin Configuration
  has AdminUser model defined
    bypasses tenant setting
  has expected ActiveAdmin resources registered
    returns a service unavailable response
  has ActiveAdmin configured correctly

TenantScoped
  default_scope
    renders the maintenance template
    does not require authentication

Business
  associations
    is expected to validate that :name cannot be empty/falsy
  associations
    is expected to belong to user optional: true
    is expected to have many users
    is expected to have many bookings
    is expected to have many staff_members
    is expected to belong to business required: true

User
  associations
    is expected to have many tenant_customers
    is expected to belong to staff_member optional: true
    is expected to have many bookings
    has Business model
    is expected to belong to business required: true
  scopes
    is expected to have many services
  validations
    is automatically applied to all queries
  scoping behavior
    is expected to validate that :name cannot be empty/falsy
    is expected to validate that :subdomain cannot be empty/falsy
    has AdminUser model
    validates subdomain uniqueness
  subdomain format validation
    has ActiveAdmin configured correctly
  DELETE /admin/businesses/:id
    rejects subdomains with special characters
    .staff_users returns admin, manager, and staff roles
    accepts valid subdomains

Admin Dashboard
  GET /admin
    .active returns only active users
  multi-tenant validations
    displays the admin dashboard
    validates that emails are unique within a business
  role enum
    defines roles
  #full_name
    returns the email
  acts_as_tenant integration
    deletes a business
  authentication
    has a link to tenant debug information
    scopes queries to the current tenant
  #staff?
    returns true for admin roles
    returns false for client roles
    returns true for staff roles
  validations
    redirects non-authenticated users to login
    allows duplicate emails across different businesses
    shows system metrics

Database seeds
  when running seeds
--- Loading seeds for seeds_spec suite ---
Seeding database with sample data...
Creating default tenant...
    allows authenticated admin users to access
  POST /admin/businesses
    validates uniqueness of email scoped to business_id
Default tenant created: Default Business (default) ID: 22
Creating admin user...
    scopes queries to the current tenant (FAILED - 1)
    is expected to validate that :email cannot be empty/falsy

MultiTenant Email Uniqueness

Failures:

  1) TenantScoped scoping behavior scopes queries to the current tenant
     Failure/Error: instance.save(validate: false)

     ActiveRecord::QueryCanceled:
       PG::QueryCanceled: ERROR:  canceling statement due to statement timeout
       CONTEXT:  while inserting index tuple (0,8) in relation "index_businesses_on_subdomain"
     # ./spec/factories/businesses.rb:15:in 'block (3 levels) in <main>'
     # ./spec/models/tenant_scoped_spec.rb:7:in 'block (2 levels) in <top (required)>'
     # ./spec/models/tenant_scoped_spec.rb:9:in 'block (2 levels) in <top (required)>'
     # ------------------
     # --- Caused by: ---
     # PG::QueryCanceled:
     #   ERROR:  canceling statement due to statement timeout
     #   CONTEXT:  while inserting index tuple (0,8) in relation "index_businesses_on_subdomain"
     #   ./spec/factories/businesses.rb:15:in 'block (3 levels) in <main>'

Finished in 20.22 seconds (files took 6.08 seconds to load)
10 examples, 1 failure

Failed examples:

rspec ./spec/models/tenant_scoped_spec.rb:18 # TenantScoped scoping behavior scopes queries to the current tenant

Randomized with seed 29868

Coverage report generated for (1/3), (1/4), (2/3), (2/4), (3/3), (3/4), (4/4), RSpec to /Users/brianlane/bizblasts/coverage.
Line Coverage: 20.78% (542 / 2608)
Admin user created with email: admin@example.com and password: password123
Creating sample data for Default Business...
Created customer: Mary Bayer
Created customer: Lincoln Pouros III
Created customer: Daren Langworth
  allows the same email to be used across different tenants when properly configured

ApplicationJob
  inheritance
    inherits from ActiveJob::Base

Service
  scopes
    creates a new business
  GET /admin/businesses
Created service: Basic Consultation
Created service: Website Setup
Created service: Monthly Support
    .active returns only active services
  validations
Created staff member: Staff Member 1
    lists all businesses

StaffMember
  associations
Created staff member: Staff Member 2
    allows duplicate names across different businesses
    is expected to belong to user optional: true
    is expected to have many bookings
Created booking at 2025-04-14 09:00 - 11:00 for Staff Member 1
    is expected to belong to business required: true
  validations
    validates uniqueness of name scoped to business_id
Created booking at 2025-04-15 12:00 - 14:00 for Staff Member 1
Created booking at 2025-04-14 15:00 - 16:00 for Staff Member 1
    is expected to validate that :name cannot be empty/falsy
  scopes
    is expected to validate that :name cannot be empty/falsy
Created booking at 2025-04-09 09:00 - 10:00 for Staff Member 2
Created booking at 2025-04-10 12:00 - 14:00 for Staff Member 2
    is expected to validate that :duration cannot be empty/falsy
Created booking at 2025-04-09 15:00 - 15:30 for Staff Member 2
Seed data creation complete!
Admin user bizblaststeam@gmail.com already exists.
    data integrity
    is expected to validate that :price cannot be empty/falsy
  associations
    .active returns only active staff members

ApplicationMailer
  uses the correct default from address
  uses the correct layout

Home
  GET /
    is expected to belong to business required: true
    is expected to have many bookings
    is expected to have and belong to many staff_members

Finished in 29.31 seconds (files took 6.1 seconds to load)
30 examples, 0 failures

Randomized with seed 21883

    renders the correct content for index
Coverage report generated for (1/3), (1/4), (2/3), (2/4), (3/3), (3/4), (4/4), RSpec to /Users/brianlane/bizblasts/coverage.
Line Coverage: 20.78% (542 / 2608)
    does not require authentication
      maintains proper associations between records
    sample data
    returns a successful response
  GET /admin/debug
    when not authenticated as admin
      creates sample customers for each business
      redirects to the admin login page
  GET /home/debug (now moved to /admin/debug)
    redirects to the admin debug page

MultiTenant Registration
  users with identical emails in different tenants
      creates sample services for each business
      creates staff members for each business
      creates bookings for each business
    data validity
    allows registration and authentication with the same email in different businesses

Booking
  validations
      creates valid customer records
      creates valid booking records
    is expected to validate that :status cannot be empty/falsy
      creates valid service records
    default tenant
      creates the default business
      creates an admin user for the default business
--- Cleaning database after seeds_spec suite ---
    is expected to validate that :start_time cannot be empty/falsy

TenantCustomer
  associations
    is expected to have many bookings
    is expected to belong to business required: true
  validations
    validates presence of name
    is expected to validate that :end_time cannot be empty/falsy
    is invalid if end_time is before start_time
    is valid if end_time is after start_time
  associations
    is expected to belong to service required: true
    is expected to belong to tenant_customer required: true
    allows duplicate emails across different businesses
    is expected to belong to staff_member required: true
    is expected to belong to business required: true

Finished in 39.32 seconds (files took 6.18 seconds to load)
30 examples, 0 failures

Randomized with seed 63550

    validates uniqueness of email scoped to business_id

Finished in 40.65 seconds (files took 6.09 seconds to load)
32 examples, 0 failures

Randomized with seed 13496

Coverage report generated for (1/3), (1/4), (2/3), (2/4), (3/3), (3/4), (4/4), RSpec to /Users/brianlane/bizblasts/coverage.
Line Coverage: 20.9% (545 / 2608)
Coverage report generated for (1/3), (1/4), (2/3), (2/4), (3/3), (3/4), (4/4), RSpec to /Users/brianlane/bizblasts/coverage.
Line Coverage: 21.17% (552 / 2608)

102 examples, 1 failure


Tests have failed for a parallel_test group. Use the following command to run the group again:

TEST_ENV_NUMBER= PARALLEL_TEST_GROUPS=4 bundle exec rspec --format documentation -O spec/spec.opts spec/controllers/home_controller_spec.rb spec/features/booking_spec.rb spec/features/marketing_spec.rb spec/features/mobile_spec.rb spec/models/tenant_scoped_spec.rb spec/requests/health_spec.rb spec/system/admin/companies_spec.rb spec/system/authentication_spec.rb --seed 29868

Took 49 seconds
