<% @business = current_tenant %>
<div class="bg-slate-50 py-12">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid gap-8 lg:grid-cols-3">
      <div class="lg:col-span-2">
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
          <p class="text-sm font-semibold text-blue-600 uppercase tracking-wide">Custom rentals & services</p>
          <h1 class="mt-2 text-3xl sm:text-4xl font-bold text-gray-900">Request a tailored estimate</h1>
          <p class="mt-3 text-gray-600">Tell us about your project, upcoming event, or rental needs. We’ll confirm availability, pricing, and next steps within one business day.</p>

          <%= form_with url: tenant_estimate_request_path, method: :post, local: true, class: "mt-8 space-y-6" do |f| %>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <%= f.label :first_name, 'First Name', class: 'block text-sm font-medium text-gray-700' %>
                <%= f.text_field :first_name, class: 'mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2' %>
              </div>
              <div>
                <%= f.label :last_name, 'Last Name', class: 'block text-sm font-medium text-gray-700' %>
                <%= f.text_field :last_name, class: 'mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2' %>
              </div>
              <div class="sm:col-span-2">
                <%= f.label :email, 'Email Address', class: 'block text-sm font-medium text-gray-700' %>
                <%= f.email_field :email,
                      pattern: "[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$",
                      title: "Please enter a valid email address",
                      class: 'mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2' %>
              </div>
              <div class="sm:col-span-2">
                <%= f.label :phone, 'Phone', class: 'block text-sm font-medium text-gray-700' %>
                <%= f.telephone_field :phone,
                      pattern: "^(\+1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})$",
                      title: "Please enter a valid US phone number (e.g., (555) 123-4567)",
                      placeholder: "(555) 123-4567",
                      class: 'mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2' %>
              </div>
              <div class="sm:col-span-2">
                <%= f.label :address, 'Street Address', class: 'block text-sm font-medium text-gray-700' %>
                <%= f.text_field :address, class: 'mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2' %>
              </div>
              <div>
                <%= f.label :city, 'City', class: 'block text-sm font-medium text-gray-700' %>
                <%= f.text_field :city, class: 'mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2' %>
              </div>
              <div>
                <%= f.label :zip, 'Zip Code', class: 'block text-sm font-medium text-gray-700' %>
                <%= f.text_field :zip,
                      pattern: "[0-9]{5}(-[0-9]{4})?",
                      title: "Please enter a valid ZIP code (e.g., 12345 or 12345-6789)",
                      maxlength: "10",
                      class: 'mt-1 block w-full rounded-xl border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2' %>
              </div>
            </div>

            <div>
              <%= f.label :service_needs, 'Describe what you need', class: 'block text-sm font-medium text-gray-700' %>
              <%= f.text_area :service_needs,
                    rows: 5,
                    placeholder: "Tell us about timing, quantity, preferred dates, or any special considerations...",
                    class: 'mt-1 block w-full rounded-2xl border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-3' %>
            </div>

            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <p class="text-sm text-gray-500">We usually respond within one business day. Need something sooner? Call us and mention this form.</p>
              <%= f.submit 'Request Estimate', class: 'inline-flex items-center justify-center px-5 py-3 rounded-2xl bg-blue-600 text-white font-semibold shadow hover:bg-blue-700 transition-colors cursor-pointer' %>
            </div>
          <% end %>
        </div>
      </div>

      <div class="space-y-6">
        <div class="bg-white rounded-2xl shadow p-6">
          <h2 class="text-lg font-semibold text-gray-900">What happens next</h2>
          <ol class="mt-4 space-y-4 text-sm text-gray-600">
            <li class="flex gap-3">
              <span class="flex h-8 w-8 items-center justify-center rounded-full bg-blue-100 text-blue-700 font-semibold">1</span>
              <div>
                <p class="font-medium text-gray-900">We review your request</p>
                <p>Our team confirms availability, timelines, and the best options for your project.</p>
              </div>
            </li>
            <li class="flex gap-3">
              <span class="flex h-8 w-8 items-center justify-center rounded-full bg-blue-100 text-blue-700 font-semibold">2</span>
              <div>
                <p class="font-medium text-gray-900">We send a customized estimate</p>
                <p>Expect transparent pricing with any required deposits clearly noted.</p>
              </div>
            </li>
            <li class="flex gap-3">
              <span class="flex h-8 w-8 items-center justify-center rounded-full bg-blue-100 text-blue-700 font-semibold">3</span>
              <div>
                <p class="font-medium text-gray-900">Approve & lock in your booking</p>
                <p>Approve online, pay the deposit, and we’ll handle the rest.</p>
              </div>
            </li>
          </ol>
        </div>

        <div class="rounded-2xl bg-gradient-to-br from-blue-600 via-blue-700 to-indigo-800 text-white p-6 shadow-lg">
          <h3 class="text-lg font-semibold">Need to chat first?</h3>
          <p class="mt-2 text-sm text-blue-100">Call or email and we’ll guide you through the best rental or service plan.</p>
          <% if @business.phone.present? %>
            <div class="mt-4 flex items-center text-white">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.82 21 3 14.18 3 5V5z" /></svg>
              <span class="font-semibold"><%= @business.phone %></span>
            </div>
          <% end %>
          <% if @business.email.present? %>
            <div class="mt-2 flex items-center text-white">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12l-4-4-4 4m8 0l-4 4-4-4m4-4v8" /></svg>
              <span><%= @business.email %></span>
            </div>
          <% end %>
          <% if @business.address.present? %>
            <div class="mt-2 text-sm text-blue-100">
              <p><%= [@business.address, @business.city, @business.state, @business.zip].compact.join(', ') %></p>
            </div>
          <% end %>
        </div>

        <div class="bg-white rounded-2xl shadow p-6">
          <h3 class="text-lg font-semibold text-gray-900">Why clients choose us</h3>
          <ul class="mt-4 space-y-3 text-sm text-gray-600">
            <li class="flex items-start gap-2">
              <svg class="w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              Transparent pricing & clear deposit requirements
            </li>
            <li class="flex items-start gap-2">
              <svg class="w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              Flexible scheduling with reminders before pickup/return
            </li>
            <li class="flex items-start gap-2">
              <svg class="w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              Friendly support team that actually answers the phone
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  // Enhanced form validation functions
  function validateField(input, isValid, errorMessage) {
    const existingError = input.parentElement.querySelector('.field-error');
    if (existingError) {
      existingError.remove();
    }

    if (!isValid) {
      input.classList.add('border-red-500', 'ring-red-500');
      input.classList.remove('border-gray-300');
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'field-error text-red-500 text-xs mt-1';
      errorDiv.textContent = errorMessage;
      input.parentElement.appendChild(errorDiv);
    } else {
      input.classList.remove('border-red-500', 'ring-red-500');
      input.classList.add('border-gray-300');
    }
  }

  function validateEmail(email) {
    const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;
    return emailRegex.test(email);
  }

  function validatePhone(phone) {
    const phoneRegex = /^(\+1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})$/;
    return phoneRegex.test(phone);
  }

  function validateZip(zip) {
    const zipRegex = /^[0-9]{5}(-[0-9]{4})?$/;
    return zipRegex.test(zip);
  }

  // Add real-time validation listeners
  function initializeEstimateForm() {
    // Email validation
    const emailFields = document.querySelectorAll('input[type="email"]');
    emailFields.forEach(field => {
      field.addEventListener('blur', function() {
        if (this.value) {
          const isValid = validateEmail(this.value);
          validateField(this, isValid, 'Please enter a valid email address');
        }
      });
    });

    // Phone validation
    const phoneFields = document.querySelectorAll('input[type="tel"]');
    phoneFields.forEach(field => {
      field.addEventListener('blur', function() {
        if (this.value) {
          const isValid = validatePhone(this.value);
          validateField(this, isValid, 'Please enter a valid US phone number (e.g., (555) 123-4567)');
        }
      });
    });

    // ZIP code validation
    const zipFields = document.querySelectorAll('input[name*="zip"]');
    zipFields.forEach(field => {
      field.addEventListener('blur', function() {
        if (this.value) {
          const isValid = validateZip(this.value);
          validateField(this, isValid, 'Please enter a valid ZIP code (5 digits or 5+4 format)');
        }
      });
    });

    // Phone number formatting
    phoneFields.forEach(field => {
      field.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, ''); // Remove non-digits
        if (value.length >= 6) {
          value = value.replace(/(\d{3})(\d{3})(\d+)/, '($1) $2-$3');
        } else if (value.length >= 3) {
          value = value.replace(/(\d{3})(\d+)/, '($1) $2');
        }
        this.value = value;
      });
    });

    // ZIP code formatting
    zipFields.forEach(field => {
      field.addEventListener('input', function() {
        // Remove all non-digits and hyphens, then remove any hyphens that aren't in the right place
        let value = this.value.replace(/[^0-9-]/g, '').replace(/-+/g, '-');
        
        // Remove hyphens that aren't after exactly 5 digits
        value = value.replace(/^(\d{1,4})-/, '$1').replace(/(\d{5})-+(\d)/, '$1-$2');
        
        // If we have more than 5 digits without a hyphen, add one
        if (value.length > 5 && !value.includes('-')) {
          value = value.replace(/(\d{5})(\d+)/, '$1-$2');
        }
        
        // Limit to 10 characters max (12345-6789)
        if (value.length > 10) {
          value = value.substring(0, 10);
        }
        
        this.value = value;
      });
    });
  }

  // Initialize on both DOMContentLoaded and turbo:load for Turbo compatibility
  document.addEventListener('DOMContentLoaded', initializeEstimateForm);
  document.addEventListener('turbo:load', initializeEstimateForm);
</script> 