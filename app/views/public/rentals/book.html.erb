<%# app/views/public/rentals/book.html.erb %>
<div class="min-h-screen bg-gray-50">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <nav class="mb-6 text-sm">
      <%= link_to 'Rentals', rentals_path, class: "text-blue-600 hover:text-blue-800" %>
      <span class="mx-2 text-gray-500">/</span>
      <%= link_to @rental.name, rental_path(@rental), class: "text-blue-600 hover:text-blue-800" %>
      <span class="mx-2 text-gray-500">/</span>
      <span class="text-gray-700">Confirm Slot</span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 bg-white rounded-lg shadow p-6">
        <h1 class="text-2xl font-bold text-gray-900 mb-4">Reserve <%= @rental.name %></h1>

        <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
          <div class="flex items-center justify-between flex-wrap gap-2">
            <div>
              <p class="text-sm text-blue-600">Pickup</p>
              <p class="text-lg font-semibold text-blue-900"><%= @start_time.strftime("%A, %B %-d @ %l:%M %p") %></p>
            </div>
            <div>
              <p class="text-sm text-blue-600">Duration</p>
              <%
                duration_label = case @duration_minutes
                when 0..119 then "#{@duration_minutes / 60} hour#{'s' if @duration_minutes > 60}"
                when 120..1439 then "#{@duration_minutes / 60} hours"
                when 1440 then "1 day"
                when 2880 then "2 days"
                when 4320 then "3 days"
                when 10080 then "7 days"
                when 20160 then "14 days"
                when 40320 then "28 days"
                else
                  days = @duration_minutes / 1440
                  days == 1 ? "1 day" : "#{days} days"
                end
              %>
              <p class="text-lg font-semibold text-blue-900"><%= duration_label %></p>
            </div>
            <div>
              <p class="text-sm text-blue-600">Return</p>
              <p class="text-lg font-semibold text-blue-900"><%= @end_time.strftime("%A, %B %-d @ %l:%M %p") %></p>
            </div>
          </div>
          <div class="mt-4">
            <%= link_to 'Change Time Slot', calendar_rental_path(@rental, duration: @duration_minutes, quantity: @quantity),
                  class: "text-sm text-blue-700 hover:text-blue-900 font-medium" %>
          </div>
        </div>

        <%= form_with url: create_booking_rental_path(@rental), method: :post, local: true, class: "space-y-6" do %>
          <%= hidden_field_tag 'rental_booking[start_time]', @start_time.iso8601 %>
          <%= hidden_field_tag 'rental_booking[duration_mins]', @duration_minutes %>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
            <% selected_quantity = @quantity || 1 %>
            <div class="relative" data-controller="dropdown"
                 data-dropdown-selected-value-value="<%= selected_quantity %>"
                 data-dropdown-selected-text-value="<%= selected_quantity %>">
              <button type="button"
                      class="w-full bg-white border border-gray-300 rounded-md shadow-sm px-3 py-2 text-left cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      data-dropdown-target="button"
                      data-action="click->dropdown#toggle">
                <span class="rich-dropdown-text text-gray-900">
                  <%= selected_quantity %>
                </span>
                <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                  <svg class="h-5 w-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </span>
              </button>
              <%= hidden_field_tag 'rental_booking[quantity]', selected_quantity, data: { dropdown_target: 'hidden' } %>
              <div class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 ring-1 ring-black ring-opacity-5 overflow-auto hidden"
                   data-dropdown-target="menu">
                <% (1..@rental.rental_quantity_available).each do |qty| %>
                  <div class="cursor-pointer select-none relative py-2 px-3 hover:bg-blue-50 transition-colors"
                       data-item-id="<%= qty %>"
                       data-item-text="<%= qty %>"
                       data-dropdown-target="option"
                       data-action="click->dropdown#select">
                    <%= qty %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>

          <div>
            <h2 class="text-lg font-medium text-gray-900 mb-4">Your Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <%= label_tag 'customer[first_name]', "First Name *", class: "block text-sm font-medium text-gray-700" %>
                <%= text_field_tag 'customer[first_name]', nil, required: true,
                      class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
              </div>
              <div>
                <%= label_tag 'customer[last_name]', "Last Name *", class: "block text-sm font-medium text-gray-700" %>
                <%= text_field_tag 'customer[last_name]', nil, required: true,
                      class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
              </div>
              <div>
                <%= label_tag 'customer[email]', "Email *", class: "block text-sm font-medium text-gray-700" %>
                <%= email_field_tag 'customer[email]', nil, required: true,
                      class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
              </div>
              <div>
                <%= label_tag 'customer[phone]', "Phone *", class: "block text-sm font-medium text-gray-700" %>
                <%= telephone_field_tag 'customer[phone]', nil, required: true,
                      class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
              </div>
            </div>
          </div>

          <div>
            <%= label_tag 'rental_booking[customer_notes]', "Notes (optional)", class: "block text-sm font-medium text-gray-700" %>
            <%= text_area_tag 'rental_booking[customer_notes]', nil, rows: 3,
                  class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
          </div>

          <div class="pt-4">
            <%= submit_tag 'Confirm & Continue',
                  class: "w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors cursor-pointer" %>
          </div>
        <% end %>
      </div>

      <div class="bg-white rounded-lg shadow p-6 space-y-6">
        <div>
          <h3 class="text-lg font-medium text-gray-900">Pricing Summary</h3>
          <div class="mt-4 space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">Duration</span>
              <%
                pricing_duration_label = case @duration_minutes
                when 0..119 then "#{@duration_minutes / 60} hour#{'s' if @duration_minutes > 60}"
                when 120..1439 then "#{@duration_minutes / 60} hours"
                when 1440 then "1 day"
                when 2880 then "2 days"
                when 4320 then "3 days"
                when 10080 then "7 days"
                when 20160 then "14 days"
                when 40320 then "28 days"
                else
                  days = @duration_minutes / 1440
                  days == 1 ? "1 day" : "#{days} days"
                end
              %>
              <span class="font-medium text-gray-900"><%= pricing_duration_label %></span>
            </div>
            <% if @pricing.present? %>
              <div class="flex justify-between">
                <span class="text-gray-600 capitalize"><%= @pricing[:rate_type] %> total</span>
                <span class="font-medium text-gray-900"><%= number_to_currency(@pricing[:total]) %></span>
              </div>
            <% end %>
          </div>
        </div>

        <% if @rental.security_deposit.to_d > 0 %>
          <div class="p-4 bg-orange-50 border border-orange-100 rounded-lg text-sm">
            <div class="flex justify-between text-orange-700">
              <span>Security Deposit</span>
              <span class="font-semibold"><%= number_to_currency(@rental.security_deposit) %></span>
            </div>
            <p class="mt-1 text-orange-600">Refunded upon safe return. Collected before pickup.</p>
          </div>
        <% end %>

        <div class="text-sm text-gray-600 border-t pt-4">
          <p>Need to make changes? You can adjust the time slot before completing payment.</p>
        </div>
      </div>
    </div>
  </div>
</div>
