<%# app/views/public/rentals/book.html.erb %>
<div class="min-h-screen bg-gray-50">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm">
      <%= link_to 'Rentals', rentals_path, class: "text-blue-600 hover:text-blue-800" %>
      <span class="mx-2 text-gray-500">/</span>
      <%= link_to @rental.name, rental_path(@rental), class: "text-blue-600 hover:text-blue-800" %>
      <span class="mx-2 text-gray-500">/</span>
      <span class="text-gray-700">Book</span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Booking Form -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow p-6">
          <h1 class="text-2xl font-bold text-gray-900 mb-6">Book <%= @rental.name %></h1>

          <%= form_with url: create_booking_rental_path(@rental), method: :post, local: true, class: "space-y-6" do |form| %>
            <!-- Rental Period -->
            <div>
              <h2 class="text-lg font-medium text-gray-900 mb-4">Rental Period</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <%= label_tag 'rental_booking[start_time]', "Pickup Date & Time", class: "block text-sm font-medium text-gray-700" %>
                  <%= datetime_local_field_tag 'rental_booking[start_time]', params[:start_time], 
                        min: Time.current.strftime('%Y-%m-%dT%H:%M'),
                        class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
                </div>
                <div>
                  <%= label_tag 'rental_booking[end_time]', "Return Date & Time", class: "block text-sm font-medium text-gray-700" %>
                  <%= datetime_local_field_tag 'rental_booking[end_time]', params[:end_time],
                        class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
                </div>
              </div>
              
              <% if @rental.rental_duration_display.present? %>
                <p class="mt-2 text-sm text-gray-500"><%= @rental.rental_duration_display %></p>
              <% end %>
            </div>

            <!-- Quantity -->
            <div>
              <div class="flex justify-between">
                <%= label_tag 'rental_booking[quantity]', "Quantity", class: "block text-sm font-medium text-gray-700" %>
                <span class="text-sm text-gray-500"><%= @rental.rental_quantity_available %> available</span>
              </div>
              <%= number_field_tag 'rental_booking[quantity]', params[:quantity] || 1, 
                    min: 1, 
                    max: @rental.rental_quantity_available,
                    class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
            </div>

            <!-- Rate Type -->
            <div>
              <%= label_tag 'rental_booking[rate_type]', "Rate Type", class: "block text-sm font-medium text-gray-700" %>
              <%= select_tag 'rental_booking[rate_type]', 
                    options_for_select([
                      ['Auto-select best rate', ''],
                      @rental.allow_hourly_rental? && @rental.hourly_rate.present? ? ["Hourly (#{number_to_currency(@rental.hourly_rate)}/hr)", 'hourly'] : nil,
                      @rental.allow_daily_rental? ? ["Daily (#{number_to_currency(@rental.daily_rate)}/day)", 'daily'] : nil,
                      @rental.allow_weekly_rental? && @rental.weekly_rate.present? ? ["Weekly (#{number_to_currency(@rental.weekly_rate)}/wk)", 'weekly'] : nil
                    ].compact, params[:rate_type]),
                    class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
            </div>

            <!-- Customer Information -->
            <% unless user_signed_in? %>
              <div class="border-t pt-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Your Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <%= label_tag 'customer[first_name]', "First Name *", class: "block text-sm font-medium text-gray-700" %>
                    <%= text_field_tag 'customer[first_name]', nil, required: true,
                          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
                  </div>
                  <div>
                    <%= label_tag 'customer[last_name]', "Last Name *", class: "block text-sm font-medium text-gray-700" %>
                    <%= text_field_tag 'customer[last_name]', nil, required: true,
                          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
                  </div>
                  <div>
                    <%= label_tag 'customer[email]', "Email *", class: "block text-sm font-medium text-gray-700" %>
                    <%= email_field_tag 'customer[email]', nil, required: true,
                          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
                  </div>
                  <div>
                    <%= label_tag 'customer[phone]', "Phone *", class: "block text-sm font-medium text-gray-700" %>
                    <%= telephone_field_tag 'customer[phone]', nil, required: true,
                          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
                  </div>
                </div>
              </div>
            <% end %>

            <!-- Notes -->
            <div>
              <%= label_tag 'rental_booking[customer_notes]', "Special Requests or Notes", class: "block text-sm font-medium text-gray-700" %>
              <%= text_area_tag 'rental_booking[customer_notes]', nil, rows: 3,
                    class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
                    placeholder: "Any special requirements or notes..." %>
            </div>

            <!-- Submit -->
            <div class="pt-4">
              <%= submit_tag 'Continue to Payment', 
                    class: "w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors cursor-pointer" %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow p-6 sticky top-4">
          <h2 class="text-lg font-medium text-gray-900 mb-4">Summary</h2>
          
          <div class="flex items-start gap-4 pb-4 border-b">
            <% if @rental.images.attached? %>
              <%= image_tag @rental.images.first.variant(:thumb), class: "w-20 h-20 object-cover rounded" %>
            <% end %>
            <div>
              <h3 class="font-medium text-gray-900"><%= @rental.name %></h3>
              <p class="text-sm text-gray-500"><%= @rental.rental_category&.titleize %></p>
            </div>
          </div>
          
          <div class="mt-4 space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">Daily Rate</span>
              <span><%= number_to_currency(@rental.daily_rate) %></span>
            </div>
            <% if @rental.hourly_rate.present? %>
              <div class="flex justify-between">
                <span class="text-gray-600">Hourly Rate</span>
                <span><%= number_to_currency(@rental.hourly_rate) %></span>
              </div>
            <% end %>
            <% if @rental.weekly_rate.present? %>
              <div class="flex justify-between">
                <span class="text-gray-600">Weekly Rate</span>
                <span><%= number_to_currency(@rental.weekly_rate) %></span>
              </div>
            <% end %>
          </div>
          
          <% if @rental.security_deposit.to_d > 0 %>
            <div class="mt-4 pt-4 border-t">
              <div class="flex justify-between text-orange-600">
                <span class="font-medium">Security Deposit</span>
                <span class="font-bold"><%= number_to_currency(@rental.security_deposit) %></span>
              </div>
              <p class="text-xs text-gray-500 mt-1">
                Collected before pickup, refundable upon return in good condition
              </p>
            </div>
          <% end %>
          
          <% if @pricing %>
            <div class="mt-4 pt-4 border-t">
              <div class="flex justify-between">
                <span class="text-gray-600"><%= @pricing[:rate_type].titleize %> Ã— <%= @pricing[:quantity] %></span>
                <span><%= number_to_currency(@pricing[:total]) %></span>
              </div>
              <div class="flex justify-between font-semibold text-lg mt-2">
                <span>Estimated Total</span>
                <span class="text-green-600"><%= number_to_currency(@pricing[:total]) %></span>
              </div>
            </div>
          <% end %>
          
          <div class="mt-6 p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
            <p class="font-medium">What happens next?</p>
            <ol class="mt-2 list-decimal list-inside space-y-1 text-xs">
              <li>Pay security deposit to confirm booking</li>
              <li>Pick up item at scheduled time</li>
              <li>Return item by end date</li>
              <li>Deposit refunded after inspection</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

