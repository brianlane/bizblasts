<%# app/views/public/rentals/show.html.erb %>
<div class="min-h-screen bg-gray-50">
  <div class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm">
      <%= link_to 'Rentals', rentals_path, class: "text-blue-600 hover:text-blue-800" %>
      <span class="mx-2 text-gray-500">/</span>
      <span class="text-gray-700"><%= @rental.name %></span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Images -->
      <div>
        <% if @rental.images.attached? %>
          <div class="bg-white rounded-lg shadow overflow-hidden">
            <%= image_tag @rental.images.first.variant(:large), 
                  class: "w-full h-auto object-cover", id: "main-image" %>
          </div>
          <% if @rental.images.count > 1 %>
            <div class="mt-4 grid grid-cols-4 gap-2">
              <% @rental.images.each_with_index do |image, index| %>
                <%= image_tag image.variant(:thumb), 
                      class: "w-full h-20 object-cover rounded cursor-pointer hover:ring-2 hover:ring-blue-500 #{index == 0 ? 'ring-2 ring-blue-500' : ''}" %>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <div class="bg-gray-200 rounded-lg h-96 flex items-center justify-center">
            <svg class="w-24 h-24 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
          </div>
        <% end %>
      </div>

      <!-- Details -->
      <div>
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-start justify-between">
            <div>
              <h1 class="text-3xl font-bold text-gray-900"><%= @rental.name %></h1>
              <div class="mt-2 flex flex-wrap gap-2">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  <%= @rental.rental_category&.titleize %>
                </span>
                <% if @rental.location.present? %>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    üìç <%= @rental.location.name %>
                  </span>
                <% end %>
              </div>
            </div>
            <div class="text-right">
              <div class="text-3xl font-bold text-green-600">
                <%= number_to_currency(@rental.daily_rate) %>
              </div>
              <div class="text-sm text-gray-500">per day</div>
            </div>
          </div>

          <div class="mt-6 prose prose-sm text-gray-600">
            <p><%= @rental.description %></p>
          </div>

          <!-- Pricing Options -->
          <div class="mt-6 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-medium text-gray-900 mb-3">Pricing Options</h3>
            <div class="space-y-2">
              <% if @rental.allow_hourly_rental? && @rental.hourly_rate.present? %>
                <div class="flex justify-between">
                  <span class="text-gray-600">Hourly</span>
                  <span class="font-medium"><%= number_to_currency(@rental.hourly_rate) %>/hour</span>
                </div>
              <% end %>
              <% if @rental.allow_daily_rental? %>
                <div class="flex justify-between">
                  <span class="text-gray-600">Daily</span>
                  <span class="font-medium"><%= number_to_currency(@rental.daily_rate) %>/day</span>
                </div>
              <% end %>
              <% if @rental.allow_weekly_rental? && @rental.weekly_rate.present? %>
                <div class="flex justify-between">
                  <span class="text-gray-600">Weekly</span>
                  <span class="font-medium"><%= number_to_currency(@rental.weekly_rate) %>/week</span>
                </div>
              <% end %>
            </div>
            
            <% if @rental.security_deposit.to_d > 0 %>
              <div class="mt-3 pt-3 border-t border-gray-200">
                <div class="flex justify-between text-orange-600">
                  <span>Security Deposit</span>
                  <span class="font-medium"><%= number_to_currency(@rental.security_deposit) %></span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Refundable upon return in good condition</p>
              </div>
            <% end %>
          </div>

          <!-- Availability Info -->
          <div class="mt-6 p-4 bg-blue-50 rounded-lg">
            <div class="flex items-center justify-between">
              <span class="text-blue-700 font-medium">Available Units</span>
              <span class="text-2xl font-bold text-blue-600"><%= @rental.rental_quantity_available %></span>
            </div>
            <% if @rental.rental_duration_display.present? %>
              <p class="text-sm text-blue-600 mt-2"><%= @rental.rental_duration_display %></p>
            <% end %>
          </div>

          <!-- Duration Selector + CTA -->
          <div class="mt-6">
            <% selected_duration = params[:duration].presence&.to_i || @duration_options.first %>
            <%
              selected_duration_label = case selected_duration
              when 0..119 then "#{selected_duration / 60} hour#{'s' if selected_duration > 60}"
              when 120..1439 then "#{selected_duration / 60} hours"
              when 1440 then "1 day"
              when 2880 then "2 days"
              when 4320 then "3 days"
              when 10080 then "7 days"
              when 20160 then "14 days"
              when 40320 then "28 days"
              else
                days = selected_duration / 1440
                days == 1 ? "1 day" : "#{days} days"
              end
              selected_pricing = @rental.calculate_rental_price(Time.current, Time.current + selected_duration.minutes)
              selected_price_text = selected_pricing ? number_to_currency(selected_pricing[:total]) : ''
              selected_label_with_price = "#{selected_duration_label} #{selected_price_text.present? ? "(#{selected_price_text})" : ''}"
            %>
            <%= form_with url: calendar_rental_path(@rental), method: :get, local: true, class: "space-y-4", id: "duration-form" do %>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Choose Rental Duration</label>
                <div class="relative" data-controller="dropdown"
                     data-dropdown-selected-value-value="<%= selected_duration %>"
                     data-dropdown-selected-text-value="<%= selected_label_with_price %>">
                  <button type="button"
                          class="w-full bg-white border border-gray-300 rounded-md shadow-sm px-3 py-3 text-left cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          data-dropdown-target="button"
                          data-action="click->dropdown#toggle">
                    <span class="rich-dropdown-text text-gray-900">
                      <%= selected_label_with_price %>
                    </span>
                    <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                      <svg class="h-5 w-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </span>
                  </button>
                  <%= hidden_field_tag :duration, selected_duration, data: { dropdown_target: 'hidden' } %>
                  <div class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 ring-1 ring-black ring-opacity-5 overflow-auto hidden"
                       data-dropdown-target="menu">
                    <% @duration_options.each do |duration_mins| %>
                      <%
                        duration_label = case duration_mins
                        when 0..119 then "#{duration_mins / 60} hour#{'s' if duration_mins > 60}"
                        when 120..1439 then "#{duration_mins / 60} hours"
                        when 1440 then "1 day"
                        when 2880 then "2 days"
                        when 4320 then "3 days"
                        when 10080 then "7 days"
                        when 20160 then "14 days"
                        when 40320 then "28 days"
                        else
                          days = duration_mins / 1440
                          days == 1 ? "1 day" : "#{days} days"
                        end
                        pricing = @rental.calculate_rental_price(Time.current, Time.current + duration_mins.minutes)
                        price_text = pricing ? number_to_currency(pricing[:total]) : ''
                        label_with_price = "#{duration_label} #{price_text.present? ? "(#{price_text})" : ''}"
                      %>
                      <div class="cursor-pointer select-none relative py-2 px-3 hover:bg-blue-50 transition-colors"
                           data-item-id="<%= duration_mins %>"
                           data-item-text="<%= label_with_price %>"
                           data-dropdown-target="option"
                           data-action="click->dropdown#select">
                        <%= label_with_price %>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
              <div>
                <%= hidden_field_tag :quantity, 1 %>
                <%= submit_tag 'View Calendar', class: "w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors cursor-pointer" %>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Availability Calendar Preview -->
        <div class="mt-6 bg-white rounded-lg shadow p-6">
          <h3 class="font-medium text-gray-900 mb-4">Availability (Next 30 Days)</h3>
          <div class="grid grid-cols-7 gap-1 text-xs">
            <% %w[S M T W T F S].each do |day| %>
              <div class="text-center font-medium text-gray-500 p-1"><%= day %></div>
            <% end %>
            <% @availability_calendar.each do |date_str, data| %>
              <% date = Date.parse(date_str) %>
              <div class="text-center p-1.5 rounded <%= data[:fully_booked] ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800' %>" 
                   title="<%= date.strftime('%b %d') %>: <%= data[:available] %>/<%= data[:total] %> available">
                <%= date.day %>
              </div>
            <% end %>
          </div>
          <div class="mt-3 flex items-center justify-center gap-4 text-xs text-gray-500">
            <div class="flex items-center gap-1">
              <div class="w-3 h-3 bg-green-100 rounded"></div>
              <span>Available</span>
            </div>
            <div class="flex items-center gap-1">
              <div class="w-3 h-3 bg-red-100 rounded"></div>
              <span>Fully Booked</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Similar Rentals -->
    <% if @similar_rentals.any? %>
      <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Similar Rentals</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <% @similar_rentals.each do |rental| %>
            <div class="bg-white rounded-lg shadow overflow-hidden hover:shadow-md transition-shadow">
              <% if rental.images.attached? %>
                <%= image_tag rental.images.first.variant(:thumb), class: "w-full h-32 object-cover" %>
              <% else %>
                <div class="w-full h-32 bg-gray-200 flex items-center justify-center">
                  <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                </div>
              <% end %>
              <div class="p-3">
                <%= link_to rental.name, rental_path(rental), class: "font-medium text-gray-900 hover:text-blue-600" %>
                <div class="text-green-600 font-medium mt-1"><%= number_to_currency(rental.daily_rate) %>/day</div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

