<div class="max-w-5xl mx-auto p-4" data-controller="calendar"
     data-calendar-endpoint-value="<%= available_slots_rental_path(@rental, duration: @duration_minutes, quantity: @quantity) %>">
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Rent <%= @rental.name %></h1>
        <p class="text-sm text-gray-500 mt-1">Select a duration to see available pickup times.</p>
      </div>
      <%= link_to rentals_path, class: "text-blue-600 hover:underline text-sm" do %>
        ← Back to Rentals
      <% end %>
    </div>

    <% pricing_map_json = @duration_pricing_map.transform_keys(&:to_s).to_json %>
    <div class="mt-4"
         data-controller="rental-pricing"
         data-rental-pricing-pricing-map-value="<%= raw(pricing_map_json) %>"
         data-rental-pricing-deposit-per-unit-value="<%= @rental.security_deposit.to_f %>"
         data-rental-pricing-currency-value="USD">
      <%= form_with url: calendar_rental_path(@rental), method: :get, local: true, class: "grid grid-cols-1 md:grid-cols-3 gap-4" do %>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Duration</label>
          <% selected_label = (@pricing_preview[:label] || @rental.duration_in_words(@duration_minutes)) %>
          <div class="relative" data-controller="dropdown"
               data-dropdown-selected-value-value="<%= @duration_minutes %>"
               data-dropdown-selected-text-value="<%= selected_label %>">
            <button type="button"
                    class="w-full bg-white border border-gray-300 rounded-md shadow-sm px-3 py-2 text-left cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    data-dropdown-target="button"
                    data-action="click->dropdown#toggle">
              <span class="rich-dropdown-text text-gray-900">
                <%= selected_label %>
              </span>
              <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                <svg class="h-5 w-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </span>
            </button>
            <%= hidden_field_tag :duration, @duration_minutes,
                  id: "calendar_duration_input",
                  data: { dropdown_target: 'hidden', rental_pricing_target: 'durationInput' } %>
            <div class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 ring-1 ring-black ring-opacity-5 overflow-auto hidden"
                 data-dropdown-target="menu">
              <% @duration_options.each do |minutes| %>
                <% option_pricing = @duration_pricing_map[minutes] || {} %>
                <% option_label = option_pricing[:label] || @rental.duration_in_words(minutes) %>
                <div class="cursor-pointer select-none relative py-2 px-3 hover:bg-blue-50 transition-colors"
                     data-item-id="<%= minutes %>"
                     data-item-text="<%= option_label %>"
                     data-dropdown-target="option"
                     data-action="click->dropdown#select">
                  <%= option_label %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
          <div class="relative" data-controller="dropdown"
               data-dropdown-selected-value-value="<%= @quantity %>"
               data-dropdown-selected-text-value="<%= pluralize(@quantity, 'unit') %>">
            <button type="button"
                    class="w-full bg-white border border-gray-300 rounded-md shadow-sm px-3 py-2 text-left cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    data-dropdown-target="button"
                    data-action="click->dropdown#toggle">
              <span class="rich-dropdown-text text-gray-900">
                <%= pluralize(@quantity, 'unit') %>
              </span>
              <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                <svg class="h-5 w-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </span>
            </button>
            <%= hidden_field_tag :quantity, @quantity,
                  id: "calendar_quantity_input",
                  data: { dropdown_target: 'hidden', rental_pricing_target: 'quantityInput' } %>
            <div class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 ring-1 ring-black ring-opacity-5 overflow-auto hidden"
                 data-dropdown-target="menu">
              <% (1..@rental.rental_quantity_available).each do |qty| %>
                <div class="cursor-pointer select-none relative py-2 px-3 hover:bg-blue-50 transition-colors"
                     data-item-id="<%= qty %>"
                     data-item-text="<%= pluralize(qty, 'unit') %>"
                     data-dropdown-target="option"
                     data-action="click->dropdown#select">
                  <%= pluralize(qty, 'unit') %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
        <div class="self-end">
          <button class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 cursor-pointer">
            Update Calendar
          </button>
        </div>
      <% end %>
      <div class="mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg space-y-3">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Estimated Total</p>
            <p class="text-2xl font-semibold text-gray-900" data-rental-pricing-target="totalDisplay">
              <%= number_to_currency(@pricing_preview[:base_total].to_f * @quantity) %>
            </p>
            <p class="text-xs text-gray-500" data-rental-pricing-target="rateDetail">
              <%= selected_label %> × <%= @quantity %>
            </p>
          </div>
          <div class="text-xs text-gray-500 text-right">
            <p>Availability updates instantly as you change duration or quantity.</p>
          </div>
        </div>
        <div class="<%= @deposit_preview.to_f.positive? ? 'flex items-center justify-between text-sm text-gray-700 border-t border-dashed border-gray-300 pt-3' : 'hidden' %>"
             data-rental-pricing-target="depositRow"
             data-deposit-row>
          <span>Security Deposit</span>
          <span class="font-medium" data-rental-pricing-target="depositDisplay">
            <%= number_to_currency(@deposit_preview) %>
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow">
    <div class="p-4 sm:p-6 border-b border-gray-200 flex justify-between items-center">
      <div>
        <h2 class="text-lg font-semibold text-gray-900">Available Time Slots</h2>
        <p class="text-sm text-gray-500">
          <%
            duration_label = case @duration_minutes
            when 0..119 then "#{@duration_minutes / 60} hour#{'s' if @duration_minutes > 60}"
            when 120..1439 then "#{@duration_minutes / 60} hours"
            when 1440 then "1 day"
            when 2880 then "2 days"
            when 4320 then "3 days"
            when 10080 then "7 days"
            when 20160 then "14 days"
            when 40320 then "28 days"
            else
              days = @duration_minutes / 1440
              days == 1 ? "1 day" : "#{days} days"
            end
          %>
          Showing slots for <%= duration_label %>
        </p>
      </div>
      <div class="flex items-center space-x-2">
        <%= link_to calendar_rental_path(@rental, duration: @duration_minutes, quantity: @quantity, date: @date.prev_month),
              class: "px-3 py-2 bg-gray-100 rounded hover:bg-gray-200 transition-colors text-sm" do %>
          ‹ Previous
        <% end %>
        <span class="font-medium text-sm"><%= @date.strftime("%B %Y") %></span>
        <%= link_to calendar_rental_path(@rental, duration: @duration_minutes, quantity: @quantity, date: @date.next_month),
              class: "px-3 py-2 bg-gray-100 rounded hover:bg-gray-200 transition-colors text-sm" do %>
          Next ›
        <% end %>
      </div>
    </div>

    <div class="p-4 sm:p-6">
      <div class="grid grid-cols-7 gap-2">
        <% %w[Sun Mon Tue Wed Thu Fri Sat].each do |day| %>
          <div class="text-center text-xs font-semibold text-gray-500 p-2"><%= day %></div>
        <% end %>
        <% (@calendar_start_date..@calendar_end_date).each do |date| %>
          <% slots = @calendar_data[date.to_s] || [] %>
          <% disabled = date < Date.current %>
          <button type="button"
                  class="calendar-day border rounded p-2 text-left min-h-[90px] <%= disabled ? 'opacity-40 cursor-not-allowed bg-gray-50' : 'hover:bg-blue-50 cursor-pointer' %>"
                  data-date="<%= date %>"
                  data-slots="<%= slots.size %>"
                  data-fetch-url="<%= available_slots_rental_path(@rental, date: date, duration: @duration_minutes, quantity: @quantity) %>"
                  <%= 'disabled' if disabled %>>
            <div class="text-sm font-medium text-gray-900"><%= date.day %></div>
            <div class="text-xs text-gray-500 mt-1">
              <%= pluralize(slots.size, 'slot') %>
            </div>
          </button>
        <% end %>
      </div>
    </div>
  </div>

  <div class="slot-detail-overlay hidden fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
    <div class="slot-detail-container bg-white rounded-t-lg sm:rounded-lg shadow-lg w-full sm:max-w-md sm:w-full max-h-[85vh] sm:max-h-[80vh] overflow-y-auto"></div>
  </div>
</div>

<script>
document.addEventListener('turbo:load', setupRentalCalendar);
document.addEventListener('DOMContentLoaded', setupRentalCalendar);

function setupRentalCalendar() {
  if (setupRentalCalendar.initialized) return;
  setupRentalCalendar.initialized = true;

  document.querySelectorAll('.calendar-day').forEach(function(dayButton) {
    dayButton.addEventListener('click', function() {
      const fetchUrl = this.dataset.fetchUrl;
      if (!fetchUrl) return;

      fetch(fetchUrl, { headers: { 'Accept': 'application/json' } })
        .then(response => response.json())
        .then(data => showSlotOverlay(data.slots || [], data.date))
        .catch(() => alert('Unable to load time slots for this date.'));
    });
  });
}

function showSlotOverlay(slots, date) {
  const overlay = document.querySelector('.slot-detail-overlay');
  const container = document.querySelector('.slot-detail-container');
  const formattedDate = new Date(date).toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
  const currencyFormatter = new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' });

  let html = `
    <div class="p-4 sm:p-6 border-b flex items-center justify-between">
      <div>
        <h3 class="text-lg font-semibold text-gray-900">Available Slots</h3>
        <p class="text-sm text-gray-500">${formattedDate}</p>
      </div>
      <button class="close-slot-overlay cursor-pointer text-gray-500 hover:text-gray-700">
        ✕
      </button>
    </div>
    <div class="p-4 sm:p-6 space-y-3">
  `;

  if (slots.length === 0) {
    html += `<div class="text-sm text-gray-500">No slots available for this date.</div>`;
  } else {
    slots.forEach(slot => {
      const startTime = new Date(slot.start_time).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      const endTime = new Date(slot.end_time).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      const quantity = slot.requested_quantity || <%= @quantity %>;
      const subtotal = slot.subtotal ? currencyFormatter.format(slot.subtotal) : null;
      const deposit = slot.deposit_amount && slot.deposit_amount > 0 ? currencyFormatter.format(slot.deposit_amount) : null;
      const remaining = typeof slot.available_quantity === 'number' ? slot.available_quantity : '—';
      const bookingUrl = "<%= book_rental_path(@rental) %>?start_time=" + encodeURIComponent(slot.start_time) + "&duration=<%= @duration_minutes %>&quantity=" + quantity;

      html += `
        <div class="border rounded-lg overflow-hidden">
          <div class="px-4 py-3 bg-blue-50 text-blue-900 font-medium">${startTime} – ${endTime}</div>
          <div class="px-4 py-3 text-sm text-gray-700 space-y-1">
            <div class="flex items-center justify-between">
              <span>Total (${quantity} unit${quantity > 1 ? 's' : ''})</span>
              <span class="font-semibold">${subtotal || '—'}</span>
            </div>
            ${deposit ? `<div class="flex items-center justify-between text-xs text-gray-500"><span>Deposit due now</span><span>${deposit}</span></div>` : ''}
            <div class="text-xs text-gray-500">Remaining units: ${remaining}</div>
          </div>
          <a href="${bookingUrl}"
             class="block px-4 py-3 text-center text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 transition-colors">
            Rent This Slot
          </a>
        </div>
      `;
    });
  }

  html += `</div>`;
  container.innerHTML = html;
  overlay.classList.remove('hidden');

  // Attach close button event listener
  const closeButton = container.querySelector('.close-slot-overlay');
  if (closeButton) {
    closeButton.addEventListener('click', () => overlay.classList.add('hidden'));
  }

  // Allow clicking outside the modal to close it
  overlay.addEventListener('click', function(event) {
    if (event.target === overlay) overlay.classList.add('hidden');
  }, { once: true });
}
</script>

