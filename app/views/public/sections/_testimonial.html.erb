<% current_business = local_assigns[:business] %>
<% accent_enabled = current_business&.website_layout_enhanced? %>
<% limit = section.section_config&.dig('limit').presence || 4 %>
<% reviews_data = current_business&.google_place_id.present? ? GoogleReviewsService.fetch(current_business) : nil %>

<div class="testimonial-section bg-black text-white py-16">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-8">
          <div>
            <p class="uppercase tracking-[0.3em] text-sm <%= accent_enabled ? 'accent-text' : 'text-red-400' %>">Testimonials</p>
        <h2 class="text-3xl md:text-4xl font-bold mt-3">
          <%= section.content_data['title'].presence || 'What Clients Are Saying' %>
        </h2>
      </div>

      <% if reviews_data.present? && reviews_data[:success] && reviews_data[:place] %>
            <div class="flex items-center gap-4 bg-white/5 border border-white/10 rounded-full px-5 py-3 <%= 'accent-pill' if accent_enabled %>">
          <div class="flex items-center gap-2">
                <svg class="w-6 h-6 <%= accent_enabled ? 'accent-strong' : 'text-red-400' %>" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10 15l-5.878 3.09 1.122-6.545L.488 6.91l6.562-.955L10 0l2.95 5.955 6.562.955-4.756 4.635 1.122 6.545z" />
            </svg>
                <span class="text-lg font-semibold <%= accent_enabled ? 'accent-strong' : '' %>"><%= reviews_data[:place][:rating].to_f.round(1) %>/5.0</span>
          </div>
          <% if reviews_data[:place][:user_ratings_total] %>
                <span class="text-sm <%= accent_enabled ? 'accent-text' : 'text-gray-300' %>"><%= reviews_data[:place][:user_ratings_total] %>+ Google reviews</span>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="mt-12 grid gap-8 md:grid-cols-2">
      <% if reviews_data.present? && reviews_data[:success] && reviews_data[:reviews].present? %>
        <% reviews_data[:reviews].first(limit).each do |review| %>
          <article class="bg-white/5 border border-white/10 rounded-3xl p-6 h-full flex flex-col justify-between">
            <div>
              <div class="flex items-center gap-3">
                <% if review[:profile_photo_url].present? %>
                  <img src="<%= review[:profile_photo_url] %>" alt="<%= review[:author_name] %>" class="w-12 h-12 rounded-full object-cover border border-white/10">
                <% else %>
                  <div class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center">
                    <span class="text-xl font-semibold"><%= review[:author_name].to_s.slice(0, 1) %></span>
                  </div>
                <% end %>
                <div>
                  <% if review[:author_url].present? %>
                    <% link_classes = if accent_enabled
                                         'font-semibold accent-link-white'
                                       else
                                         'font-semibold hover:text-red-300 transition'
                                       end %>
                    <a href="<%= review[:author_url] %>" target="_blank" rel="noopener noreferrer" class="<%= link_classes %>">
                      <%= review[:author_name] %>
                    </a>
                  <% else %>
                    <p class="font-semibold"><%= review[:author_name] %></p>
                  <% end %>
                  <div class="flex items-center gap-1">
                    <% (1..5).each do |star| %>
                      <% star_class = if star <= review[:rating].to_i
                                         accent_enabled ? 'accent-strong' : 'text-yellow-400'
                                       else
                                         'text-gray-600'
                                       end %>
                      <svg class="w-4 h-4 <%= star_class %>" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                      </svg>
                    <% end %>
                  </div>
                </div>
              </div>

              <% if review[:text].present? %>
                <p class="mt-6 text-gray-200 leading-relaxed">
                  <%= ERB::Util.h(review[:text]) %>
                </p>
              <% end %>
            </div>

            <% if review[:author_url].present? %>
              <% view_link_classes = if accent_enabled
                                        'mt-6 inline-flex items-center gap-2 text-sm accent-link-white'
                                      else
                                        'mt-6 inline-flex items-center gap-2 text-sm text-red-300 hover:text-red-200 transition'
                                      end %>
              <a href="<%= review[:author_url] %>" target="_blank" rel="noopener noreferrer" class="<%= view_link_classes %>">
                View on Google
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M12.293 2.293a1 1 0 011.414 0L19 7.586a1 1 0 010 1.414l-7.293 7.293a1 1 0 01-1.414-1.414L15.586 10H3a1 1 0 110-2h12.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </a>
            <% end %>
          </article>
        <% end %>
      <% else %>
        <article class="bg-white/5 border border-white/10 rounded-3xl p-8">
          <p class="text-lg leading-relaxed text-gray-200">
            "<%= ERB::Util.h(section.content_data['fallback_quote'] || "We've worked with this team for years and they always deliver above and beyond expectations.") %>"
          </p>
        <p class="mt-6 font-semibold <%= accent_enabled ? 'accent-text' : 'text-red-300' %>">
            <%= ERB::Util.h(section.content_data['fallback_author'].presence || current_business&.name || 'Happy Customer') %>
          </p>
        </article>
      <% end %>
    </div>
  </div>
</div>

