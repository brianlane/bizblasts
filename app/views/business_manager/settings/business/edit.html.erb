<%# app/views/business_manager/settings/business/edit.html.erb %>
<div class="container mx-auto px-4 py-4 sm:py-8">
  <!-- Header Section -->
  <div class="bg-white shadow-lg rounded-xl overflow-hidden border border-gray-100 mb-8">
    <div class="bg-gradient-to-r from-primary to-secondary px-4 py-6 sm:px-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-gradient-to-br from-white/20 to-white/10 backdrop-blur-sm rounded-lg flex items-center justify-center text-white border border-white/30">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
          </div>
          <div>
            <h1 class="text-xl sm:text-2xl font-bold text-white">
              Business Settings
            </h1>
            <p class="text-white/80 text-sm mt-1">
              Manage your business information and preferences
            </p>
          </div>
        </div>
        
        <%= link_to business_manager_settings_path,
              class: "inline-flex items-center justify-center px-4 py-2 bg-white/10 backdrop-blur-sm border border-white/20 text-sm font-medium rounded-lg text-white hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white/50 focus:ring-offset-2 focus:ring-offset-primary transition-all duration-200" do %>
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          Back to Settings
        <% end %>
      </div>
    </div>
  </div>

  <!-- Stripe Connect Section -->
  <div class="bg-white shadow-lg rounded-xl overflow-hidden border border-gray-100 mb-8">
    <div class="px-6 py-4 bg-gradient-to-r from-purple-50 to-purple-100 border-b border-purple-200">
      <h2 class="text-lg font-semibold text-gray-900 flex items-center">
        <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
        </svg>
        Payment Processing
      </h2>
      <p class="text-sm text-gray-600 mt-1">Connect your Stripe account to accept payments</p>
    </div>
    <div class="p-6">
      <% if @business.stripe_account_id.blank? %>
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center">
              <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
              </svg>
            </div>
            <div>
              <p class="font-medium text-amber-800">Stripe account not connected</p>
              <p class="text-sm text-amber-700">Connect your Stripe account to start accepting payments</p>
            </div>
          </div>
          <%= button_to 'Connect Stripe Account', connect_stripe_business_manager_settings_business_path,
                method: :post,
                data: { turbo: false },
                class: 'inline-flex items-center px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-all duration-200 shadow-sm cursor-pointer' %>
        </div>
      <% elsif StripeService.check_onboarding_status(@business) %>
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 p-4 bg-emerald-50 border border-success/30 rounded-lg">
          <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">
            <svg class="w-5 h-5 text-success" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div>
            <p class="font-medium text-success">Stripe account connected</p>
            <p class="text-sm text-success">Your payment processing is ready to go</p>
          </div>
          <div>
            <%= button_to 'Disconnect Stripe Account', disconnect_stripe_business_manager_settings_business_path,
                  method: :delete,
                  data: { turbo: false, confirm: 'Are you sure you want to disconnect your Stripe account? This action cannot be undone.' },
                  class: 'inline-flex items-center px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all duration-200 shadow-sm cursor-pointer' %>
          </div>
        </div>
      <% else %>
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center">
              <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div>
              <p class="font-medium text-amber-800">Complete Stripe setup</p>
              <p class="text-sm text-amber-700">Finish setting up your Stripe account to accept payments</p>
            </div>
          </div>
          <div class="flex gap-2">
            <%= button_to 'Complete Setup', stripe_onboarding_business_manager_settings_business_path,
                  method: :get,
                  data: { turbo: false },
                  class: 'inline-flex items-center px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-all duration-200 shadow-sm cursor-pointer' %>
            <%= button_to 'Refresh Status', refresh_stripe_business_manager_settings_business_path,
                  method: :post,
                  data: { turbo: false },
                  class: 'inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200 border border-gray-300 cursor-pointer' %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Error Messages -->
  <% if @business.errors.any? %>
    <div class="bg-red-50 border border-red-300 rounded-xl overflow-hidden shadow-sm">
      <div class="px-6 py-4 bg-red-100 border-b border-red-200">
        <div class="flex items-center">
          <svg class="w-5 h-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          <h3 class="text-sm font-medium text-red-800">Please fix the following errors:</h3>
        </div>
      </div>
      <div class="px-6 py-4">
        <ul class="list-disc list-inside text-sm text-red-700 space-y-1">
          <% @business.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <!-- Branding Section -->
  <%= form_with(model: [:business_manager, :settings, @business], url: business_manager_settings_business_path, method: :patch, local: true, data: { turbo: false }, html: { class: "space-y-8", id: "main-business-form" }) do |form| %>
    <div class="bg-white shadow-lg rounded-xl overflow-hidden border border-gray-100">
      <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
          <svg class="w-5 h-5 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          Branding
        </h2>
        <p class="text-sm text-gray-600 mt-1">Upload your business logo and set your visual identity</p>
      </div>
      <div class="p-6">
        <div class="space-y-6">
          <div>
            <%= form.label :logo, "Business Logo", class: "block text-sm font-medium text-gray-700 mb-3" %>
            <% if @business.logo.attached? %>
              <div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                  <%= image_tag rails_public_blob_url(@business.logo.variant(resize_to_limit: [120, 120])), 
                        class: "h-24 w-24 object-contain rounded-lg bg-white border border-gray-200 mx-auto sm:mx-0" %>
                  <div class="text-center sm:text-left">
                    <p class="text-sm font-medium text-gray-900">Current Logo</p>
                    <p class="text-xs text-gray-500 mt-1">Upload a new file to replace</p>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-2 mb-4">
                <%= form.check_box :remove_logo,
                      class: "focus:ring-primary h-4 w-4 text-primary border-gray-300 rounded cursor-pointer" %>
                <%= form.label :remove_logo,
                      "Remove current logo",
                      class: "text-sm text-gray-700 cursor-pointer" %>
              </div>
              <p class="text-xs text-gray-500 mb-4">
                Selecting this option deletes the current logo when you save.
              </p>
            <% end %>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-gray-400 transition-colors">
              <%= form.file_field :logo, 
                    class: "block w-full text-sm text-gray-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-light file:text-primary hover:file:bg-light cursor-pointer",            
                    accept: "image/png,image/jpeg,image/gif,image/webp,image/heic,image/heif",
                    data: { allowed_types: "image/png,image/jpeg,image/gif,image/webp,image/heic,image/heif" },
                    onchange: "validateBusinessLogo(this)" %>
              <p class="mt-2 text-xs text-gray-500 text-center">
                <span class="font-medium">Click to upload</span> or drag and drop<br>
                PNG, JPEG, GIF, WebP, HEIC, HEIF up to 15MB • Square format recommended • HEIC files automatically converted to JPEG
              </p>
              
              <script>
                function validateBusinessLogo(input) {
                  const file = input.files[0];
                  if (!file) return;
                  
                  // Check file size (15MB = 15 * 1024 * 1024 bytes)
                  if (file.size > 15 * 1024 * 1024) {
                    alert('Logo must be less than 15MB. Please choose a smaller file.');
                    input.value = '';
                    return;
                  }
                  
                  // Check file type - get from data attribute or fallback
                  const allowedTypes = input.dataset.allowedTypes ? 
                    input.dataset.allowedTypes.split(',') :
                    ['image/png', 'image/jpeg', 'image/gif', 'image/webp', 'image/heic', 'image/heif'];                                     
                  if (!allowedTypes.includes(file.type)) {
                    alert('Logo must be PNG, JPEG, GIF, WebP, HEIC, or HEIF format.');                                                                         
                    input.value = '';
                    return;
                  }
                }
              </script>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contact Information Section -->
    <div class="bg-white shadow-lg rounded-xl overflow-hidden border border-gray-100 mb-8">
      <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
          <svg class="w-5 h-5 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
          Contact Information
        </h2>
        <p class="text-sm text-gray-600 mt-1">Update your business contact details and location</p>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Basic Info -->
          <div class="space-y-4">
            <div>
              <%= form.label :name, "Business Name", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.text_field :name, 
                    class: "block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary sm:text-sm transition-colors",
                    placeholder: "Enter your business name" %>
            </div>
            <div>
              <%= form.label :industry, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= render 'shared/rich_dropdown',
                  collection: Business.industries.keys.map { |ind| [ind.to_s.humanize.titleize, ind] },
                  field_name: "#{form.object_name}[industry]",
                  selected_value: form.object.industry,
                  prompt_text: "Select your industry",
                  value_method: :last,
                  text_method: :first,
                  required: false,
                  dropdown_id: "business_industry_dropdown" %>
            </div>
            <div>
              <%= form.label :phone, "Business Phone", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.telephone_field :phone,
                    pattern: "^(\+1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})$",
                    title: "Please enter a valid US phone number (e.g., (555) 123-4567 or 555-123-4567)",
                    class: "block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary sm:text-sm transition-colors",
                    placeholder: "(555) 123-4567" %>
            </div>
            <div>
              <%= form.label :email, "Business Email", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.email_field :email,
                    pattern: "[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$",
                    title: "Please enter a valid business email address",
                    class: "block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary sm:text-sm transition-colors",
                    placeholder: "contact@yourbusiness.com" %>
            </div>
            <div>
              <%= form.label :website, "Website", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.url_field :website,
                    class: "block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary sm:text-sm transition-colors",
                    placeholder: "https://yourbusiness.com" %>
            </div>
          </div>

          <!-- Address -->
          <div class="space-y-4">
            <div>
              <%= form.label :address, "Street Address", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.text_field :address, 
                    class: "block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary sm:text-sm transition-colors",
                    placeholder: "123 Main Street" %>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div>
                <%= form.label :city, class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= form.text_field :city, 
                      class: "block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary sm:text-sm transition-colors",
                      placeholder: "City" %>
              </div>
              <div>
                <%= form.label :state, class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= form.text_field :state, list: "state-list",
                      class: "block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary sm:text-sm transition-colors",
                      placeholder: "State" %>
                <datalist id="state-list">
                  <% %w[Alabama Alaska Arizona Arkansas California Colorado Connecticut Delaware Florida Georgia Hawaii Idaho Illinois Indiana Iowa Kansas Kentucky Louisiana Maine Maryland Massachusetts Michigan Minnesota Mississippi Missouri Montana Nebraska Nevada New\ Hampshire New\ Jersey New\ Mexico New\ York North\ Carolina North\ Dakota Ohio Oklahoma Oregon Pennsylvania Puerto\ Rico Rhode\ Island South\ Carolina South\ Dakota Tennessee Texas Utah Vermont Virginia Washington West\ Virginia Wisconsin Wyoming].each do |state_name| %>
                    <option value="<%= state_name %>"><%= state_name %></option>
                  <% end %>
                </datalist>
              </div>
              <div>
                <%= form.label :zip, "ZIP Code", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= form.text_field :zip,
                      pattern: "[0-9]{5}(-[0-9]{4})?",
                      title: "Please enter a valid ZIP code (5 digits or 5+4 format, e.g., 12345 or 12345-6789)",
                      maxlength: "10",
                      class: "block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary sm:text-sm transition-colors",
                      placeholder: "12345 or 12345-6789" %>
              </div>
            </div>
          </div>
        </div>

        <!-- Description -->
        <div class="mt-6">
          <%= form.label :description, "Business Description", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= form.text_area :description, 
                rows: 4, 
                class: "block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary sm:text-sm transition-colors resize-none",
                placeholder: "Describe your business, services, and what makes you unique..." %>
          <p class="mt-1 text-xs text-gray-500">This description may be displayed on your public business profile.</p>
        </div>
      </div>
    </div>
  <!-- Form continues below to include Domain & URL Settings -->

  <!-- Domain Management Section (Independent Form) -->
  <div class="bg-white shadow-lg rounded-xl overflow-hidden border border-gray-100 mb-8">
      <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
          <svg class="w-5 h-5 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"/>
          </svg>
          Domain & URL Settings
        </h2>
        <p class="text-sm text-gray-600 mt-1">View your current domain and request changes</p>
      </div>
      <div class="p-6">
        <div class="space-y-6">
          <!-- Current Domain Display -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-3">Current Domain</label>
            <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-900">
                    <% if @business.host_type == 'custom_domain' && @business.hostname.present? %>
                      <%= @business.hostname %>
                      <span class="inline-flex items-center px-2 py-1 ml-2 text-xs font-medium bg-green-100 text-green-800 rounded-full">
                        Custom Domain
                      </span>
                    <% elsif @business.hostname.present? %>
                      <%= @business.hostname %>.bizblasts.com
                      <span class="inline-flex items-center px-2 py-1 ml-2 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">
                        Subdomain
                      </span>
                    <% else %>
                      Not configured
                      <span class="inline-flex items-center px-2 py-1 ml-2 text-xs font-medium bg-gray-100 text-gray-600 rounded-full">
                        Default
                      </span>
                    <% end %>
                  </p>
                  <p class="text-xs text-gray-500 mt-1">
                    <% if @business.host_type == 'custom_domain' %>
                      This is your custom domain managed by BizBlasts
                    <% elsif @business.hostname.present? %>
                      This is your BizBlasts subdomain
                    <% else %>
                      Your business is accessible through the default BizBlasts URL
                    <% end %>
                  </p>
                </div>
                <div class="flex items-center">
                  <% if @business.hostname.present? %>
                    <a href="<%= @business.host_type == 'custom_domain' ? "https://#{@business.hostname}" : "https://#{@business.hostname}.bizblasts.com" %>" 
                       target="_blank" 
                       class="inline-flex items-center text-sm text-primary hover:text-primary">
                      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                      </svg>
                      Visit Site
                    </a>
                  <% end %>
                </div>
              </div>
            </div>
          </div>

          <!-- Domain Status Checker -->
          <% if @business.host_type_custom_domain? && @business.hostname.present? %>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-3">Domain Status</label>
              <div id="domain-status-container" class="p-4 bg-white border border-gray-200 rounded-lg">
                <div class="flex items-center justify-between">
                  <div>
                    <div id="domain-status-indicator" class="flex items-center">
                      <div class="w-3 h-3 bg-gray-400 rounded-full mr-2"></div>
                      <span id="domain-status-text" class="text-sm font-medium text-gray-600">Checking status...</span>
                    </div>
                    <p id="domain-status-details" class="text-xs text-gray-500 mt-1">Verifying domain configuration and health</p>
                  </div>
                  <div class="flex items-center space-x-2">
                    <button id="check-domain-btn" 
                            type="button"
                            class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-primary bg-light border border-primary/30 rounded-md hover:bg-light focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
                            onclick="checkDomainStatus()">
                      <svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                      </svg>
                      Check Now
                    </button>
                  </div>
                </div>
                
                <!-- Detailed Status Information (Hidden by default) -->
                <div id="domain-status-details-expanded" class="mt-4 space-y-3 hidden">
                  <div class="border-t border-gray-200 pt-4">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-xs">
                      <div>
                        <div class="flex items-center">
                          <div id="dns-check-indicator" class="w-2 h-2 bg-gray-400 rounded-full mr-2"></div>
                          <span class="font-medium">DNS Configuration</span>
                        </div>
                        <p id="dns-check-text" class="text-gray-500 mt-1">Checking CNAME record...</p>
                      </div>
                      <div>
                        <div class="flex items-center">
                          <div id="render-check-indicator" class="w-2 h-2 bg-gray-400 rounded-full mr-2"></div>
                          <span class="font-medium">Render Integration</span>
                        </div>
                        <p id="render-check-text" class="text-gray-500 mt-1">Verifying domain in Render...</p>
                      </div>
                      <div>
                        <div class="flex items-center">
                          <div id="health-check-indicator" class="w-2 h-2 bg-gray-400 rounded-full mr-2"></div>
                          <span class="font-medium">Health Check</span>
                        </div>
                        <p id="health-check-text" class="text-gray-500 mt-1">Testing HTTP response...</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>

          <!-- Canonical URL Preference (Show for Custom Domains) -->
          <div id="canonical-preference-section" class="mt-6" <%= 'style="display:none;"' unless @business.host_type_custom_domain? %>>
            <label class="block text-sm font-medium text-gray-700 mb-3">Canonical URL Preference</label>
            <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
              <p class="text-sm text-gray-600 mb-4">Choose how your domain should be displayed. Both versions will work, but one will redirect to the other for SEO consistency.</p>
              
              <div class="space-y-3">
                <div class="flex items-center">
                  <%= form.radio_button :canonical_preference, 'www', class: "h-4 w-4 text-primary border-gray-300 focus:ring-primary cursor-pointer" %>
                  <label for="business_canonical_preference_www" class="ml-2 text-sm text-gray-700 cursor-pointer">
                    <code id="www-domain-preview" class="bg-white px-2 py-1 rounded text-primary">www.<%= @business.hostname.present? ? @business.hostname.sub(/^www\./, '') : 'yourdomain.com' %></code>
                    <span class="text-gray-500 ml-1">(Recommended - matches main site behavior)</span>
                  </label>
                </div>
                <div class="flex items-center">
                  <%= form.radio_button :canonical_preference, 'apex', class: "h-4 w-4 text-primary border-gray-300 focus:ring-primary cursor-pointer" %>
                  <label for="business_canonical_preference_apex" class="ml-2 text-sm text-gray-700 cursor-pointer">
                    <code id="apex-domain-preview" class="bg-white px-2 py-1 rounded text-primary"><%= @business.hostname.present? ? @business.hostname.sub(/^www\./, '') : 'yourdomain.com' %></code>
                    <span class="text-gray-500 ml-1">(Advanced option)</span>
                  </label>
                </div>
              </div>
              
              <div class="mt-3 p-3 bg-light border border-primary/30 rounded-lg">
                <div class="flex items-start">
                  <svg class="w-4 h-4 text-primary mt-0.5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <p id="canonical-preview-text" class="text-xs text-primary">
                    <strong>Current setting:</strong> 
                    <% if @business.www_canonical_preference? %>
                      <span id="redirect-explanation">Visitors to <code id="from-domain" class="text-blue-800"><%= @business.hostname.present? ? @business.hostname.sub(/^www\./, '') : 'yourdomain.com' %></code> will be redirected to <code id="to-domain" class="text-blue-800">www.<%= @business.hostname.present? ? @business.hostname.sub(/^www\./, '') : 'yourdomain.com' %></code></span>
                    <% else %>
                      <span id="redirect-explanation">Visitors to <code id="from-domain" class="text-blue-800">www.<%= @business.hostname.present? ? @business.hostname.sub(/^www\./, '') : 'yourdomain.com' %></code> will be redirected to <code id="to-domain" class="text-blue-800"><%= @business.hostname.present? ? @business.hostname.sub(/^www\./, '') : 'yourdomain.com' %></code></span>
                    <% end %>
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Domain Change Request -->
          <div>
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">Domain Mode</label>
              <div class="flex items-center gap-6">
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="business[host_type]" value="subdomain" id="host_type_subdomain"
                         <%= 'checked' if @business.host_type_subdomain? %>
                         class="h-4 w-4 text-primary border-gray-300 focus:ring-primary cursor-pointer">
                  <span class="text-sm">BizBlasts Subdomain</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="business[host_type]" value="custom_domain" id="host_type_custom"
                         <%= 'checked' if @business.host_type_custom_domain? %>
                         class="h-4 w-4 text-primary border-gray-300 focus:ring-primary cursor-pointer">
                  <span class="text-sm">Custom Domain</span>
                </label>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="domain-input-wrapper">
              <div id="subdomain-input-group" <%= 'style="display:none;"' unless @business.host_type_subdomain? %>>
                <label for="display_subdomain" class="block text-sm font-medium text-gray-700 mb-1">Subdomain</label>
                <input type="text"
                       id="display_subdomain"
                       name="business[subdomain]"
                       value="<%= @business.subdomain || @business.hostname %>"
                       placeholder="your-biz"
                       class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary sm:text-sm" />
                <p class="text-xs text-gray-500 mt-1">Will appear as your-biz.bizblasts.com</p>
              </div>

              <div id="customdomain-input-group" <%= 'style="display:none;"' unless @business.host_type_custom_domain? %>>
                <label for="display_hostname" class="block text-sm font-medium text-gray-700 mb-1">Custom Domain</label>
                <input type="text"
                       id="display_hostname"
                       name="business[hostname]"
                       value="<%= @business.hostname %>"
                       placeholder="yourdomain.com"
                       class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary sm:text-sm" />
                <p class="text-xs text-gray-500 mt-1">Enter full domain (example.com)</p>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

  <!-- Continuing with the same form object `form` declared above -->
  <!-- Hours of Operation Section -->
  <div class="bg-white shadow-lg rounded-xl overflow-hidden border border-gray-100 mb-8">
    <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900 flex items-center">
        <svg class="w-5 h-5 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Hours of Operation
      </h2>
      <p class="text-sm text-gray-600 mt-1">Set your business hours for each day of the week. Only for display purposes.</p>
    </div>
    <div class="p-6">
      <div class="space-y-4">
        <% days = %w[mon tue wed thu fri sat sun] %>
        <% day_labels = { 'mon' => 'Monday', 'tue' => 'Tuesday', 'wed' => 'Wednesday', 'thu' => 'Thursday', 'fri' => 'Friday', 'sat' => 'Saturday', 'sun' => 'Sunday' } %>
        <% current_hours = @business.hours.is_a?(Hash) ? @business.hours.with_indifferent_access : {} %>
        <% days.each do |day_key|
          day_label = day_labels[day_key]
          hours_for_day = current_hours[day_key] || {}
          open_time = hours_for_day[:open] || hours_for_day['open']
          close_time = hours_for_day[:close] || hours_for_day['close']
        %>
          <div class="grid grid-cols-1 sm:grid-cols-12 gap-4 items-center p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="sm:col-span-3">
              <span class="font-medium text-gray-900"><%= day_label %></span>
            </div>
            <div class="sm:col-span-4">
              <%= form.label "hours_#{day_key}_open", "Open Time", class: "block text-xs font-medium text-gray-600 mb-1" %>
              <%= form.time_field "hours_#{day_key}_open", 
                    value: open_time, 
                    class: "block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary text-sm transition-colors" %>
            </div>
            <div class="sm:col-span-4">
              <%= form.label "hours_#{day_key}_close", "Close Time", class: "block text-xs font-medium text-gray-600 mb-1" %>
              <%= form.time_field "hours_#{day_key}_close", 
                    value: close_time, 
                    class: "block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-primary focus:border-primary text-sm transition-colors" %>
            </div>
            <div class="sm:col-span-1 text-center">
              <button type="button" class="cursor-pointer text-gray-400 hover:text-gray-600 transition-colors" title="Clear hours">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>
        <% end %>
      </div>
      <div class="mt-4 p-4 bg-light border border-primary/30 rounded-lg">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-primary mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <div class="text-sm text-blue-800">
            <p class="font-medium mb-1">Hours Tips:</p>
            <ul class="text-primary space-y-1">
              <li>• Leave both times blank if closed on that day</li>
              <li>• Use 12-hour format for times (e.g., 2:00 PM for 14:00)</li>
              <li>• These hours will be displayed to customers</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- Inventory Management Section -->
    <div id="inventory-management" class="bg-white shadow-lg rounded-xl overflow-hidden border border-gray-100 mb-8">
      <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
          <svg class="w-5 h-5 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
          </svg>
          Inventory Management
        </h2>
        <p class="text-sm text-gray-600 mt-1">Control how your business handles product inventory</p>
      </div>
      <div class="p-6">
        <div class="bg-light border border-primary/30 rounded-lg p-4">
          <div class="flex items-start">
            <div class="flex items-center h-5">
              <%= form.check_box :stock_management_enabled, 
                    class: "focus:ring-primary h-4 w-4 text-primary border-gray-300 rounded" %>
            </div>
            <div class="ml-3">
              <%= form.label :stock_management_enabled, 
                    "Enable inventory tracking", 
                    class: "text-sm font-medium text-gray-700" %>
              <p class="text-sm text-gray-600 mt-1">
                When unchecked, your products will be treated as always available. 
                Perfect for businesses that manage inventory externally.
              </p>
            </div>
          </div>
          
          <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
            <div class="flex">
              <svg class="flex-shrink-0 h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
              <div class="ml-3">
                <h4 class="text-sm font-medium text-yellow-800">Important Note</h4>
                <p class="text-sm text-yellow-700 mt-1">
                  Disabling inventory tracking means customers can order any quantity. 
                  Make sure you can fulfill orders before turning this off.
                </p>
              </div>
            </div>
          </div>
          
          <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded">
            <div class="flex">
              <svg class="flex-shrink-0 h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <div class="ml-3">
                <h4 class="text-sm font-medium text-green-800">Perfect For</h4>
                <ul class="text-sm text-green-700 mt-1 space-y-1">
                  <li>• Digital products or services</li>
                  <li>• Custom-made items</li>
                  <li>• Businesses that manage stock externally</li>
                  <li>• Drop-shipping businesses</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Location Sync Section -->
    <div class="bg-white shadow-lg rounded-xl overflow-hidden border border-gray-100 mb-8">
      <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
          <svg class="w-5 h-5 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          Location Sync
        </h2>
        <p class="text-sm text-gray-600 mt-1">Sync your business information with location data</p>
      </div>
      <div class="p-6">
        <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div class="flex items-center h-5 mt-1">
            <%= check_box_tag 'sync_location', '1', true, 
                  id: 'sync_location', 
                  class: "h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary" %>
          </div>
          <div class="flex-1">
            <%= label_tag 'sync_location', "Update main location with business info", 
                  class: "block font-medium text-gray-900 cursor-pointer" %>
            <p class="text-sm text-gray-600 mt-1">
              When enabled, your address and hours will automatically sync with your main business location.
            </p>
            <% if @business.default_location.present? %>
              <div class="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                <p class="text-sm text-green-800">
                  <span class="font-medium">Current main location:</span> <%= @business.default_location.name %>
                </p>
              </div>
            <% else %>
              <div class="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                <p class="text-sm text-amber-800">
                  <span class="font-medium">No locations found.</span> A default location will be created automatically.
                </p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Save Button -->
    <div class="flex justify-end items-center gap-4 pt-6">
      <%= link_to business_manager_settings_path,
            class: "inline-flex items-center px-6 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-all duration-200" do %>
        Cancel
      <% end %>
      <%= form.submit "Save Business Information", 
            form: "main-business-form",
            class: "inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-primary to-secondary hover:from-secondary hover:to-primary focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-all duration-200 shadow-lg hover:shadow-xl cursor-pointer" %>
    </div>
  <% end %>
</div>

<script type="text/javascript">
  // Enhanced form validation functions
  function validateField(input, isValid, errorMessage) {
    const existingError = input.parentElement.querySelector('.field-error');
    if (existingError) {
      existingError.remove();
    }

    if (!isValid) {
      input.classList.add('border-red-500', 'ring-red-500');
      input.classList.remove('border-gray-300', 'focus:border-primary', 'focus:ring-primary');
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'field-error text-red-500 text-xs mt-1';
      errorDiv.textContent = errorMessage;
      input.parentElement.appendChild(errorDiv);
    } else {
      input.classList.remove('border-red-500', 'ring-red-500');
      input.classList.add('border-gray-300', 'focus:border-primary', 'focus:ring-primary');
    }
  }

  function validateEmail(email) {
    const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;
    return emailRegex.test(email);
  }

  function validatePhone(phone) {
    const phoneRegex = /^(\+1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})$/;
    return phoneRegex.test(phone);
  }

  function validateZip(zip) {
    const zipRegex = /^[0-9]{5}(-[0-9]{4})?$/;
    return zipRegex.test(zip);
  }

  // Add real-time validation listeners
  function initializeBusinessSettingsForm() {
    // Email validation
    const emailFields = document.querySelectorAll('input[type="email"]');
    emailFields.forEach(field => {
      field.addEventListener('blur', function() {
        if (this.value) {
          const isValid = validateEmail(this.value);
          validateField(this, isValid, 'Please enter a valid email address');
        }
      });
    });

    // Phone validation
    const phoneFields = document.querySelectorAll('input[type="tel"]');
    phoneFields.forEach(field => {
      field.addEventListener('blur', function() {
        if (this.value) {
          const isValid = validatePhone(this.value);
          validateField(this, isValid, 'Please enter a valid US phone number (e.g., (555) 123-4567)');
        }
      });
    });

    // ZIP code validation
    const zipFields = document.querySelectorAll('input[name*="[zip]"]');
    zipFields.forEach(field => {
      field.addEventListener('blur', function() {
        if (this.value) {
          const isValid = validateZip(this.value);
          validateField(this, isValid, 'Please enter a valid ZIP code (5 digits or 5+4 format)');
        }
      });
    });

    // Phone number formatting
    phoneFields.forEach(field => {
      field.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, ''); // Remove non-digits
        if (value.length >= 6) {
          value = value.replace(/(\d{3})(\d{3})(\d+)/, '($1) $2-$3');
        } else if (value.length >= 3) {
          value = value.replace(/(\d{3})(\d+)/, '($1) $2');
        }
        this.value = value;
      });
    });

    // ZIP code formatting
    zipFields.forEach(field => {
      field.addEventListener('input', function() {
        // Remove all non-digits and hyphens, then remove any hyphens that aren't in the right place
        let value = this.value.replace(/[^0-9-]/g, '').replace(/-+/g, '-');
        
        // Remove hyphens that aren't after exactly 5 digits
        value = value.replace(/^(\d{1,4})-/, '$1').replace(/(\d{5})-+(\d)/, '$1-$2');
        
        // If we have more than 5 digits without a hyphen, add one
        if (value.length > 5 && !value.includes('-')) {
          value = value.replace(/(\d{5})(\d+)/, '$1-$2');
        }
        
        // Limit to 10 characters max (12345-6789)
        if (value.length > 10) {
          value = value.substring(0, 10);
        }
        
        this.value = value;
      });
    });
  }

  // Initialize on both DOMContentLoaded and turbo:load for Turbo compatibility
  document.addEventListener('DOMContentLoaded', initializeBusinessSettingsForm);
  document.addEventListener('turbo:load', initializeBusinessSettingsForm);
</script> 

<!-- JS for Domain Mode toggle (premium) -->
<script type="text/javascript">
  function initializeDomainModeToggle() {
    const radioSub = document.getElementById('host_type_subdomain');
    const radioCustom = document.getElementById('host_type_custom');
    const subGroup = document.getElementById('subdomain-input-group');
    const customGroup = document.getElementById('customdomain-input-group');
    const canonicalSection = document.getElementById('canonical-preference-section');

    if (!radioSub || !radioCustom || !subGroup || !customGroup) return;

    function updateVisibility() {
      if (radioSub.checked) {
        subGroup.style.display = '';
        customGroup.style.display = 'none';
        if (canonicalSection) canonicalSection.style.display = 'none';
      } else {
        subGroup.style.display = 'none';
        customGroup.style.display = '';
        if (canonicalSection) canonicalSection.style.display = '';
      }
    }

    // Update domain previews when custom domain input changes
    function updateDomainPreviews() {
      const customDomainInput = document.getElementById('display_hostname');
      if (!customDomainInput || !canonicalSection) return;

      const domainValue = customDomainInput.value.trim();
      const cleanDomain = domainValue.replace(/^www\./, '') || 'yourdomain.com';
      
      // Update preview domains
      const wwwPreview = document.getElementById('www-domain-preview');
      const apexPreview = document.getElementById('apex-domain-preview');
      const fromDomain = document.getElementById('from-domain');
      const toDomain = document.getElementById('to-domain');
      
      if (wwwPreview) wwwPreview.textContent = `www.${cleanDomain}`;
      if (apexPreview) apexPreview.textContent = cleanDomain;
      
      // Update redirect explanation based on current preference
      const wwwRadio = document.querySelector('input[name="business[canonical_preference]"][value="www"]');
      if (fromDomain && toDomain && wwwRadio) {
        if (wwwRadio.checked) {
          fromDomain.textContent = cleanDomain;
          toDomain.textContent = `www.${cleanDomain}`;
        } else {
          fromDomain.textContent = `www.${cleanDomain}`;
          toDomain.textContent = cleanDomain;
        }
      }
    }

    // Update redirect explanation when preference changes
    function updateRedirectExplanation() {
      const customDomainInput = document.getElementById('display_hostname');
      if (!customDomainInput) return;

      const domainValue = customDomainInput.value.trim();
      const cleanDomain = domainValue.replace(/^www\./, '') || 'yourdomain.com';
      
      const fromDomain = document.getElementById('from-domain');
      const toDomain = document.getElementById('to-domain');
      const wwwRadio = document.querySelector('input[name="business[canonical_preference]"][value="www"]');
      
      if (fromDomain && toDomain && wwwRadio) {
        if (wwwRadio.checked) {
          fromDomain.textContent = cleanDomain;
          toDomain.textContent = `www.${cleanDomain}`;
        } else {
          fromDomain.textContent = `www.${cleanDomain}`;
          toDomain.textContent = cleanDomain;
        }
      }
    }

    radioSub.addEventListener('change', updateVisibility);
    radioCustom.addEventListener('change', updateVisibility);
    
    // Listen for custom domain input changes
    const customDomainInput = document.getElementById('display_hostname');
    if (customDomainInput) {
      customDomainInput.addEventListener('input', updateDomainPreviews);
      customDomainInput.addEventListener('blur', updateDomainPreviews);
    }
    
    // Listen for canonical preference changes
    const canonicalRadios = document.querySelectorAll('input[name="business[canonical_preference]"]');
    canonicalRadios.forEach(radio => {
      radio.addEventListener('change', updateRedirectExplanation);
    });
    
    updateVisibility();
    updateDomainPreviews();
  }

  document.addEventListener('DOMContentLoaded', initializeDomainModeToggle);
  document.addEventListener('turbo:load', initializeDomainModeToggle);
</script>
<!-- Subdomain Availability Checker -->
<script type="text/javascript">
  function initializeSubdomainChecker() {
    const subdomainInput = document.getElementById('display_subdomain');
    const customDomainInput = document.getElementById('display_hostname');
    const subdomainRadio = document.getElementById('host_type_subdomain');
    
    if (!subdomainInput || !subdomainRadio) return;
    
    let checkTimeout;
    let lastCheckedValue = '';
    
    function showValidationMessage(input, message, type = 'error') {
      // Remove existing validation messages
      const existingMessage = input.parentNode.querySelector('.subdomain-validation');
      if (existingMessage) {
        existingMessage.remove();
      }

      if (!message) return;

      const messageDiv = document.createElement('div');
      messageDiv.className = `subdomain-validation text-xs mt-1 ${type === 'success' ? 'text-success' : type === 'warning' ? 'text-yellow-600' : 'text-red-600'}`;

      // SECURITY FIX (Alert #26 - CWE-79): Use textContent instead of innerHTML
      // This prevents XSS attacks by treating the message as plain text only.
      // Validation messages don't need HTML rendering - they're all plain text.
      messageDiv.textContent = message;

      input.parentNode.appendChild(messageDiv);
    }
    
    function validateSubdomainFormat(subdomain) {
      if (!subdomain) return { valid: false, message: '' };
      
      // Check length (3-63 characters)
      if (subdomain.length < 3) {
        return { valid: false, message: 'Subdomain must be at least 3 characters long' };
      }
      if (subdomain.length > 63) {
        return { valid: false, message: 'Subdomain must be 63 characters or less' };
      }
      
      // Check format: alphanumeric and hyphens, no hyphens at start/end
      const validFormat = /^[a-z0-9]([a-z0-9-]*[a-z0-9])?$/.test(subdomain);
      if (!validFormat) {
        return { valid: false, message: 'Only lowercase letters, numbers, and hyphens allowed. Cannot start or end with hyphen' };
      }
      
      // Check for reserved words
      const reserved = ['www', 'mail', 'ftp', 'admin', 'root', 'api', 'app', 'support', 'help', 'blog', 'shop', 'store'];
      if (reserved.includes(subdomain.toLowerCase())) {
        return { valid: false, message: 'This subdomain is reserved and cannot be used' };
      }
      
      return { valid: true, message: '' };
    }
    
    async function checkSubdomainAvailability(subdomain) {
      try {
        const url = '<%= check_subdomain_availability_business_manager_settings_business_path %>?subdomain=' + encodeURIComponent(subdomain);
        const response = await fetch(url, {
          method: 'GET',
          headers: { 'Accept': 'application/json' }
        });
        
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Error checking subdomain availability:', error);
        return { available: false, message: 'Unable to check availability. Please try again.' };
      }
    }
    
    function handleSubdomainCheck() {
      const currentValue = subdomainInput.value.toLowerCase().trim();
      
      // Skip if value hasn't changed or is empty
      if (currentValue === lastCheckedValue || !currentValue) {
        if (!currentValue) showValidationMessage(subdomainInput, '');
        return;
      }
      
      lastCheckedValue = currentValue;
      
      // Format validation first
      const formatCheck = validateSubdomainFormat(currentValue);
      if (!formatCheck.valid) {
        showValidationMessage(subdomainInput, formatCheck.message, 'error');
        return;
      }
      
      // Show checking message
      showValidationMessage(subdomainInput, '⏳ Checking availability...', 'warning');
      
      // Check availability
      checkSubdomainAvailability(currentValue).then(result => {
        if (result.available) {
          showValidationMessage(subdomainInput, '✅ Available! Will appear as ' + currentValue + '.bizblasts.com', 'success');
        } else {
          showValidationMessage(subdomainInput, '❌ ' + (result.message || 'This subdomain is not available'), 'error');
        }
      });
    }
    
    // Add event listeners
    subdomainInput.addEventListener('input', function() {
      // Only check if subdomain radio is selected
      if (!subdomainRadio.checked) return;
      
      clearTimeout(checkTimeout);
      checkTimeout = setTimeout(handleSubdomainCheck, 500); // Debounce 500ms
    });
    
    subdomainInput.addEventListener('blur', function() {
      // Only check if subdomain radio is selected
      if (!subdomainRadio.checked) return;
      
      clearTimeout(checkTimeout);
      handleSubdomainCheck();
    });
    
    // Clear validation when switching away from subdomain
    subdomainRadio.addEventListener('change', function() {
      if (!this.checked) {
        showValidationMessage(subdomainInput, '');
      }
    });
    
    // Trigger check on radio button change if there's already a value
    subdomainRadio.addEventListener('change', function() {
      if (this.checked && subdomainInput.value.trim()) {
        lastCheckedValue = ''; // Reset to force check
        handleSubdomainCheck();
      }
    });
  }
  
  // Set the URL for the domain status checker
  window.domainStatusCheckUrl = '<%= check_domain_status_business_manager_settings_business_path %>';
  window.finalizeDomainActivationUrl = '<%= finalize_domain_activation_business_manager_settings_business_path %>';
  window.domainIsActive = <%= @business.custom_domain_allow? ? 'true' : 'false' %>;
  
  // Initialize domain status checker on page load
  function initializeDomainStatusChecker() {
    const isActive = <%= @business.custom_domain_allow? %>;
    if (typeof window.initializeDomainStatusChecker === 'function') {
      window.initializeDomainStatusChecker(isActive);
    }
  }
  
  document.addEventListener('DOMContentLoaded', initializeSubdomainChecker);
  document.addEventListener('turbo:load', initializeSubdomainChecker);
  document.addEventListener('DOMContentLoaded', initializeDomainStatusChecker);
  document.addEventListener('turbo:load', initializeDomainStatusChecker);
</script>

 