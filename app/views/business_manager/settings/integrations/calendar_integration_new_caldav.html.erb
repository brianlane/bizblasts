<%# Calendar Integration CalDAV Setup Form %>
<div class="container mx-auto px-4 py-4 sm:py-8">
  <!-- Header Section -->
  <div class="bg-white shadow-lg rounded-xl overflow-hidden border border-gray-100 mb-8">
    <div class="bg-gradient-to-r from-orange-600 to-orange-700 px-4 py-6 sm:px-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-gradient-to-br from-white/20 to-white/10 backdrop-blur-sm rounded-lg flex items-center justify-center text-white border border-white/30">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-xl sm:text-2xl font-bold text-white">
              iCloud, Nextcloud, etc. (CalDAV)
            </h1>
            <p class="text-orange-100 text-sm mt-1">
              Set up calendar sync for <%= @staff_member.name %>
            </p>
          </div>
        </div>
        
        <%= link_to business_manager_settings_integrations_path,
              class: "inline-flex items-center justify-center px-4 py-2 bg-white/10 backdrop-blur-sm border border-white/20 text-sm font-medium rounded-lg text-white hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white/50 focus:ring-offset-2 focus:ring-offset-orange-600 transition-all duration-200" do %>
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          Back to Integrations
        <% end %>
      </div>
    </div>
  </div>

  <!-- CalDAV Setup Form -->
  <div class="bg-white shadow-lg rounded-xl overflow-hidden border border-gray-100">
    <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">CalDAV Connection Setup</h2>
      <p class="text-sm text-gray-600 mt-1">Enter your calendar server details</p>
    </div>
    
    <div class="p-6">
      <%= form_with model: @calendar_connection, 
                    url: calendar_integration_create_caldav_business_manager_settings_integrations_path, 
                    method: :post, 
                    local: true, 
                    class: "space-y-6" do |form| %>
        
        <%= hidden_field_tag :staff_member_id, @staff_member.id %>
        
        <!-- Provider Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Calendar Provider</label>
          <%= render 'shared/rich_dropdown',
                     collection: @caldav_providers.map { |p| OpenStruct.new(id: p[:id], name: p[:name], description: p[:description]) },
                     field_name: 'calendar_connection[caldav_provider]',
                     selected_value: @calendar_connection.caldav_provider,
                     prompt_text: 'Select your calendar provider...',
                     value_method: :id,
                     text_method: :name,
                     description_method: :description,
                     dropdown_id: 'caldav_provider_dropdown',
                     css_class: 'w-full' %>
          <p class="mt-1 text-sm text-gray-600">Choose your calendar service provider from the list</p>
        </div>
        
        <!-- Provider-specific instructions -->
        <% @caldav_providers.each do |provider| %>
          <div id="<%= provider[:id] %>-instructions" class="provider-instructions hidden">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h3 class="font-medium text-blue-900 mb-2"><%= provider[:name] %> Setup Instructions</h3>
              <ol class="list-decimal list-inside space-y-1 text-sm text-blue-800">
                <% if provider[:setup_instructions] %>
                  <% provider[:setup_instructions].each do |instruction| %>
                    <li><%= instruction.html_safe %></li>
                  <% end %>
                <% end %>
              </ol>
            </div>
          </div>
        <% end %>

        <!-- Connection Details -->
        <div class="connection-fields">
          <div class="form-group" id="server-url-field">
            <label class="block text-sm font-medium text-gray-700 mb-2">Server URL</label>
            <%= form.url_field :caldav_url, 
                               id: 'calendar_connection_caldav_url',
                               placeholder: "https://caldav.example.com/calendars/",
                               class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500" %>
            <p class="mt-1 text-sm text-gray-600">Full URL to your CalDAV server (leave blank for iCloud)</p>
          </div>

          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">Username/Email</label>
            <%= form.text_field :caldav_username, 
                                id: 'calendar_connection_caldav_username',
                                placeholder: "your-email@example.com",
                                required: true,
                                class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500" %>
          </div>
          
          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
            <%= form.password_field :caldav_password, 
                                   id: 'calendar_connection_caldav_password',
                                   placeholder: "Your password or app-specific password",
                                   required: true,
                                   class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500" %>
            <p class="mt-1 text-sm text-gray-600">For security, use app-specific passwords when available.</p>
          </div>
        </div>

        <!-- Test Connection Button -->
        <div class="border-t border-gray-200 pt-6">
          <div class="flex items-center justify-between">
            <button type="button" 
                    id="test-connection-btn"
                    class="cursor-pointer px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
              Test Connection
            </button>
            <div id="test-result" class="text-sm"></div>
          </div>
        </div>

        <!-- Error Display -->
        <% if @calendar_connection.errors.any? %>
          <div class="rounded-md bg-red-50 p-4 border border-red-200">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">Connection Error</h3>
                <div class="mt-2 text-sm text-red-700">
                  <ul class="list-disc pl-5 space-y-1">
                    <% @calendar_connection.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <!-- Form Actions -->
        <div class="flex items-center justify-end space-x-4 pt-6 border-t border-gray-200">
          <%= link_to "Cancel", business_manager_settings_integrations_path, 
                      class: "cursor-pointer px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2" %>
          
          <%= form.submit "Connect Calendar", 
                          class: "cursor-pointer px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-lg hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed",
                          id: "submit-btn" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Provider Setup Instructions -->
  <div class="bg-white shadow-lg rounded-xl overflow-hidden border border-gray-100 mt-8">
    <div class="px-6 py-4 bg-gradient-to-r from-blue-50 to-blue-100 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">Setup Instructions</h3>
    </div>
    
    <div class="p-6">
      <div class="space-y-6">
        <!-- iCloud Instructions -->
        <div class="border border-gray-200 rounded-lg p-4">
          <h4 class="font-medium text-gray-900 mb-2">iCloud Calendar</h4>
          <div class="text-sm text-gray-600 space-y-2">
            <p><strong>Server URL:</strong> https://caldav.icloud.com/</p>
            <p><strong>Username:</strong> Your Apple ID email</p>
            <p><strong>Password:</strong> App-specific password (recommended)</p>
            <p class="text-xs text-gray-500">Note: Generate an app-specific password at appleid.apple.com for better security</p>
          </div>
        </div>

        <!-- Nextcloud Instructions -->
        <div class="border border-gray-200 rounded-lg p-4">
          <h4 class="font-medium text-gray-900 mb-2">Nextcloud</h4>
          <div class="text-sm text-gray-600 space-y-2">
            <p><strong>Server URL:</strong> https://your-nextcloud.com/remote.php/dav/calendars/USERNAME/</p>
            <p><strong>Username:</strong> Your Nextcloud username</p>
            <p><strong>Password:</strong> Your Nextcloud password or app password</p>
          </div>
        </div>

        <!-- Generic CalDAV Instructions -->
        <div class="border border-gray-200 rounded-lg p-4">
          <h4 class="font-medium text-gray-900 mb-2">Other CalDAV Servers</h4>
          <div class="text-sm text-gray-600 space-y-2">
            <p>Contact your calendar service provider for the specific CalDAV server URL and authentication details.</p>
            <p>Most providers support CalDAV and will provide documentation for setup.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .hidden { 
    display: none !important; 
  }
  
  .form-group { 
    margin-bottom: 1.5rem; 
  }
  
  .provider-instructions { 
    margin-bottom: 1.5rem; 
  }
</style>

<script>
  // Provider-specific configuration
  const providerConfigs = {
    icloud: {
      requires_url: false,
      url_placeholder: '',
      username_placeholder: 'your-email@icloud.com'
    },
    nextcloud: {
      requires_url: true,
      url_placeholder: 'https://your-nextcloud.com/remote.php/dav/calendars/USERNAME/',
      username_placeholder: 'your-username'
    },
    generic: {
      requires_url: true,
      url_placeholder: 'https://caldav.server.com/path/',
      username_placeholder: 'your-email@provider.com'
    }
  };

  function updateCalDAVForm(providerId) {
    // Hide all instruction boxes
    document.querySelectorAll('.provider-instructions').forEach(el => {
      el.classList.add('hidden');
    });
    
    // Show selected provider instructions
    if (providerId) {
      const instructionsEl = document.getElementById(providerId + '-instructions');
      if (instructionsEl) {
        instructionsEl.classList.remove('hidden');
      }
      
      // Update form fields based on provider
      const config = providerConfigs[providerId];
      if (config) {
        const urlField = document.getElementById('calendar_connection_caldav_url');
        const serverUrlField = document.getElementById('server-url-field');
        const usernameField = document.getElementById('calendar_connection_caldav_username');
        
        if (urlField) {
          urlField.placeholder = config.url_placeholder;
          if (!config.requires_url) {
            urlField.value = '';
            serverUrlField.style.display = 'none';
          } else {
            serverUrlField.style.display = 'block';
          }
        }
        
        if (usernameField) {
          usernameField.placeholder = config.username_placeholder;
        }
      }
    }
  }

  function testConnection() {
    const testBtn = document.getElementById('test-connection-btn');
    const resultsDiv = document.getElementById('test-result');
    const submitBtn = document.getElementById('submit-btn');
    
    // Get form data
    const username = document.getElementById('calendar_connection_caldav_username').value;
    const password = document.getElementById('calendar_connection_caldav_password').value;
    const url = document.getElementById('calendar_connection_caldav_url').value;
    const providerType = document.getElementById('caldav_provider_dropdown_hidden').value;
    
    // Validate required fields
    if (!username || !password) {
      showTestResult('Please enter username and password', false);
      return;
    }
    
    if (providerType !== 'icloud' && !url) {
      showTestResult('Please enter server URL', false);
      return;
    }
    
    // Disable button and show loading
    testBtn.disabled = true;
    testBtn.textContent = 'Testing...';
    showTestResult('Testing connection...', null);
    
    // Make test request
    fetch('<%= calendar_integration_test_caldav_business_manager_settings_integrations_path %>', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({
        username: username,
        password: password,
        url: url,
        provider_type: providerType
      })
    })
    .then(response => response.json())
    .then(data => {
      showTestResult(data.message, data.success);
      if (data.success) {
        submitBtn.disabled = false;
      }
    })
    .catch(error => {
      showTestResult('Connection test failed: ' + error.message, false);
    })
    .finally(() => {
      testBtn.disabled = false;
      testBtn.textContent = 'Test Connection';
    });
  }
  
  function showTestResult(message, success) {
    const resultsDiv = document.getElementById('test-result');
    resultsDiv.textContent = message;
    resultsDiv.className = 'mt-2 p-3 rounded-lg text-sm';
    
    if (success === true) {
      resultsDiv.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-200');
    } else if (success === false) {
      resultsDiv.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-200');
    } else {
      resultsDiv.classList.add('bg-blue-100', 'text-blue-700', 'border', 'border-blue-200');
    }
  }
  
  // Initialize form on page load and listen for dropdown changes
  function initializeCalDAVForm() {
    const hiddenField = document.getElementById('caldav_provider_dropdown_hidden');
    const submitBtn = document.getElementById('submit-btn');
    
    if (submitBtn) {
      submitBtn.disabled = true; // Initially disable submit until connection is tested
    }
    
    if (hiddenField) {
      // Initialize with current value
      if (hiddenField.value) {
        updateCalDAVForm(hiddenField.value);
      }
      
      // Listen for changes
      hiddenField.addEventListener('change', function() {
        updateCalDAVForm(this.value);
      });
    }

    // Add click handler for test button
    const testBtn = document.getElementById('test-connection-btn');
    if (testBtn) {
      testBtn.addEventListener('click', testConnection);
    }
  }
  
  document.addEventListener('DOMContentLoaded', initializeCalDAVForm);
  document.addEventListener('turbo:load', initializeCalDAVForm);
  document.addEventListener('turbo:render', initializeCalDAVForm);
</script>