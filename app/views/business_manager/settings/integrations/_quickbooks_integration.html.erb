<%# QuickBooks Online Integration Partial %>
<div class="border border-gray-200 rounded-xl overflow-hidden">
  <div class="px-5 py-4 bg-gradient-to-r from-sky-50 to-sky-100 border-b border-gray-200">
    <h3 class="text-base font-semibold text-gray-900 flex items-center">
      <svg class="w-5 h-5 mr-2 text-sky-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
      </svg>
      QuickBooks Online
    </h3>
    <p class="text-sm text-gray-700 mt-1">Connect QuickBooks to export invoices and accounting data.</p>
  </div>
  <div class="p-5">
    <% if quickbooks_connection&.active? %>
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="inline-flex items-center px-3 py-1 rounded-full bg-green-100 text-green-800 text-xs font-medium">Connected</div>
          <p class="text-sm text-gray-800 mt-3">
            <span class="font-medium">Realm ID:</span>
            <span class="font-mono"><%= quickbooks_connection.realm_id %></span>
          </p>
          <% if quickbooks_connection.connected_at %>
            <p class="text-sm text-gray-600 mt-1">Connected: <%= quickbooks_connection.connected_at.strftime('%b %d, %Y') %></p>
          <% end %>
        </div>
        <div class="flex-shrink-0">
          <%= button_to "Disconnect",
                        quickbooks_disconnect_business_manager_settings_integrations_path,
                        method: :delete,
                        class: "cursor-pointer px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",
                        data: { turbo_confirm: "Disconnect QuickBooks? Exports will stop working until reconnected." } %>
        </div>
      </div>

      <div class="mt-6 border-t border-gray-200 pt-5">
        <h4 class="text-sm font-medium text-gray-900">Settings</h4>
        <p class="text-xs text-gray-600 mt-1">These control how exports are created in QuickBooks.</p>

        <%= form_with url: quickbooks_config_update_business_manager_settings_integrations_path, method: :patch, local: true do |f| %>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
            <div>
              <%= label_tag "quickbooks_income_account_id", "Income account ID (optional)", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= text_field_tag "quickbooks[income_account_id]", quickbooks_connection.config['income_account_id'], id: "quickbooks_income_account_id", class: "w-full border rounded px-3 py-2" %>
              <p class="mt-1 text-xs text-gray-500">If blank, we auto-pick the first Income account.</p>
            </div>
            <div>
              <%= label_tag "quickbooks_default_sales_item_name", "Default item name", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= text_field_tag "quickbooks[default_sales_item_name]", (quickbooks_connection.config['default_sales_item_name'].presence || 'BizBlasts Sales'), id: "quickbooks_default_sales_item_name", class: "w-full border rounded px-3 py-2" %>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
            <div>
              <%= label_tag "quickbooks_customer_strategy", "Customer strategy", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= select_tag "quickbooks[customer_strategy]",
                             options_for_select([['One customer per BizBlasts customer', 'per_customer'], ['Single customer for all sales', 'single']], quickbooks_connection.config.fetch('customer_strategy', 'per_customer')),
                             id: "quickbooks_customer_strategy",
                             class: "w-full border rounded px-3 py-2" %>
            </div>
            <div class="flex items-center gap-2 mt-6 sm:mt-0">
              <%= hidden_field_tag "quickbooks[update_existing_invoices]", "0" %>
              <%= check_box_tag "quickbooks[update_existing_invoices]", "1", (quickbooks_connection.config['update_existing_invoices'] == true), class: "h-4 w-4 text-sky-700 rounded" %>
              <%= label_tag "quickbooks_update_existing_invoices", "Update existing invoices (idempotent)", class: "text-sm text-gray-700" %>
            </div>
          </div>

          <div class="mt-4">
            <%= submit_tag "Save QuickBooks Settings", class: "cursor-pointer px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-black" %>
          </div>
        <% end %>
      </div>

      <div class="mt-6 border-t border-gray-200 pt-5">
        <h4 class="text-sm font-medium text-gray-900">Export invoices</h4>
        <p class="text-xs text-gray-600 mt-1">Exports invoices (and optionally payments) to QuickBooks. Uses DocNumber for idempotency.</p>

        <%= form_with url: quickbooks_export_invoices_business_manager_settings_integrations_path, method: :post, local: true do |f| %>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
            <div>
              <%= label_tag :range_start, "Start date", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= date_field_tag :range_start, 7.days.ago.to_date.iso8601, class: "w-full border rounded px-3 py-2" %>
            </div>
            <div>
              <%= label_tag :range_end, "End date", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= date_field_tag :range_end, Date.current.iso8601, class: "w-full border rounded px-3 py-2" %>
            </div>
          </div>

          <div class="mt-4">
            <div class="text-sm font-medium text-gray-700 mb-2">Invoice statuses</div>
            <div class="flex flex-wrap gap-4">
              <% %w[paid pending].each do |st| %>
                <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                  <input type="checkbox" name="invoice_statuses[]" value="<%= st %>" <%= 'checked' if st == 'paid' %> class="h-4 w-4 text-sky-700 rounded" />
                  <span><%= st.humanize %></span>
                </label>
              <% end %>
            </div>
          </div>

          <div class="mt-4">
            <label class="inline-flex items-center gap-2 text-sm text-gray-700">
              <%= check_box_tag :export_payments, "1", true, class: "h-4 w-4 text-sky-700 rounded" %>
              <span>Also export payments for paid invoices</span>
            </label>
          </div>

          <div class="mt-4">
            <%= submit_tag "Start Export", class: "cursor-pointer px-4 py-2 bg-sky-700 text-white rounded-lg hover:bg-sky-800" %>
          </div>
        <% end %>
      </div>

      <div class="mt-6 border-t border-gray-200 pt-5">
        <h4 class="text-sm font-medium text-gray-900">Recent exports</h4>
        <% if quickbooks_export_runs.any? %>
          <div class="mt-3 overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-left text-gray-600">
                  <th class="py-2 pr-4">Created</th>
                  <th class="py-2 pr-4">Range</th>
                  <th class="py-2 pr-4">Status</th>
                  <th class="py-2">Result</th>
                  <th class="py-2 pl-4">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                <% quickbooks_export_runs.each do |run| %>
                  <tr>
                    <td class="py-2 pr-4 whitespace-nowrap"><%= run.created_at.strftime('%b %d, %Y %H:%M') %></td>
                    <td class="py-2 pr-4 whitespace-nowrap">
                      <%= run.filters['range_start'] %> → <%= run.filters['range_end'] %>
                    </td>
                    <td class="py-2 pr-4">
                      <% badge = case run.status
                                when 'succeeded' then 'bg-green-100 text-green-800'
                                when 'partial' then 'bg-yellow-100 text-yellow-800'
                                when 'failed' then 'bg-red-100 text-red-800'
                                when 'running' then 'bg-blue-100 text-blue-800'
                                else 'bg-gray-100 text-gray-800'
                                end %>
                      <span class="px-2 py-1 rounded-full text-xs font-medium <%= badge %>"><%= run.status.humanize %></span>
                    </td>
                    <td class="py-2">
                      <% if run.summary.present? && run.summary['exported'] %>
                        <span class="text-gray-700"><%= run.summary['exported'] %> exported</span>
                        <% if run.summary['failed'].to_i > 0 %>
                          <span class="text-red-700">, <%= run.summary['failed'] %> failed</span>
                        <% end %>
                        <% if run.summary['payments_exported'].to_i > 0 || run.summary['payments_failed'].to_i > 0 %>
                          <span class="text-gray-700"> · payments: <%= run.summary['payments_exported'].to_i %> ok</span>
                          <% if run.summary['payments_failed'].to_i > 0 %>
                            <span class="text-red-700">, <%= run.summary['payments_failed'].to_i %> failed</span>
                          <% end %>
                        <% end %>
                      <% else %>
                        <span class="text-gray-400">—</span>
                      <% end %>
                    </td>
                    <td class="py-2 pl-4">
                      <% if run.error_report.present? && run.error_report['failures'].present? %>
                        <%= button_to "Retry failed",
                                      quickbooks_export_retry_failed_business_manager_settings_integrations_path(id: run.id),
                                      method: :post,
                                      class: "cursor-pointer px-3 py-1 text-xs bg-gray-600 text-white rounded hover:bg-gray-700" %>
                      <% else %>
                        <span class="text-gray-400 text-xs">—</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <p class="text-sm text-gray-600 mt-2">No QuickBooks exports yet.</p>
        <% end %>
      </div>
    <% else %>
      <p class="text-sm text-gray-700">Not connected.</p>
      <div class="mt-4">
        <%= link_to "Connect QuickBooks",
                    quickbooks_oauth_authorize_business_manager_settings_integrations_path,
                    class: "inline-flex items-center justify-center px-4 py-2 bg-sky-700 text-white rounded-lg hover:bg-sky-800",
                    data: { turbo: false } %>
      </div>
      <p class="text-xs text-gray-500 mt-3">If this button fails, QuickBooks OAuth credentials may not be configured.</p>
    <% end %>
  </div>
</div>
