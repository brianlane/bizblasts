<%# Estimate item fields partial - used for both existing and new items %>
<%# Variables: item (form builder), services, products, is_template (boolean) %>

<tr data-estimate-line-items-target="item" class="<%= item.object.customer_declined? ? 'bg-gray-50 opacity-60' : '' %>">
  <!-- Item Type -->
  <td class="px-4 py-3">
    <%= item.select :item_type,
      options_for_select([
        ['Service', 'service'],
        ['Product', 'product'],
        ['Labor', 'labor'],
        ['Part', 'part']
      ], item.object.item_type || 'service'),
      {},
      class: 'block w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm',
      data: { action: 'change->estimate-line-items#changeItemType' } %>
  </td>

  <!-- Service/Product Selection -->
  <td class="px-4 py-3">
    <!-- Service Select (shown for service type) -->
    <div data-field-type="service" class="<%= item.object.item_type != 'service' ? 'hidden' : '' %>">
      <%= item.select :service_id,
        [['-- Select Service --', '']] + (@services || []).map { |s| [s.name, s.id, { 'data-price' => s.price, 'data-description' => s.description }] },
        { selected: item.object.service_id },
        { class: 'block w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm',
          data: { action: 'change->estimate-line-items#selectService' } } %>
    </div>

    <!-- Product Select (shown for product type) -->
    <div data-field-type="product" class="<%= item.object.item_type != 'product' ? 'hidden' : '' %>">
      <%= item.select :product_id,
        [['-- Select Product --', '']] + (@products || []).map { |p| [p.name, p.id, { 'data-price' => p.price, 'data-description' => p.description }] },
        { selected: item.object.product_id },
        { class: 'block w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm',
          data: { action: 'change->estimate-line-items#selectProduct' } } %>
    </div>

    <!-- Labor Fields (shown for labor type) -->
    <div data-field-type="labor" class="<%= item.object.item_type != 'labor' ? 'hidden' : '' %>">
      <div class="grid grid-cols-2 gap-2">
        <div>
          <label class="block text-xs text-gray-500">Hours</label>
          <%= item.number_field :hours, step: 0.5, min: 0,
            class: 'block w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm',
            placeholder: 'Hours',
            data: { action: 'input->estimate-line-items#calculateLaborTotal' } %>
        </div>
        <div>
          <label class="block text-xs text-gray-500">Rate/Hr</label>
          <%= item.number_field :hourly_rate, step: 0.01, min: 0,
            class: 'block w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm',
            placeholder: '$/hr',
            data: { action: 'input->estimate-line-items#calculateLaborTotal' } %>
        </div>
      </div>
    </div>
  </td>

  <!-- Description -->
  <td class="px-4 py-3">
    <%= item.text_field :description,
      class: 'block w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm',
      placeholder: 'Description',
      data: { action: 'input->estimate-line-items#inputChanged' } %>
  </td>

  <!-- Qty (hidden for labor) -->
  <td class="px-4 py-3">
    <div data-field-type="standard" class="<%= item.object.item_type == 'labor' ? 'hidden' : '' %>">
      <%= item.number_field :qty, min: 1, value: item.object.qty || 1,
        class: 'block w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm',
        placeholder: '1',
        data: { action: 'input->estimate-line-items#inputChanged' } %>
    </div>
  </td>

  <!-- Rate (shown for non-labor) -->
  <td class="px-4 py-3">
    <div data-field-type="standard" class="<%= item.object.item_type == 'labor' ? 'hidden' : '' %>">
      <%= item.number_field :cost_rate, step: 0.01, min: 0,
        class: 'block w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm',
        placeholder: '0.00',
        data: { action: 'input->estimate-line-items#inputChanged' } %>
    </div>
  </td>

  <!-- Tax Rate -->
  <td class="px-4 py-3">
    <%= item.number_field :tax_rate, step: 0.01, min: 0, value: item.object.tax_rate || 0,
      class: 'block w-full px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm',
      placeholder: '0',
      data: { action: 'input->estimate-line-items#inputChanged' } %>
  </td>

  <!-- Optional -->
  <td class="px-4 py-3 text-center">
    <label class="inline-flex items-center">
      <%= item.check_box :optional,
        class: 'h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500',
        data: { action: 'change->estimate-line-items#inputChanged' } %>
    </label>
  </td>

  <!-- Line Total -->
  <td class="px-4 py-3 text-right">
    <span data-estimate-line-items-target="itemTotal" class="font-medium text-gray-900">
      <%= number_to_currency(item.object.total_with_tax || 0) %>
    </span>
  </td>

  <!-- Actions -->
  <td class="px-4 py-3 text-center">
    <button type="button"
      data-action="estimate-line-items#removeItem"
      class="text-red-600 hover:text-red-800">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
      </svg>
    </button>
    <%= item.hidden_field :_destroy %>
    <%= item.hidden_field :position %>
  </td>
</tr>

<!-- Save for Future Use Section (for labor and part items) -->
<% if item.object.item_type == 'labor' || item.object.item_type == 'part' %>
<tr data-field-type="save-for-future" class="bg-blue-50">
  <td colspan="9" class="px-4 py-3">
    <% if item.object.item_type == 'labor' %>
      <!-- Save as Service -->
      <div class="flex items-start space-x-4">
        <label class="inline-flex items-center mt-1">
          <%= item.check_box :save_as_service,
            class: 'h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500',
            data: { action: 'change->estimate-line-items#toggleSaveForFuture' } %>
          <span class="ml-2 text-sm font-medium text-gray-700">Save as Service</span>
        </label>
        <div data-field-type="save-service-fields" class="hidden flex-1">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-medium text-gray-600">Service Type *</label>
              <%= item.select :service_type,
                options_for_select([
                  ['Standard', 'standard'],
                  ['Experience', 'experience'],
                  ['Event', 'event']
                ], item.object.service_type),
                { include_blank: '-- Select Type --' },
                { class: 'block w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm' } %>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600">Service Name *</label>
              <%= item.text_field :service_name,
                class: 'block w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm',
                placeholder: 'Enter service name' %>
            </div>
          </div>
          <p class="mt-1 text-xs text-gray-500">
            Service will be created when estimate is saved. Duration and price auto-calculated from hours and rate.
          </p>
        </div>
      </div>
    <% elsif item.object.item_type == 'part' %>
      <!-- Save as Product -->
      <div class="flex items-start space-x-4">
        <label class="inline-flex items-center mt-1">
          <%= item.check_box :save_as_product,
            class: 'h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500',
            data: { action: 'change->estimate-line-items#toggleSaveForFuture' } %>
          <span class="ml-2 text-sm font-medium text-gray-700">Save as Product</span>
        </label>
        <div data-field-type="save-product-fields" class="hidden flex-1">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-medium text-gray-600">Product Type *</label>
              <%= item.select :product_type,
                options_for_select([
                  ['Standard', 'standard'],
                  ['Service Product', 'service'],
                  ['Mixed', 'mixed']
                ], item.object.product_type),
                { include_blank: '-- Select Type --' },
                { class: 'block w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm' } %>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600">Product Name *</label>
              <%= item.text_field :product_name,
                class: 'block w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm',
                placeholder: 'Enter product name' %>
            </div>
          </div>
          <p class="mt-1 text-xs text-gray-500">
            Product will be created when estimate is saved. Price auto-set from cost rate.
          </p>
        </div>
      </div>
    <% end %>
  </td>
</tr>
<% end %>

