<% content_for :title, "Estimate #{@estimate.estimate_number || "##{@estimate.id}"}" %>

<div class="container mx-auto px-4 py-6">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h1 class="text-2xl font-bold">Estimate <%= @estimate.estimate_number || "##{@estimate.id}" %></h1>
      <p class="text-sm text-gray-500">
        Version <%= @estimate.current_version %> of <%= @estimate.total_versions %>
        <% if @estimate.total_versions > 1 %>
          â€¢
          <%= link_to "View history", versions_business_manager_estimate_path(@estimate), class: "text-blue-600 hover:text-blue-800" %>
        <% end %>
      </p>
    </div>
    <div class="flex flex-wrap gap-2">
      <%= link_to edit_business_manager_estimate_path(@estimate),
        class: 'inline-flex items-center px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700' do %>
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
        </svg>
        Edit
      <% end %>

      <%= button_to duplicate_business_manager_estimate_path(@estimate),
        method: :post,
        data: { turbo_confirm: 'Create a copy of this estimate?' },
        class: 'inline-flex items-center px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 cursor-pointer' do %>
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
        </svg>
        Duplicate
      <% end %>

      <%= link_to download_pdf_business_manager_estimate_path(@estimate),
        class: 'inline-flex items-center px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700' do %>
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
        </svg>
        PDF
      <% end %>

      <% if @estimate.total_versions > 1 %>
        <%= link_to versions_business_manager_estimate_path(@estimate),
          class: 'inline-flex items-center px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700' do %>
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          History (<%= @estimate.total_versions %>)
        <% end %>
      <% end %>

      <% if @estimate.draft? %>
        <%= button_to send_to_customer_business_manager_estimate_path(@estimate),
          method: :patch,
          data: { turbo_confirm: 'Send this estimate to the customer?' },
          class: 'inline-flex items-center px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 cursor-pointer' do %>
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
          Send to Customer
        <% end %>
      <% elsif @estimate.sent? || @estimate.viewed? %>
        <%= button_to resend_to_customer_business_manager_estimate_path(@estimate),
          method: :patch,
          data: { turbo_confirm: 'Resend this estimate to the customer?' },
          class: 'inline-flex items-center px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 cursor-pointer' do %>
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          Resend to Customer
        <% end %>
      <% end %>

      <%= button_to business_manager_estimate_path(@estimate),
        method: :delete,
        data: { turbo_confirm: 'Are you sure you want to delete this estimate?' },
        class: 'inline-flex items-center px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 cursor-pointer' do %>
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
        Delete
      <% end %>
    </div>
  </div>

  <!-- Status Badge -->
  <div class="mb-6">
    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
      <%= case @estimate.status
          when 'draft' then 'bg-gray-100 text-gray-800'
          when 'sent' then 'bg-blue-100 text-blue-800'
          when 'viewed' then 'bg-yellow-100 text-yellow-800'
          when 'pending_payment' then 'bg-orange-100 text-orange-800'
          when 'approved' then 'bg-green-100 text-green-800'
          when 'declined' then 'bg-red-100 text-red-800'
          when 'cancelled' then 'bg-gray-100 text-gray-800'
          else 'bg-gray-100 text-gray-800'
          end %>">
      <%= @estimate.status&.humanize || 'Draft' %>
    </span>
    <% if @estimate.signed? %>
      <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Signed by <%= @estimate.signature_name %>
      </span>
    <% end %>
  </div>

  <% if (estimate_document = @estimate.client_document)&.document_template.present? %>
    <div class="mb-6">
      <%= render 'shared/template_preview_panel',
                 document_template: estimate_document.document_template,
                 client_document: estimate_document,
                 heading: 'Customer Agreement Preview' %>
    </div>
  <% end %>

  <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-8">
    <dl class="divide-y divide-gray-200">
      <% if @estimate.tenant_customer.present? %>
        <div class="p-4 grid grid-cols-3 gap-4">
          <dt class="font-medium text-gray-600">Customer</dt>
          <dd class="col-span-2"><%= @estimate.tenant_customer.full_name %> (<%= @estimate.tenant_customer.email %>)</dd>
        </div>
      <% else %>
        <div class="p-4 grid grid-cols-3 gap-4">
          <dt class="font-medium text-gray-600">Customer</dt>
          <dd class="col-span-2"><%= @estimate.customer_full_name %> (<%= @estimate.customer_email %>)</dd>
        </div>
      <% end %>
      <div class="p-4 grid grid-cols-3 gap-4">
        <dt class="font-medium text-gray-600">Proposed Start</dt>
        <dd class="col-span-2"><%= @estimate.proposed_start_time&.strftime('%B %d, %Y %I:%M %p') || 'Not specified' %></dd>
      </div>
      <div class="p-4 grid grid-cols-3 gap-4">
        <dt class="font-medium text-gray-600">Valid For</dt>
        <dd class="col-span-2"><%= pluralize(@estimate.valid_for_days || 30, 'day') %></dd>
      </div>
      <div class="p-4 grid grid-cols-3 gap-4">
        <dt class="font-medium text-gray-600">Required Deposit</dt>
        <dd class="col-span-2"><%= number_to_currency(@estimate.required_deposit) %></dd>
      </div>
      <div class="p-4 grid grid-cols-3 gap-4">
        <dt class="font-medium text-gray-600">Subtotal</dt>
        <dd class="col-span-2"><%= number_to_currency(@estimate.subtotal) %></dd>
      </div>
      <div class="p-4 grid grid-cols-3 gap-4">
        <dt class="font-medium text-gray-600">Taxes</dt>
        <dd class="col-span-2"><%= number_to_currency(@estimate.taxes) %></dd>
      </div>
      <div class="p-4 grid grid-cols-3 gap-4">
        <dt class="font-medium text-gray-600">Total</dt>
        <dd class="col-span-2 font-bold text-lg"><%= number_to_currency(@estimate.total) %></dd>
      </div>

      <% if @estimate.has_optional_items? %>
        <div class="p-4 grid grid-cols-3 gap-4 bg-yellow-50">
          <dt class="font-medium text-gray-600">Optional Items</dt>
          <dd class="col-span-2">
            <span class="text-sm text-gray-500">
              Additional <%= number_to_currency(@estimate.optional_items_subtotal) %> + <%= number_to_currency(@estimate.optional_items_taxes) %> taxes
            </span>
          </dd>
        </div>
      <% end %>

      <% if @estimate.sent_at %>
        <div class="p-4 grid grid-cols-3 gap-4">
          <dt class="font-medium text-gray-600">Sent At</dt>
          <dd class="col-span-2"><%= @estimate.sent_at.strftime('%B %d, %Y %I:%M %p') %></dd>
        </div>
      <% end %>
      <% if @estimate.viewed_at %>
        <div class="p-4 grid grid-cols-3 gap-4">
          <dt class="font-medium text-gray-600">Viewed At</dt>
          <dd class="col-span-2"><%= @estimate.viewed_at.strftime('%B %d, %Y %I:%M %p') %></dd>
        </div>
      <% end %>
      <% if @estimate.approved_at %>
        <div class="p-4 grid grid-cols-3 gap-4 bg-green-50">
          <dt class="font-medium text-gray-600">Approved At</dt>
          <dd class="col-span-2"><%= @estimate.approved_at.strftime('%B %d, %Y %I:%M %p') %></dd>
        </div>
      <% end %>
      <% if @estimate.declined_at %>
        <div class="p-4 grid grid-cols-3 gap-4 bg-red-50">
          <dt class="font-medium text-gray-600">Declined At</dt>
          <dd class="col-span-2"><%= @estimate.declined_at.strftime('%B %d, %Y %I:%M %p') %></dd>
        </div>
      <% end %>
      <% if @estimate.deposit_paid_at %>
        <div class="p-4 grid grid-cols-3 gap-4 bg-green-50">
          <dt class="font-medium text-gray-600">Deposit Paid At</dt>
          <dd class="col-span-2"><%= @estimate.deposit_paid_at.strftime('%B %d, %Y %I:%M %p') %></dd>
        </div>
      <% end %>
    </dl>
  </div>

  <h2 class="text-xl font-semibold mb-2">Line Items</h2>
  <div class="bg-white shadow sm:rounded-lg overflow-x-auto mb-6">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rate</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tax</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @estimate.estimate_items.order(:position).each do |item| %>
          <tr class="<%= item.customer_declined? ? 'bg-gray-50 text-gray-400' : '' %>">
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                <%= case item.item_type
                    when 'service' then 'bg-blue-100 text-blue-800'
                    when 'product' then 'bg-purple-100 text-purple-800'
                    when 'labor' then 'bg-orange-100 text-orange-800'
                    when 'part' then 'bg-gray-100 text-gray-800'
                    when 'misc' then 'bg-yellow-100 text-yellow-800'
                    else 'bg-gray-100 text-gray-800'
                    end %>">
                <%= item.item_type.humanize %>
              </span>
            </td>
            <td class="px-6 py-4">
              <div class="<%= item.customer_declined? ? 'line-through' : '' %>">
                <%= item.display_name %>
              </div>
              <% if item.description.present? && item.description != item.display_name %>
                <div class="text-sm text-gray-500"><%= item.description.truncate(50) %></div>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <% if item.labor? %>
                <%= item.hours %> hrs
              <% else %>
                <%= item.qty %>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <% if item.labor? %>
                <%= number_to_currency(item.hourly_rate) %>/hr
              <% else %>
                <%= number_to_currency(item.cost_rate) %>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap"><%= number_to_currency(item.tax_amount) %></td>
            <td class="px-6 py-4 whitespace-nowrap font-medium"><%= number_to_currency(item.total) %></td>
            <td class="px-6 py-4 whitespace-nowrap">
              <% if item.optional? %>
                <% if item.customer_declined? %>
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                    Declined
                  </span>
                <% elsif item.customer_selected? %>
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                    Selected
                  </span>
                <% else %>
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                    Optional
                  </span>
                <% end %>
              <% else %>
                <span class="text-gray-400 text-xs">Required</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <% if @estimate.customer_notes.present? || @estimate.internal_notes.present? %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <% if @estimate.customer_notes.present? %>
        <div class="bg-white shadow sm:rounded-lg p-4">
          <h3 class="text-sm font-medium text-gray-700 mb-2">Customer Notes</h3>
          <p class="text-gray-600"><%= simple_format(@estimate.customer_notes) %></p>
        </div>
      <% end %>
      <% if @estimate.internal_notes.present? %>
        <div class="bg-yellow-50 shadow sm:rounded-lg p-4">
          <h3 class="text-sm font-medium text-gray-700 mb-2">Internal Notes (Not visible to customer)</h3>
          <p class="text-gray-600"><%= simple_format(@estimate.internal_notes) %></p>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Customer Messages / Change Requests -->
  <% if @estimate.estimate_messages.any? %>
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-4 flex items-center">
        <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        Customer Messages
        <span class="ml-2 text-sm font-normal text-gray-500">(<%= @estimate.estimate_messages.count %>)</span>
      </h2>
      <div class="bg-white shadow sm:rounded-lg divide-y divide-gray-200">
        <% @estimate.estimate_messages.chronological.each do |msg| %>
          <div class="p-4 <%= msg.from_customer? ? 'bg-blue-50' : 'bg-gray-50' %>">
            <div class="flex items-start justify-between mb-2">
              <div class="flex items-center">
                <% if msg.from_customer? %>
                  <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600 mr-3">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                  </span>
                <% else %>
                  <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-100 text-green-600 mr-3">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                  </span>
                <% end %>
                <div>
                  <span class="font-medium text-gray-900"><%= msg.sender_name || 'Unknown' %></span>
                  <% if msg.sender_email.present? %>
                    <span class="text-sm text-gray-500 ml-1">(<%= msg.sender_email %>)</span>
                  <% end %>
                  <span class="ml-2 text-xs px-2 py-0.5 rounded-full <%= msg.from_customer? ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700' %>">
                    <%= msg.from_customer? ? 'Customer' : 'Business' %>
                  </span>
                </div>
              </div>
              <span class="text-sm text-gray-500"><%= msg.created_at.strftime('%b %d, %Y at %I:%M %p') %></span>
            </div>
            <div class="ml-11 text-gray-700">
              <%= simple_format(msg.message) %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%= link_to 'Back to Estimates', business_manager_estimates_path, class: 'mt-4 inline-flex items-center text-blue-600 hover:text-blue-800' %>
</div>
