<% content_for :title, "Stock Movements" %>

<div class="space-y-6">
  <!-- Header with Period Selector -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Stock Movements</h1>
      <p class="text-sm text-gray-600 mt-1">Transaction log of all inventory movements</p>
    </div>

    <div class="flex items-center gap-4">
      <%= render 'shared/period_selector', period: @period || :last_30_days, base_path: movements_business_manager_analytics_inventory_index_path %>
      <%= link_to "Export CSV", export_business_manager_analytics_inventory_index_path(format: :csv, period: @period),
                  class: "px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors" %>
    </div>
  </div>

  <!-- Back Link -->
  <%= link_to business_manager_analytics_inventory_index_path, class: "inline-flex items-center text-sm text-gray-600 hover:text-gray-900" do %>
    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
    </svg>
    Back to Inventory Analytics
  <% end %>

  <!-- Summary Stats -->
  <% if @movement_data.present? %>
    <% total_additions = @movement_data[:total_additions] || 0 %>
    <% total_reductions = @movement_data[:total_reductions] || 0 %>
    <% net_change = total_additions - total_reductions %>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Total Movements</p>
            <p class="text-2xl font-semibold text-gray-900 mt-2"><%= @movement_data[:total_movements] || 0 %></p>
          </div>
          <div class="bg-blue-100 p-3 rounded-full">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
            </svg>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Stock Additions</p>
            <p class="text-2xl font-semibold text-green-600 mt-2">+<%= total_additions %></p>
          </div>
          <div class="bg-green-100 p-3 rounded-full">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Stock Reductions</p>
            <p class="text-2xl font-semibold text-red-600 mt-2">-<%= total_reductions %></p>
          </div>
          <div class="bg-red-100 p-3 rounded-full">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
            </svg>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Net Change</p>
            <p class="text-2xl font-semibold <%= net_change >= 0 ? 'text-green-600' : 'text-red-600' %> mt-2">
              <%= net_change >= 0 ? '+' : '' %><%= net_change %>
            </p>
          </div>
          <div class="<%= net_change >= 0 ? 'bg-green-100' : 'bg-red-100' %> p-3 rounded-full">
            <svg class="w-6 h-6 <%= net_change >= 0 ? 'text-green-600' : 'text-red-600' %>" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="<%= net_change >= 0 ? 'M13 7h8m0 0v8m0-8l-8 8-4-4-6 6' : 'M13 17h8m0 0V9m0 8l-8-8-4 4-6-6' %>"/>
            </svg>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Movement Type Breakdown -->
  <% if @movement_data.present? && @movement_data[:by_type] && @movement_data[:by_type].any? %>
    <div class="bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900">Movement Types</h2>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <% @movement_data[:by_type].each do |type, count| %>
            <div class="border rounded-lg p-4">
              <div class="text-sm text-gray-600 mb-1"><%= type.to_s.titleize %></div>
              <div class="text-2xl font-semibold text-gray-900"><%= count %></div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Recent Movements Table -->
  <div class="bg-white rounded-lg shadow">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900">Recent Stock Movements</h2>
    </div>

    <div class="p-6">
      <% if @movement_data.present? && @movement_data[:recent_movements] && @movement_data[:recent_movements].any? %>
        <!-- Mobile Cards -->
        <div class="lg:hidden space-y-4">
          <% @movement_data[:recent_movements].each do |movement| %>
            <div class="border rounded-lg p-4">
              <div class="flex items-start justify-between mb-2">
                <div>
                  <h3 class="font-semibold text-gray-900"><%= movement[:product_name] %></h3>
                  <% if movement[:variant_name] %>
                    <p class="text-sm text-gray-600"><%= movement[:variant_name] %></p>
                  <% end %>
                </div>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= movement[:movement_type] == 'addition' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                  <%= movement[:movement_type]&.titleize %>
                </span>
              </div>

              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">Quantity:</span>
                  <span class="font-medium <%= movement[:movement_type] == 'addition' ? 'text-green-600' : 'text-red-600' %>">
                    <%= movement[:movement_type] == 'addition' ? '+' : '-' %><%= movement[:quantity] %>
                  </span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Date:</span>
                  <span class="text-gray-900"><%= movement[:date]&.strftime('%b %d, %Y') || 'N/A' %></span>
                </div>
                <% if movement[:reason] %>
                  <div class="text-xs text-gray-500 mt-2"><%= movement[:reason] %></div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Desktop Table -->
        <div class="hidden lg:block overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Date
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Product
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Variant
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Type
                </th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Quantity
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Reason
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <% @movement_data[:recent_movements].each do |movement| %>
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900"><%= movement[:date]&.strftime('%b %d, %Y') || 'N/A' %></div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900"><%= movement[:product_name] %></div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900"><%= movement[:variant_name] || 'N/A' %></div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= movement[:movement_type] == 'addition' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                      <%= movement[:movement_type]&.titleize %>
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right">
                    <div class="text-sm font-semibold <%= movement[:movement_type] == 'addition' ? 'text-green-600' : 'text-red-600' %>">
                      <%= movement[:movement_type] == 'addition' ? '+' : '-' %><%= movement[:quantity] %>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="text-sm text-gray-600"><%= movement[:reason] || 'N/A' %></div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="text-center py-12">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
          </svg>
          <h3 class="mt-2 text-sm font-medium text-gray-900">No stock movements</h3>
          <p class="mt-1 text-sm text-gray-500">No stock movements recorded in the selected period.</p>
        </div>
      <% end %>
    </div>
  </div>
</div>
