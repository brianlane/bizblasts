<%# app/views/business_manager/rentals/_form.html.erb %>
<%= form_with model: [:business_manager, @rental], local: true, class: "space-y-6" do |form| %>
  <% if @rental.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded-md p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">Please fix the following errors:</h3>
          <ul class="mt-2 text-sm text-red-700 list-disc list-inside">
            <% @rental.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Basic Information -->
  <div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Basic Information</h2>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="md:col-span-2">
        <%= form.label :name, class: "block text-sm font-medium text-gray-700" %>
        <%= form.text_field :name, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500", placeholder: "e.g., Power Drill, Bicycle, Camera" %>
      </div>
      
      <div class="md:col-span-2">
        <%= form.label :description, class: "block text-sm font-medium text-gray-700" %>
        <%= form.text_area :description, rows: 3, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500", placeholder: "Describe the rental item, its features, and any requirements..." %>
      </div>
      
      <div>
        <%= form.label :rental_category, "Category", class: "block text-sm font-medium text-gray-700" %>
        <div class="relative" data-controller="dropdown"
             data-dropdown-selected-value-value="<%= @rental.rental_category %>"
             data-dropdown-selected-text-value="<%= @rental.rental_category&.titleize %>">
          <button type="button"
                  class="mt-1 w-full bg-white border border-gray-300 rounded-md shadow-sm px-3 py-2 text-left cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  data-dropdown-target="button"
                  data-action="click->dropdown#toggle">
            <span class="rich-dropdown-text text-gray-900">
              <%= @rental.rental_category&.titleize || 'Select category...' %>
            </span>
            <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
              <svg class="h-5 w-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </span>
          </button>
          <%= form.hidden_field :rental_category, data: { dropdown_target: 'hidden' } %>
          <div class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 ring-1 ring-black ring-opacity-5 overflow-auto hidden"
               data-dropdown-target="menu">
            <% Product::RENTAL_CATEGORIES.each do |category| %>
              <div class="cursor-pointer select-none relative py-2 px-3 hover:bg-blue-50 transition-colors"
                   data-item-id="<%= category %>"
                   data-item-text="<%= category.titleize %>"
                   data-dropdown-target="option"
                   data-action="click->dropdown#select">
                <%= category.titleize %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
      
      <% if @locations.any? %>
        <div>
          <%= form.label :location_id, "Location", class: "block text-sm font-medium text-gray-700" %>
          <%
            selected_location = @locations.find { |l| l.id == @rental.location_id }
            selected_text = selected_location ? selected_location.name : 'No specific location'
            selected_value = @rental.location_id || ''
          %>
          <div class="relative" data-controller="dropdown"
               data-dropdown-selected-value-value="<%= selected_value %>"
               data-dropdown-selected-text-value="<%= selected_text %>">
            <button type="button"
                    class="mt-1 w-full bg-white border border-gray-300 rounded-md shadow-sm px-3 py-2 text-left cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    data-dropdown-target="button"
                    data-action="click->dropdown#toggle">
              <span class="rich-dropdown-text text-gray-900">
                <%= selected_text %>
              </span>
              <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                <svg class="h-5 w-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </span>
            </button>
            <%= form.hidden_field :location_id, data: { dropdown_target: 'hidden' } %>
            <div class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 ring-1 ring-black ring-opacity-5 overflow-auto hidden"
                 data-dropdown-target="menu">
              <div class="cursor-pointer select-none relative py-2 px-3 hover:bg-blue-50 transition-colors"
                   data-item-id=""
                   data-item-text="No specific location"
                   data-dropdown-target="option"
                   data-action="click->dropdown#select">
                No specific location
              </div>
              <% @locations.each do |location| %>
                <div class="cursor-pointer select-none relative py-2 px-3 hover:bg-blue-50 transition-colors"
                     data-item-id="<%= location.id %>"
                     data-item-text="<%= location.name %>"
                     data-dropdown-target="option"
                     data-action="click->dropdown#select">
                  <%= location.name %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
      
      <div>
        <%= form.label :rental_quantity_available, "Quantity Available", class: "block text-sm font-medium text-gray-700" %>
        <%= form.number_field :rental_quantity_available, min: 1, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
        <p class="mt-1 text-xs text-gray-500">How many of this item do you have available for rent?</p>
      </div>
      
      <div class="flex items-center gap-6">
        <div class="flex items-center">
          <%= form.check_box :active, class: "h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" %>
          <%= form.label :active, "Active", class: "ml-2 text-sm text-gray-700" %>
        </div>
        <div class="flex items-center">
          <%= form.check_box :featured, class: "h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" %>
          <%= form.label :featured, "Featured", class: "ml-2 text-sm text-gray-700" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Pricing -->
  <div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Pricing</h2>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div>
        <%= form.label :price, "Daily Rate *", class: "block text-sm font-medium text-gray-700" %>
        <div class="mt-1 relative rounded-md shadow-sm">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="text-gray-500 sm:text-sm">$</span>
          </div>
          <%= form.number_field :price, step: 0.01, min: 0, class: "pl-7 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
        </div>
        <p class="mt-1 text-xs text-gray-500">Required - base daily rental rate</p>
      </div>
      
      <div>
        <%= form.label :hourly_rate, "Hourly Rate", class: "block text-sm font-medium text-gray-700" %>
        <div class="mt-1 relative rounded-md shadow-sm">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="text-gray-500 sm:text-sm">$</span>
          </div>
          <%= form.number_field :hourly_rate, step: 0.01, min: 0, class: "pl-7 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
        </div>
        <p class="mt-1 text-xs text-gray-500">Optional - for short-term rentals</p>
      </div>
      
      <div>
        <%= form.label :weekly_rate, "Weekly Rate", class: "block text-sm font-medium text-gray-700" %>
        <div class="mt-1 relative rounded-md shadow-sm">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="text-gray-500 sm:text-sm">$</span>
          </div>
          <%= form.number_field :weekly_rate, step: 0.01, min: 0, class: "pl-7 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
        </div>
        <p class="mt-1 text-xs text-gray-500">Optional - discounted weekly rate</p>
      </div>
      
      <div>
        <%= form.label :security_deposit, "Security Deposit", class: "block text-sm font-medium text-gray-700" %>
        <div class="mt-1 relative rounded-md shadow-sm">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="text-gray-500 sm:text-sm">$</span>
          </div>
          <%= form.number_field :security_deposit, step: 0.01, min: 0, class: "pl-7 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
        </div>
        <p class="mt-1 text-xs text-gray-500">Refundable deposit collected before rental</p>
      </div>
    </div>
    
    <div class="mt-6 flex flex-wrap gap-6">
      <div class="flex items-center">
        <%= form.check_box :allow_hourly_rental, class: "h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" %>
        <%= form.label :allow_hourly_rental, "Allow Hourly Rentals", class: "ml-2 text-sm text-gray-700" %>
      </div>
      <div class="flex items-center">
        <%= form.check_box :allow_daily_rental, class: "h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" %>
        <%= form.label :allow_daily_rental, "Allow Daily Rentals", class: "ml-2 text-sm text-gray-700" %>
      </div>
      <div class="flex items-center">
        <%= form.check_box :allow_weekly_rental, class: "h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" %>
        <%= form.label :allow_weekly_rental, "Allow Weekly Rentals", class: "ml-2 text-sm text-gray-700" %>
      </div>
    </div>
  </div>

  <!-- Duration Constraints -->
  <div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Duration Constraints</h2>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div>
        <%= form.label :min_rental_duration_mins, "Minimum Duration (minutes)", class: "block text-sm font-medium text-gray-700" %>
        <%= form.number_field :min_rental_duration_mins, min: 1, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
        <p class="mt-1 text-xs text-gray-500">e.g., 60 = 1 hour minimum</p>
      </div>
      
      <div>
        <%= form.label :max_rental_duration_mins, "Maximum Duration (minutes)", class: "block text-sm font-medium text-gray-700" %>
        <%= form.number_field :max_rental_duration_mins, min: 1, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
        <p class="mt-1 text-xs text-gray-500">Leave empty for no maximum</p>
      </div>
      
      <div>
        <%= form.label :rental_buffer_mins, "Buffer Between Rentals (minutes)", class: "block text-sm font-medium text-gray-700" %>
        <%= form.number_field :rental_buffer_mins, min: 0, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
        <p class="mt-1 text-xs text-gray-500">Time for cleaning/preparation</p>
      </div>
    </div>
  </div>

  <!-- Customer Durations & Availability -->
  <div class="bg-white shadow rounded-lg p-6" data-controller="rental-durations">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h2 class="text-lg font-medium text-gray-900">Customer Durations & Availability</h2>
        <p class="text-sm text-gray-600 mt-1">
          Choose the rental session lengths customers can select before they pick a time slot.
          Slots on the calendar will automatically adjust to these durations.
        </p>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" data-rental-durations-target="container">
      <%
        # Show custom durations if saved, otherwise show effective defaults
        duration_values = if @rental.rental_duration_options.present?
          @rental.rental_duration_options
        else
          # Show the effective defaults so manager sees exactly what customers can pick
          @rental.effective_rental_durations
        end

        # Ensure we have at least one field
        duration_values = [60] if duration_values.empty?
      %>
      <% duration_values.each_with_index do |duration, index| %>
        <div class="flex gap-2" data-rental-durations-target="field">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700">Duration (minutes)</label>
            <input type="number"
                   name="product[rental_duration_options][]"
                   value="<%= duration %>"
                   min="15"
                   step="15"
                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                   placeholder="e.g., 60"
                   data-rental-durations-target="input" />
          </div>
          <div class="flex items-end">
            <button type="button"
                    class="px-3 py-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-md transition-colors"
                    data-action="click->rental-durations#remove"
                    title="Remove duration">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>
        </div>
      <% end %>
    </div>

    <div class="flex items-center justify-between">
      <div>
        <button type="button"
                class="inline-flex items-center px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 font-medium rounded-md transition-colors"
                data-action="click->rental-durations#add"
                data-rental-durations-target="addButton">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Add Duration Option
        </button>
        <p class="mt-1 text-xs text-gray-500">
          Tip: common options are 60, 90, 120 minutes. Maximum <%= Product::MAX_RENTAL_DURATION_OPTIONS %> options.
        </p>
      </div>
    </div>

    <% if @rental.persisted? %>
      <div class="mt-6">
        <%= link_to manage_availability_business_manager_rental_path(@rental),
              class: "inline-flex items-center px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 font-medium rounded-md transition-colors" do %>
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          Manage Weekly Availability
        <% end %>
        <p class="mt-1 text-xs text-gray-500">Set the pickup/return windows that power the rental calendar.</p>
      </div>
    <% else %>
      <p class="mt-4 text-xs text-gray-500">
        Save the rental first to configure the weekly availability calendar.
      </p>
    <% end %>
  </div>

  <!-- Images -->
  <div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Images</h2>
    
    <% if @rental.images.attached? %>
      <div class="mb-4 grid grid-cols-2 md:grid-cols-4 gap-4">
        <% @rental.images.each do |image| %>
          <div class="relative group">
            <%= image_tag image.variant(:thumb), class: "w-full h-32 object-cover rounded-lg" %>
          </div>
        <% end %>
      </div>
    <% end %>
    
    <div>
      <%= form.label :images, "Upload Images", class: "block text-sm font-medium text-gray-700" %>
      <%= form.file_field :images, multiple: true, accept: "image/*", class: "mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" %>
      <p class="mt-1 text-xs text-gray-500">You can upload multiple images. Max 15MB per image.</p>
    </div>
  </div>

  <!-- Submit -->
  <div class="flex justify-end gap-3">
    <%= link_to 'Cancel', business_manager_rentals_path, class: "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
    <%= form.submit @rental.new_record? ? 'Create Rental' : 'Update Rental', class: "px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 cursor-pointer" %>
  </div>
<% end %>

