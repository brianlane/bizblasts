<% content_for :title, "Website Pages" %>

<div class="space-y-6" 
     data-controller="pages-manager" 
     data-pages-manager-update-priority-url-value="<%= update_priority_business_manager_website_pages_path %>" 
     data-pages-manager-bulk-action-url-value="<%= bulk_action_business_manager_website_pages_path %>"
     data-action="keydown@document->pages-manager#handleKeyDown click@document->pages-manager#closeMenus">
  <!-- Header -->
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Website Builder</h1>
      <p class="text-gray-600 mt-1">Build and customize your professional website</p>
    </div>
    <div class="flex items-center space-x-3">
      <!-- Sort Dropdown -->
      <%= select_tag :sort, options_for_select(@sort_options, params[:sort]), 
                     { class: "bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm",
                       "data-pages-manager-target" => "sortSelect",
                       "data-action" => "change->pages-manager#sortChanged" } %>
      
      <%= link_to "Show Site", root_url(subdomain: current_business.host_type_subdomain? ? current_business.hostname : nil), 
                  class: "bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors",
                  target: "_blank" %>
      <%= link_to "Create Page", new_business_manager_website_page_path, 
                  class: "bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors cursor-pointer" %>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <div class="bg-white border border-gray-200 rounded-lg p-1">
    <nav class="flex space-x-1">
      <%= link_to business_manager_website_pages_path, 
                  class: "px-4 py-2 rounded-md text-sm font-medium transition-colors bg-blue-500 text-white" do %>
        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        Pages
      <% end %>
      
      <%= link_to business_manager_website_templates_path, 
                  class: "px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900 hover:bg-gray-100" do %>
        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
        </svg>
        Templates
      <% end %>
      
      <%= link_to business_manager_website_themes_path, 
                  class: "px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900 hover:bg-gray-100" do %>
        <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 325.04 325.04">
          <path d="M117.866,234.088c-2.956,14.532-4.875,21.558-16.092,22.458c-2.764,0.222-5.015,2.308-5.446,5.047 c-0.432,2.738,1.069,5.416,3.631,6.477c0.721,0.298,17.877,7.308,37.921,7.309c0.003,0,0.005,0,0.007,0 c13.968,0,25.95-3.386,35.612-10.063c11.45-7.912,19.344-20.294,23.541-36.788l-38.572-38.88 C125.871,194.924,121.253,217.436,117.866,234.088z"/>
          <path d="M322.745,63.336c-1.037-1.046-2.887-2.293-5.806-2.293c-3.423,0-12.516,0-67.74,46.992 c-25.509,21.706-54.92,48.559-78.314,71.41l36.603,36.894c24.061-25.009,52.129-56.355,74.451-83.258 c14.096-16.986,24.935-31.002,32.216-41.657C323.799,77.311,328.023,68.655,322.745,63.336z"/>
          <path d="M182.595,278.479c-12.387,8.56-27.429,12.899-44.716,12.899c-22.753-0.001-41.919-7.649-44.046-8.527 c-9.425-3.906-14.898-13.673-13.31-23.749c1.555-9.871,9.463-17.373,19.341-18.446c0.861-2.571,1.813-7.254,2.323-9.758 c1.878-9.23,4.449-21.873,12.358-33.126c8.637-12.287,21.656-20.165,38.751-23.466c9.811-9.737,21.005-20.443,32.686-31.308 c-5.905-1.281-11.185-5.127-14.017-10.944c-4.875-10.02-0.623-22.073,9.484-26.895c10.133-4.834,22.287-0.612,27.155,9.423 c0.961,1.978,1.555,4.033,1.832,6.096c9.688-8.677,19.309-17.099,28.392-24.828c0.054-0.046,0.105-0.09,0.16-0.136 c-10.209-19.536-24.849-36.845-42.687-50.098c-25.614-19.031-56.114-29.096-88.2-29.104c-0.01,0-0.017,0-0.025,0 c-21.654,0-47.976,7.566-68.697,19.749C13.981,51.193-0.005,71.163,0,92.49c0.008,25.748,14.53,36.518,26.199,45.171 c9.515,7.057,17.03,12.63,17.034,24.844c0.003,12.213-7.508,17.781-17.018,24.831c-11.665,8.648-26.184,19.412-26.176,45.163 c0.006,21.324,14.001,41.299,39.406,56.244c20.736,12.198,47.072,19.78,68.73,19.786c0.015,0,0.028,0,0.042,0 c39.305,0,76.254-15.171,104.044-42.72c20.837-20.655,34.656-46.416,40.273-74.442c-13.952,15.471-27.997,30.493-40.563,43.322 C206.641,253.965,196.773,268.682,182.595,278.479z M111.054,77.103c2.498-10.871,13.4-17.657,24.354-15.167 c10.939,2.478,17.793,13.282,15.313,24.138c-2.499,10.844-13.407,17.631-24.362,15.154 C115.411,98.764,108.554,87.947,111.054,77.103z M45.054,114.152c-7.005-8.716-5.565-21.401,3.216-28.339 c8.78-6.925,21.571-5.505,28.589,3.195c6.99,8.703,5.545,21.388-3.229,28.34C64.869,124.288,52.058,122.853,45.054,114.152z M55.746,247.168c-8.786-6.944-10.231-19.629-3.226-28.342c7-8.696,19.796-10.122,28.581-3.18 c8.778,6.943,10.224,19.629,3.225,28.327C77.327,252.686,64.53,254.111,55.746,247.168z"/>
        </svg>
        Themes
      <% end %>
    </nav>
  </div>

  <!-- Enhanced Quick Stats -->
  <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-2xl font-bold text-blue-600"><%= @pages.count %></div>
          <div class="text-sm text-gray-600">Total Pages</div>
        </div>
        <div class="text-blue-500">
          <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
        </div>
      </div>
    </div>
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-2xl font-bold text-green-600"><%= @pages.published.count %></div>
          <div class="text-sm text-gray-600">Published</div>
        </div>
        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
      </div>
    </div>
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-2xl font-bold text-yellow-600"><%= @pages.draft.count %></div>
          <div class="text-sm text-gray-600">Drafts</div>
        </div>
        <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
      </div>
    </div>
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-2xl font-bold text-purple-600"><%= @pages.sum { |p| p.page_sections.count } %></div>
          <div class="text-sm text-gray-600">Total Sections</div>
        </div>
        <div class="text-purple-500">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
          </svg>
        </div>
      </div>
    </div>
    <div class="bg-white border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-2xl font-bold text-indigo-600"><%= @pages.sum(&:view_count) %></div>
          <div class="text-sm text-gray-600">Total Views</div>
        </div>
        <div class="text-indigo-500">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Pages Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" data-pages-manager-target="pageGrid">
    <% @pages.each do |page| %>
      <div class="bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 group" 
           data-controller="page-card"
           data-page-card-page-id-value="<%= page.id %>"
           data-page-card-status-value="<%= page.status %>"
           data-page-card-priority-value="<%= page.priority %>"
           data-page-card-view-count-value="<%= page.view_count %>"
           data-page-card-performance-score-value="<%= page.performance_score || 0 %>"
           data-page-id="<%= page.id %>">
        
        <!-- Selection Checkbox -->
        <div class="absolute top-3 left-3 z-10">
          <input type="checkbox" 
                 value="<%= page.id %>" 
                 data-pages-manager-target="pageCheckbox"
                 data-action="change->pages-manager#pageCheckboxChanged"
                 class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
        </div>

        <!-- Enhanced Page Preview -->
        <div class="h-40 bg-gradient-to-br from-gray-50 to-gray-100 rounded-t-lg relative overflow-hidden" data-page-card-target="thumbnail">
          <!-- Priority Indicator -->
          <% if page.priority > 0 %>
            <div class="absolute top-2 left-2 z-10">
              <% case page.priority_level %>
              <% when 'critical' %>
                <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full font-bold">🔥 Critical</span>
              <% when 'high' %>
                <span class="bg-orange-500 text-white text-xs px-2 py-1 rounded-full font-medium">⚡ High</span>
              <% when 'medium' %>
                <span class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full">📌 Medium</span>
              <% end %>
            </div>
          <% end %>

          <!-- Page Content Preview -->
          <div class="absolute inset-0 p-4 pt-12">
            <!-- Mock page layout -->
            <div class="space-y-2">
              <div class="h-3 bg-gray-300 rounded" style="width: 70%;"></div>
              <div class="space-y-1">
                <div class="h-1 bg-gray-200 rounded" style="width: 90%;"></div>
                <div class="h-1 bg-gray-200 rounded" style="width: 75%;"></div>
                <div class="h-1 bg-gray-200 rounded" style="width: 85%;"></div>
              </div>
              
              <!-- Enhanced Section indicators -->
              <div class="flex space-x-1 mt-3">
                <% page.page_sections.limit(5).each do |section| %>
                  <div class="w-5 h-3 bg-blue-200 rounded-sm border border-blue-300 flex items-center justify-center">
                    <span class="text-[5px] text-blue-600 font-bold">
                      <%= section.section_type.first.upcase %>
                    </span>
                  </div>
                <% end %>
                <% if page.page_sections.count > 5 %>
                  <div class="w-5 h-3 bg-gray-200 rounded-sm border border-gray-300 flex items-center justify-center">
                    <span class="text-[5px] text-gray-600">+<%= page.page_sections.count - 5 %></span>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
          
          <!-- Enhanced Status Badge with Traffic Light -->
          <div class="absolute bottom-2 right-2">
            <div data-page-card-target="statusIndicator" class="text-xs px-2 py-1 rounded-full font-medium">
              <!-- Status will be updated by Stimulus controller -->
            </div>
          </div>
          
          <!-- Clear Action Buttons -->
          <div class="absolute top-2 right-2 flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
            <button onclick="window.location.href='<%= business_manager_website_page_path(page) %>'"
                    class="bg-blue-500 hover:bg-blue-600 text-white rounded p-1 text-xs cursor-pointer" title="Edit Page">
              ✏️
            </button>
            <button onclick="window.location.href='<%= public_page_url(page) %>'"
                    class="bg-gray-500 hover:bg-gray-600 text-white rounded p-1 text-xs cursor-pointer" title="Preview">
              👁️
            </button>
            <%= link_to "🗑️", business_manager_website_page_path(page), 
                       method: :delete,
                       class: "bg-red-500 hover:bg-red-600 text-white rounded p-1 text-xs inline-block",
                       title: "Delete Page",
                       data: { confirm: "Are you sure you want to delete '#{page.title}'? This cannot be undone." } %>
          </div>
        </div>

        <!-- Enhanced Page Info -->
        <div class="p-4 space-y-3">
          <div>
            <h3 class="font-semibold text-gray-900 flex items-center">
              <!-- Page Type Icon -->
              <% case page.page_type %>
              <% when 'home' %>
                🏠
              <% when 'about' %>
                ℹ️
              <% when 'services' %>
                ⚙️
              <% when 'contact' %>
                📞
              <% when 'portfolio' %>
                🎨
              <% when 'team' %>
                👥
              <% when 'pricing' %>
                💰
              <% else %>
                📄
              <% end %>
              
              <span class="ml-2"><%= page.title %></span>
              
              <% if page.show_in_menu? %>
                <span class="ml-2 text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full">Menu</span>
              <% end %>
              
              <% if page.page_type == 'home' %>
                <span class="ml-2 text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded-full">Homepage</span>
              <% end %>
            </h3>
            <p class="text-sm text-gray-500 flex items-center space-x-2">
              <span>/<%= page.slug %></span>
              <% if page.page_type != 'custom' %>
                <span>•</span>
                <span><%= page.page_type.humanize %></span>
              <% end %>
            </p>
          </div>

          <!-- Enhanced Analytics Section -->
          <div class="grid grid-cols-3 gap-2 text-xs">
            <div class="text-center p-2 bg-gray-50 rounded">
              <div class="font-semibold text-gray-900"><%= pluralize(page.page_sections.count, 'section') %></div>
              <div class="text-gray-600">Sections</div>
            </div>
            <div class="text-center p-2 bg-gray-50 rounded">
              <div class="font-semibold text-indigo-600"><%= page.view_count %></div>
              <div class="text-gray-600">Views</div>
            </div>
            <div class="text-center p-2 bg-gray-50 rounded">
              <% if page.performance_score.present? %>
                <div class="font-semibold <%= page.performance_rating == 'excellent' ? 'text-green-600' : page.performance_rating == 'good' ? 'text-blue-600' : page.performance_rating == 'fair' ? 'text-yellow-600' : 'text-red-600' %>">
                  <%= page.performance_score.to_i %>%
                </div>
                <div class="text-gray-600">Score</div>
              <% else %>
                <div class="font-semibold text-gray-400">--</div>
                <div class="text-gray-600">Score</div>
              <% end %>
            </div>
          </div>

          <!-- Clear Action Buttons -->
          <div class="space-y-2 pt-2">
            <!-- Primary Actions Row -->
            <div class="grid grid-cols-2 gap-2">
              <%= link_to "✏️ Edit Page", business_manager_website_page_path(page), 
                          class: "text-center bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm transition-colors font-medium" %>
              <%= link_to "🔧 Sections", business_manager_website_page_sections_path(page), 
                          class: "text-center bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm transition-colors font-medium" %>
            </div>
            
            <!-- Secondary Actions Row -->
            <div class="grid grid-cols-2 gap-2">
              <%= link_to "👁️ Preview", public_page_url(page), 
                          class: "text-center bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded text-sm transition-colors font-medium",
                          target: "_blank", 
                          data: { action: "click->page-card#trackView" } %>
              <%= link_to "🗑️ Delete", business_manager_website_page_path(page), 
                         method: :delete,
                         class: "text-center bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm transition-colors font-medium",
                         data: { confirm: "Are you sure you want to delete '#{page.title}'? This cannot be undone." } %>
            </div>
          </div>

          <!-- Enhanced Footer Info -->
          <div class="pt-2 border-t border-gray-100 text-xs">
            <div class="flex justify-between items-center mb-2">
              <span class="text-gray-500">Updated <%= time_ago_in_words(page.updated_at) %> ago</span>
              <% if page.last_viewed_at.present? %>
                <span class="text-gray-400" title="Last viewed: <%= page.last_viewed_at.strftime('%B %d, %Y at %I:%M %p') %>">Viewed <%= time_ago_in_words(page.last_viewed_at) %> ago</span>
              <% end %>
            </div>
            
            <!-- Quick Actions Row -->
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-2">
                <%= link_to "📋 Duplicate", duplicate_business_manager_website_page_path(page), 
                           method: :post,
                           class: "text-blue-600 hover:text-blue-800 text-xs" %>
                <% unless page.published? %>
                  <%= link_to "🚀 Publish", publish_business_manager_website_page_path(page), 
                             method: :patch,
                             class: "text-green-600 hover:text-green-800 text-xs" %>
                <% end %>
                <%= link_to "⚙️ Settings", edit_business_manager_website_page_path(page), 
                           class: "text-gray-600 hover:text-gray-800 text-xs" %>
              </div>
              
              <!-- Section Type Icons -->
              <div class="flex items-center space-x-1">
                <% if page.page_sections.any? %>
                  <% page.page_sections.limit(3).each do |section| %>
                    <span class="text-blue-500" title="<%= section.section_type.humanize %>">
                      <% case section.section_type %>
                      <% when 'header' %>
                        📰
                      <% when 'text' %>
                        📝
                      <% when 'image' %>
                        🖼️
                      <% when 'gallery' %>
                        🖼️
                      <% when 'video_embed' %>
                        🎥
                      <% when 'contact_form' %>
                        📧
                      <% else %>
                        🔧
                      <% end %>
                    </span>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Enhanced Add New Page Card -->
    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-dashed border-blue-300 rounded-lg hover:border-blue-400 hover:from-blue-100 hover:to-indigo-100 transition-all duration-200">
      <%= link_to new_business_manager_website_page_path, class: "flex flex-col items-center justify-center h-full min-h-[280px] text-blue-600 hover:text-blue-700" do %>
        <div class="text-5xl mb-3">✨</div>
        <div class="text-lg font-semibold mb-1">Create New Page</div>
        <div class="text-sm text-blue-500 text-center px-4">Add a custom page to your website<br>Choose from templates or start from scratch</div>
        <div class="mt-3 bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">
          Get Started
        </div>
      <% end %>
    </div>

    <!-- Page Templates Gallery (Quick Template Selection) -->
    <div class="col-span-full mt-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">📋 Quick Templates</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
        <% ['About Us', 'Services', 'Portfolio', 'Team', 'Pricing', 'Contact'].each do |template| %>
          <%= link_to new_business_manager_website_page_path(template: template.downcase.gsub(' ', '_')), 
                      class: "bg-white border border-gray-200 rounded-lg p-3 hover:border-blue-300 hover:shadow-md transition-all text-center" do %>
            <div class="text-2xl mb-2">
              <% case template %>
              <% when 'About Us' %>
                ℹ️
              <% when 'Services' %>
                ⚙️
              <% when 'Portfolio' %>
                🎨
              <% when 'Team' %>
                👥
              <% when 'Pricing' %>
                💰
              <% when 'Contact' %>
                📞
              <% end %>
            </div>
            <div class="text-sm font-medium text-gray-900"><%= template %></div>
            <div class="text-xs text-gray-500 mt-1">Template</div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div> 