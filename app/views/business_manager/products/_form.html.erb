<%# app/views/business_manager/products/_form.html.erb %>

<%= form_with(model: [:business_manager, @product], local: true) do |form| %>
  <% if @product.errors.any? %>
    <div id="error_explanation" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
      <strong class="font-bold"><%= pluralize(@product.errors.count, "error") %> prohibited this product from being saved:</strong>
      <ul class="mt-2 list-disc list-inside">
        <% @product.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Basic Information Section -->
    <div class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Basic Information</h3>
      
      <div>
        <%= form.label :name, class: "block text-gray-700 text-sm font-bold mb-2" %>
        <%= form.text_field :name, required: true, 
              class: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" %>
      </div>

      <div>
        <%= form.label :description, class: "block text-gray-700 text-sm font-bold mb-2" %>
        <%= form.text_area :description, rows: 4, 
              class: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" %>
      </div>

      <div>
        <%= form.label :category_id, "Category", class: "block text-gray-700 text-sm font-bold mb-2" %>
        <%= form.collection_select :category_id, @current_business.categories.order(:name), :id, :name, 
              { include_blank: 'No Category' }, 
              { class: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" } %>
      </div>

      <div>
        <%= form.label :product_type, "Product Type", class: "block text-gray-700 text-sm font-bold mb-2" %>
        <%= form.select :product_type, 
              Product.product_types.keys.map { |pt| [pt.titleize, pt] }, 
              { include_blank: 'Select Type' }, 
              { class: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" } %>
      </div>
    </div>

    <!-- Pricing and Inventory Section -->
    <div class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-900 border-b pb-2">Pricing & Inventory</h3>
      
      <div>
        <%= form.label :price, "Base Price ($)", class: "block text-gray-700 text-sm font-bold mb-2" %>
        <%= form.number_field :price, step: 0.01, required: true, 
              class: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" %>
      </div>

      <% unless @product.has_variants? %>
        <div>
          <%= form.label :stock_quantity, "Stock Quantity", class: "block text-gray-700 text-sm font-bold mb-2" %>
          <%= form.number_field :stock_quantity, min: 0, 
                class: "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" %>
          <p class="mt-1 text-sm text-gray-500">Only applies if the product has no variants defined below.</p>
        </div>
      <% end %>

      <!-- Status Options -->
      <div class="space-y-3">
        <div class="flex items-center">
          <%= form.check_box :active, class: "form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" %>
          <%= form.label :active, "Active", class: "ml-2 text-gray-700 text-sm font-bold" %>
        </div>

        <div class="flex items-center">
          <%= form.check_box :featured, class: "form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" %>
          <%= form.label :featured, "Featured Product", class: "ml-2 text-gray-700 text-sm font-bold" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Images Section -->
  <div class="mt-8 border-t pt-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Product Images</h3>
    
    <% if @product.persisted? && @product.images.attached? %>
      <div id="existing-images" class="mb-6">
        <h4 class="text-md font-medium mb-3 text-gray-700">Current Images:</h4>
        <%= form.fields_for :images, @product.images.ordered do |image_fields| %>
          <%= image_fields.hidden_field :id %>
          <%= image_fields.hidden_field :_destroy, value: 0, class: 'destroy-image' %>
          <%= image_fields.hidden_field :position, class: 'image-position' %>
          
          <div class="flex items-center mb-3 border border-gray-200 p-3 rounded-lg image-management-item" data-image-id="<%= image_fields.object.id %>">
            <div class="flex-shrink-0 mr-4">
              <% if image_fields.object.variable? %>
                <% begin %>
                  <%= image_tag rails_public_blob_url(image_fields.object.representation(resize_to_limit: [100, 100])), class: "rounded shadow-sm" %>
                <% rescue ActiveStorage::UnrepresentableError %>
                  <div class="w-24 h-24 bg-gray-200 rounded flex items-center justify-center">
                    <span class="text-gray-500 text-xs text-center">Unsupported<br>Format</span>
                  </div>
                <% end %>
              <% else %>
                <span class="text-gray-500 text-sm">Attachment</span>
              <% end %>
            </div>
            <div class="flex-grow">
              <p class="text-sm font-medium text-gray-700 mb-2"><%= image_fields.object.filename %></p>
              <div class="flex items-center">
                <%= image_fields.check_box :primary, class: "form-checkbox h-4 w-4 text-blue-600 primary-image-checkbox mr-2" %>
                <%= image_fields.label :primary, "Primary Image", class: "text-sm text-gray-700 mr-4" %>
                
                <button type="button" class="text-red-600 hover:text-red-800 text-sm font-medium delete-image-button">
                  Remove Image
                </button>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
    
        <div class="mb-4">
      <%= form.label :images, "Add New Images", class: "block text-gray-700 text-sm font-bold mb-2" %>
      <div class="relative">
        <!-- Hidden file input -->
        <%= form.file_field :images, multiple: true, 
              accept: "image/*",
              data: { 
                max_file_size: 15728640,  # 15MB in bytes
                max_files: 10 
              },
              class: "hidden",
              id: "product_images_input" %>
        
        <!-- Custom styled button -->
        <button type="button" id="custom-file-button" 
                class="inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 cursor-pointer">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Choose Files
        </button>
        
        <!-- File selection display -->
        <span id="file-selection-display" class="ml-3 text-sm text-gray-600">No files selected</span>
      </div>
      <p class="mt-1 text-sm text-gray-500">
        <br>Accepted formats: PNG, JPG/JPEG, GIF, WebP. Max size: 15MB per file, 10 files max.
      </p>
    </div>
  </div>

  <!-- Product Variants Section -->
  <div class="mt-8 border-t pt-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Product Variants</h3>
    <p class="text-sm text-gray-600 mb-4">Add variants if this product comes in different sizes, colors, or configurations.</p>
    
    <div id="product-variants" class="space-y-4">
      <%= form.fields_for :product_variants do |variant_form| %>
        <%= render 'variant_fields', form: variant_form %>
      <% end %>
      
      <div class="flex justify-start">
        <%= link_to '+ Add Variant', '#', id: 'add-variant', 
              class: "inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" %>
      </div>
    </div>
  </div>

  <!-- Submit Button -->
  <div class="mt-8 border-t pt-6">
    <div class="flex flex-col sm:flex-row gap-4">
      <%= form.submit(@product.new_record? ? 'Create Product' : 'Update Product', 
            class: "inline-flex items-center justify-center px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 cursor-pointer") %>
    </div>
  </div>
<% end %>

<!-- Template for new variant fields (hidden) -->
<div id="variant-template" class="hidden">
  <%= form_with model: Product.new, local: true do |temp_form| %>
    <%= temp_form.fields_for :product_variants, Product.new.product_variants.build, child_index: 'NEW_RECORD' do |variant_form| %>
      <%= render 'variant_fields', form: variant_form %>
    <% end %>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle Add Variant button click
    const addVariantBtn = document.getElementById('add-variant');
    if (addVariantBtn) {
      addVariantBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Get the template HTML
        const template = document.getElementById('variant-template');
        if (!template) return;
        
        let templateHTML = template.innerHTML;
        
        // Replace placeholder index with timestamp to ensure uniqueness
        const timestamp = new Date().getTime();
        templateHTML = templateHTML.replace(/NEW_RECORD/g, timestamp);
        
        // Insert the new variant fields
        const variantsContainer = document.getElementById('product-variants');
        const addButtonContainer = variantsContainer.querySelector('.flex');
        
        // Create a temporary div to hold the new content
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = templateHTML;
        
        // Find the actual variant fields in the template and insert before add button
        const variantField = tempDiv.querySelector('.variant-field');
        if (variantField && addButtonContainer) {
          variantsContainer.insertBefore(variantField, addButtonContainer);
        }
      });
    }
    
    // Handle Remove Variant links (with event delegation)
    document.addEventListener('click', function(e) {
      if (e.target.matches('.remove-variant') || e.target.closest('.remove-variant')) {
        e.preventDefault();
        const button = e.target.matches('.remove-variant') ? e.target : e.target.closest('.remove-variant');
        const variantFields = button.closest('.variant-field');
        
        if (!variantFields) return;
        
        // Check if this is an existing record
        const idField = variantFields.querySelector('input[name*="[id]"]');
        if (idField && idField.value) {
          // Create hidden field for _destroy
          const destroyField = document.createElement('input');
          destroyField.type = 'hidden';
          destroyField.name = idField.name.replace('[id]', '[_destroy]');
          destroyField.value = '1';
          variantFields.appendChild(destroyField);
          
          // Hide instead of remove for existing records
          variantFields.style.display = 'none';
        } else {
          // For new records, just remove from DOM
          variantFields.remove();
        }
      }
    });
    
    // Image management functionality
    const existingImagesDiv = document.getElementById('existing-images');
    if (existingImagesDiv) {
      // Handle image deletion
      existingImagesDiv.addEventListener('click', function(event) {
        if (event.target.classList.contains('delete-image-button')) {
          event.preventDefault();
          
          const item = event.target.closest('.image-management-item');
          if (item) {
            // Find the hidden _destroy field and set its value to 1
            const destroyField = item.querySelector('.destroy-image');
            if (destroyField) {
              destroyField.value = '1';
              
              // Apply visual feedback to show it will be deleted
              item.style.opacity = '0.6';
              item.style.backgroundColor = '#FEF2F2';
              item.style.border = '1px solid #FCA5A5';
              
              // Update the button
              event.target.textContent = 'Marked for Deletion';
              event.target.className = 'text-gray-500 text-sm font-medium cursor-not-allowed';
              event.target.disabled = true;
              
              // Add visual indicator
              const indicator = document.createElement('span');
              indicator.className = 'ml-2 text-red-600 font-medium text-xs';
              indicator.textContent = '(Will be removed when saved)';
              event.target.parentNode.appendChild(indicator);
              
              // Also disable the primary checkbox if exists
              const primaryCheckbox = item.querySelector('.primary-image-checkbox');
              if (primaryCheckbox) {
                primaryCheckbox.disabled = true;
                primaryCheckbox.checked = false;
              }
            }
          }
        }
      });

      // Handle primary image selection (ensure only one is selected)
      existingImagesDiv.addEventListener('change', function(event) {
        if (event.target.classList.contains('primary-image-checkbox')) {
          if (event.target.checked) {
            // Uncheck all other primary checkboxes
            existingImagesDiv.querySelectorAll('.primary-image-checkbox').forEach(checkbox => {
              if (checkbox !== event.target) {
                checkbox.checked = false;
              }
            });
          }
        }
      });
    }
    
    // Handle custom file button click
    const customFileButton = document.getElementById('custom-file-button');
    const fileInput = document.getElementById('product_images_input');
    const fileSelectionDisplay = document.getElementById('file-selection-display');
    
    if (customFileButton && fileInput) {
      customFileButton.addEventListener('click', function() {
        fileInput.click();
      });
    }
    
    // Handle file input change to validate file types and show feedback
    if (fileInput) {
      fileInput.addEventListener('change', function(event) {
        const files = event.target.files;
        const maxSize = parseInt(fileInput.dataset.maxFileSize) || 15728640; // 15MB
        const maxFiles = parseInt(fileInput.dataset.maxFiles) || 10;
        
        if (files.length > maxFiles) {
          alert(`Maximum ${maxFiles} files allowed`);
          fileInput.value = '';
          fileSelectionDisplay.textContent = 'No files selected';
          return;
        }
        
        let validFiles = true;
        Array.from(files).forEach(file => {
          if (file.size > maxSize) {
            alert(`${file.name} is too large. Maximum size is 15MB.`);
            validFiles = false;
          }
          if (!file.type.startsWith('image/')) {
            alert(`${file.name} is not a valid image format.`);
            validFiles = false;
          }
        });
        
        if (!validFiles) {
          fileInput.value = '';
          fileSelectionDisplay.textContent = 'No files selected';
          return;
        }
        
        // Remove any existing feedback
        let existingFeedback = document.getElementById('file-selection-feedback');
        if (existingFeedback) {
          existingFeedback.remove();
        }
        
        if (files && files.length > 0) {
          // Validate file types
          const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg'];
          const invalidFiles = [];
          const validFiles = [];
          
          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (allowedTypes.includes(file.type)) {
              validFiles.push(file);
            } else {
              invalidFiles.push(file);
            }
          }
          
          if (invalidFiles.length > 0) {
            // Update button styling for error
            if (customFileButton) {
              customFileButton.className = 'inline-flex items-center px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 cursor-pointer';
            }
            
            // Update file selection display
            if (fileSelectionDisplay) {
              fileSelectionDisplay.className = 'ml-3 text-sm text-red-600 font-medium';
              fileSelectionDisplay.textContent = `Invalid file type(s): ${invalidFiles.map(f => f.name).join(', ')}`;
            }
            
            const feedback = document.createElement('div');
            feedback.id = 'file-selection-feedback';
            feedback.className = 'mt-2 text-sm text-red-600 font-medium';
            feedback.innerHTML = `âŒ Only PNG and JPEG files are allowed.`;
            event.target.parentElement.appendChild(feedback);
            
            // Clear the input
            event.target.value = '';
            return;
          }
          
          if (validFiles.length > 0) {
            // Update button styling for success
            if (customFileButton) {
              customFileButton.className = 'inline-flex items-center px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 cursor-pointer';
            }
            
            // Update file selection display
            if (fileSelectionDisplay) {
              fileSelectionDisplay.className = 'ml-3 text-sm text-green-600 font-medium';
              fileSelectionDisplay.textContent = `${validFiles.length} file(s) selected: ${validFiles.map(f => f.name).join(', ')}`;
            }
            
            // Show success message
            const feedback = document.createElement('div');
            feedback.id = 'file-selection-feedback';
            feedback.className = 'mt-2 text-sm text-green-600 font-medium';
            event.target.parentElement.appendChild(feedback);
          }
        } else {
          // Reset styling if no files
          if (customFileButton) {
            customFileButton.className = 'inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 cursor-pointer';
          }
          if (fileSelectionDisplay) {
            fileSelectionDisplay.className = 'ml-3 text-sm text-gray-600';
            fileSelectionDisplay.textContent = 'No files selected';
          }
        }
      });
    }
  });
</script> 