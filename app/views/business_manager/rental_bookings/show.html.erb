<%# app/views/business_manager/rental_bookings/show.html.erb %>
<div class="container mx-auto px-4 py-4 sm:py-8">
  <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Rental Booking #<%= @rental_booking.booking_number %></h1>
      <div class="flex flex-wrap gap-2 mt-2">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
          <%= case @rental_booking.status
              when 'pending_deposit' then 'bg-yellow-100 text-yellow-800'
              when 'deposit_paid' then 'bg-blue-100 text-blue-800'
              when 'checked_out' then 'bg-purple-100 text-purple-800'
              when 'overdue' then 'bg-red-100 text-red-800'
              when 'returned' then 'bg-orange-100 text-orange-800'
              when 'completed' then 'bg-green-100 text-green-800'
              when 'cancelled' then 'bg-gray-100 text-gray-800'
              else 'bg-gray-100 text-gray-800'
              end %>">
          <%= @rental_booking.status.titleize.gsub('_', ' ') %>
        </span>
        <% if @rental_booking.overdue? %>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
            ‚ö†Ô∏è OVERDUE
          </span>
        <% end %>
      </div>
    </div>
    <div class="flex gap-2">
      <%= link_to 'Back to Bookings', business_manager_rental_bookings_path, 
            class: "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Rental Item -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Rental Item</h2>
        <div class="flex items-start gap-4">
          <% if @rental_booking.product.images.attached? %>
            <%= image_tag @rental_booking.product.images.first.variant(:thumb), class: "w-20 h-20 object-cover rounded-lg" %>
          <% else %>
            <div class="w-20 h-20 bg-gray-100 rounded-lg flex items-center justify-center">
              <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
            </div>
          <% end %>
          <div>
            <%= link_to @rental_booking.rental_name, business_manager_rental_path(@rental_booking.product), 
                  class: "text-lg font-semibold text-blue-600 hover:text-blue-800" %>
            <div class="text-sm text-gray-500 mt-1">
              Quantity: <%= @rental_booking.quantity %>
            </div>
          </div>
        </div>
      </div>

      <!-- Customer Info -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Customer Information</h2>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <span class="text-sm text-gray-500">Name</span>
            <div class="font-medium"><%= @rental_booking.customer_full_name || 'Guest' %></div>
          </div>
          <div>
            <span class="text-sm text-gray-500">Email</span>
            <div class="font-medium"><%= @rental_booking.customer_email || '-' %></div>
          </div>
          <div>
            <span class="text-sm text-gray-500">Phone</span>
            <div class="font-medium"><%= @rental_booking.customer_phone || '-' %></div>
          </div>
        </div>
        <% if @rental_booking.customer_notes.present? %>
          <div class="mt-4 pt-4 border-t">
            <span class="text-sm text-gray-500">Customer Notes</span>
            <div class="mt-1 text-gray-700"><%= @rental_booking.customer_notes %></div>
          </div>
        <% end %>
      </div>

      <% if (deposit_document = @rental_booking.client_document)&.document_template.present? %>
        <%= render 'shared/template_preview_panel',
                   document_template: deposit_document.document_template,
                   client_document: deposit_document,
                   heading: 'Security Deposit Agreement' %>
      <% end %>

      <!-- Condition Reports -->
      <% if @condition_reports.any? %>
        <div class="bg-white shadow rounded-lg p-6">
          <h2 class="text-lg font-medium text-gray-900 mb-4">Condition Reports</h2>
          <div class="space-y-4">
            <% @condition_reports.each do |report| %>
              <div class="border rounded-lg p-4 <%= report.checkout? ? 'bg-blue-50 border-blue-200' : 'bg-orange-50 border-orange-200' %>">
                <div class="flex items-center justify-between mb-2">
                  <span class="font-medium text-gray-900">
                    <%= report.checkout? ? 'üì§ Check-out Report' : 'üì• Return Report' %>
                  </span>
                  <span class="text-sm text-gray-500">
                    <%= report.created_at.strftime('%b %d, %Y at %I:%M %p') %>
                  </span>
                </div>
                <div class="text-sm">
                  <div class="mb-2">
                    <span class="text-gray-500">Condition:</span>
                    <span class="font-medium ml-1"><%= report.condition_display %></span>
                  </div>
                  <% if report.notes.present? %>
                    <div class="mb-2">
                      <span class="text-gray-500">Notes:</span>
                      <span class="ml-1"><%= report.notes %></span>
                    </div>
                  <% end %>
                  <% if report.has_damage? %>
                    <div class="text-red-600 font-medium">
                      Damage Assessment: <%= number_to_currency(report.damage_assessment_amount) %>
                    </div>
                  <% end %>
                  <div class="text-gray-500 text-xs mt-2">
                    Processed by: <%= report.staff_name %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Actions -->
      <div class="bg-white shadow rounded-lg p-6" id="return-form">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Actions</h2>
        
        <% if @rental_booking.can_check_out? %>
          <div class="mb-4 p-4 bg-purple-50 rounded-lg">
            <h3 class="font-medium text-purple-900 mb-2">Check Out Rental</h3>
            <%= form_with url: check_out_business_manager_rental_booking_path(@rental_booking), method: :patch, local: true do |f| %>
              <div class="mb-3">
                <%= f.label :condition_notes, "Condition Notes", class: "block text-sm font-medium text-gray-700" %>
                <%= f.text_area :condition_notes, rows: 2, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500", placeholder: "Note any existing wear or damage..." %>
              </div>
              <%= f.submit 'Check Out Item', class: "px-4 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-md cursor-pointer" %>
            <% end %>
          </div>
        <% end %>
        
        <% if @rental_booking.can_return? %>
          <div class="mb-4 p-4 bg-orange-50 rounded-lg">
            <h3 class="font-medium text-orange-900 mb-2">Process Return</h3>
            <%= form_with url: process_return_business_manager_rental_booking_path(@rental_booking), method: :patch, local: true do |f| %>
              <div class="mb-3">
                <%= f.label :condition_rating, "Condition", class: "block text-sm font-medium text-gray-700" %>
                <%= f.select :condition_rating, RentalConditionReport::CONDITION_RATINGS.map { |c| [c.titleize, c] }, {}, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
              </div>
              <div class="mb-3">
                <%= f.label :return_notes, "Return Notes", class: "block text-sm font-medium text-gray-700" %>
                <%= f.text_area :return_notes, rows: 2, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500", placeholder: "Note any damage or issues..." %>
              </div>
              <div class="mb-3">
                <%= f.label :damage_amount, "Damage Amount (if any)", class: "block text-sm font-medium text-gray-700" %>
                <div class="mt-1 relative rounded-md shadow-sm">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <span class="text-gray-500 sm:text-sm">$</span>
                  </div>
                  <%= f.number_field :damage_amount, step: 0.01, min: 0, value: 0, class: "pl-7 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
                </div>
              </div>
              <%= f.submit 'Process Return', class: "px-4 py-2 text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 rounded-md cursor-pointer" %>
            <% end %>
          </div>
        <% end %>
        
        <% if @rental_booking.status_returned? %>
          <div class="mb-4 p-4 bg-green-50 rounded-lg">
            <h3 class="font-medium text-green-900 mb-2">Complete Rental</h3>
            <p class="text-sm text-green-700 mb-3">Mark this rental as fully completed after processing any refunds.</p>
            <%= button_to 'Mark as Completed', complete_business_manager_rental_booking_path(@rental_booking),
                  method: :patch,
                  class: "px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md" %>
          </div>
        <% end %>
        
        <% if @rental_booking.can_cancel? %>
          <div class="p-4 bg-red-50 rounded-lg">
            <h3 class="font-medium text-red-900 mb-2">Cancel Booking</h3>
            <%= form_with url: cancel_business_manager_rental_booking_path(@rental_booking), method: :patch, local: true, data: { confirm: 'Are you sure you want to cancel this booking?' } do |f| %>
              <div class="mb-3">
                <%= f.label :cancellation_reason, "Reason", class: "block text-sm font-medium text-gray-700" %>
                <%= f.text_field :cancellation_reason, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500" %>
              </div>
              <%= f.submit 'Cancel Booking', class: "px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md cursor-pointer" %>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- Timing -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Rental Period</h2>
        <div class="space-y-3">
          <div>
            <span class="text-sm text-gray-500">Start</span>
            <div class="font-medium"><%= @rental_booking.local_start_time&.strftime('%B %d, %Y at %I:%M %p') %></div>
          </div>
          <div>
            <span class="text-sm text-gray-500">End</span>
            <div class="font-medium"><%= @rental_booking.local_end_time&.strftime('%B %d, %Y at %I:%M %p') %></div>
          </div>
          <div>
            <span class="text-sm text-gray-500">Duration</span>
            <div class="font-medium"><%= @rental_booking.duration_display %></div>
          </div>
          <% if @rental_booking.actual_pickup_time.present? %>
            <div class="pt-3 border-t">
              <span class="text-sm text-gray-500">Actual Pickup</span>
              <div class="font-medium text-green-600"><%= @rental_booking.actual_pickup_time.strftime('%B %d, %Y at %I:%M %p') %></div>
            </div>
          <% end %>
          <% if @rental_booking.actual_return_time.present? %>
            <div>
              <span class="text-sm text-gray-500">Actual Return</span>
              <div class="font-medium <%= @rental_booking.actual_return_time > @rental_booking.end_time ? 'text-red-600' : 'text-green-600' %>">
                <%= @rental_booking.actual_return_time.strftime('%B %d, %Y at %I:%M %p') %>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Payment Summary -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Payment Summary</h2>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600">Rate (<%= @rental_booking.rate_type %>)</span>
            <span><%= number_to_currency(@rental_booking.rate_amount) %> √ó <%= @rental_booking.rate_quantity %></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Subtotal</span>
            <span><%= number_to_currency(@rental_booking.subtotal) %></span>
          </div>
          <% if @rental_booking.discount_amount.to_d > 0 %>
            <div class="flex justify-between text-green-600">
              <span>Discount</span>
              <span>-<%= number_to_currency(@rental_booking.discount_amount) %></span>
            </div>
          <% end %>
          <% if @rental_booking.tax_amount.to_d > 0 %>
            <div class="flex justify-between">
              <span class="text-gray-600">Tax</span>
              <span><%= number_to_currency(@rental_booking.tax_amount) %></span>
            </div>
          <% end %>
          <div class="flex justify-between font-semibold pt-2 border-t">
            <span>Total</span>
            <span class="text-green-600"><%= number_to_currency(@rental_booking.total_amount) %></span>
          </div>
        </div>
      </div>

      <!-- Security Deposit -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Security Deposit</h2>
        <div class="space-y-3">
          <div class="flex justify-between">
            <span class="text-gray-600">Amount</span>
            <span class="font-medium"><%= number_to_currency(@rental_booking.security_deposit_amount) %></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Status</span>
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium 
              <%= case @rental_booking.deposit_status
                  when 'pending' then 'bg-yellow-100 text-yellow-800'
                  when 'collected' then 'bg-blue-100 text-blue-800'
                  when 'partial_refund' then 'bg-orange-100 text-orange-800'
                  when 'full_refund' then 'bg-green-100 text-green-800'
                  when 'forfeited' then 'bg-red-100 text-red-800'
                  else 'bg-gray-100 text-gray-800'
                  end %>">
              <%= @rental_booking.deposit_status.titleize.gsub('_', ' ') %>
            </span>
          </div>
          <% if @rental_booking.late_fee_amount.to_d > 0 %>
            <div class="flex justify-between text-red-600">
              <span>Late Fee</span>
              <span>-<%= number_to_currency(@rental_booking.late_fee_amount) %></span>
            </div>
          <% end %>
          <% if @rental_booking.damage_fee_amount.to_d > 0 %>
            <div class="flex justify-between text-red-600">
              <span>Damage Fee</span>
              <span>-<%= number_to_currency(@rental_booking.damage_fee_amount) %></span>
            </div>
          <% end %>
          <% if @rental_booking.deposit_refund_amount.present? %>
            <div class="flex justify-between font-semibold pt-2 border-t text-green-600">
              <span>Refund Amount</span>
              <span><%= number_to_currency(@rental_booking.deposit_refund_amount) %></span>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Location -->
      <% if @rental_booking.location.present? %>
        <div class="bg-white shadow rounded-lg p-6">
          <h2 class="text-lg font-medium text-gray-900 mb-4">Pickup Location</h2>
          <div class="text-gray-700">
            <div class="font-medium"><%= @rental_booking.location.name %></div>
            <div class="text-sm text-gray-500 mt-1">
              <%= @rental_booking.location.address %><br>
              <%= @rental_booking.location.city %>, <%= @rental_booking.location.state %> <%= @rental_booking.location.zip %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Internal Notes -->
      <% if @rental_booking.notes.present? %>
        <div class="bg-white shadow rounded-lg p-6">
          <h2 class="text-lg font-medium text-gray-900 mb-4">Internal Notes</h2>
          <div class="text-gray-700 whitespace-pre-wrap text-sm"><%= @rental_booking.notes %></div>
        </div>
      <% end %>
    </div>
  </div>
</div>

