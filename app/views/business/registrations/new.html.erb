<div class="max-w-4xl mx-auto">
  <div class="bg-white shadow-lg rounded-lg p-6 md:p-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <h2 class="text-2xl md:text-3xl font-bold text-dark mb-2">Create Your Business Account</h2>
      <p class="text-gray-600">Join all of the businesses growing with BizBlasts</p>  
      <div class="text-gray-600 text-xs mt-2">
        Customers will never need a Bizblasts Customer account to book appointments or purchase products from your business
      </div>
    </div>

    <%# Google Sign-Up Button - For business, this pre-fills owner info %>
    <% if devise_mapping.omniauthable? && resource_class.omniauth_providers.include?(:google_oauth2) && !session[:omniauth_data] %>
      <div class="mb-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <p class="text-sm text-gray-700 mb-3">Speed up registration by signing up with Google:</p>
        <%= form_with url: user_google_oauth2_setup_path, method: :post, local: true, data: { turbo: false } do %>
          <%= hidden_field_tag :registration_type, 'business' %>
          <button type="submit" class="w-full flex items-center justify-center gap-3 bg-white border border-gray-300 rounded-lg px-4 py-3 text-gray-700 font-medium hover:bg-gray-50 hover:border-gray-400 transition-all focus:outline-none focus:ring-2 focus:ring-secondary focus:ring-offset-2 cursor-pointer">
            <svg class="h-5 w-5" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Sign up with Google
          </button>
        <% end %>
        <p class="text-xs text-gray-500 mt-2 text-center">We'll use your Google account for owner information. You'll still need to provide business details.</p>
      </div>

      <div class="relative mb-8">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-gray-300"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-2 bg-white text-gray-500">or fill in your details manually</span>
        </div>
      </div>
    <% end %>

    <%# Show OAuth pre-fill notice if coming from Google OAuth %>
    <% if session[:omniauth_data].present? %>
      <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
        <div class="flex items-center gap-2 text-green-700">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <span class="font-medium">Signed in with Google</span>
        </div>
        <p class="text-sm text-green-600 mt-1">Your Google account info has been pre-filled. Please complete the business details below.</p>
      </div>
    <% end %>

    <%= form_for(resource, as: resource_name, url: business_registration_path, local: true, class: "space-y-8", data: { turbo: false }) do |f| %>
      <%= render "devise/shared/error_messages", resource: resource %>

      <!-- Owner Information Section -->
      <div class="border-b border-gray-200 pb-8">
        <h3 class="text-xl font-semibold text-dark mb-6 flex items-center">
          <svg class="h-6 w-6 text-primary mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          Owner Information
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <%= f.label :first_name, class: "block text-sm font-medium text-dark mb-2" %>
            <%= f.text_field :first_name, required: true, 
                  class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" %>
          </div>

          <div>
            <%= f.label :last_name, class: "block text-sm font-medium text-dark mb-2" %>
            <%= f.text_field :last_name, required: true, 
                  class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" %>
          </div>

          <div class="md:col-span-2">
            <%= f.label :email, class: "block text-sm font-medium text-dark mb-2" %>
            <%= f.email_field :email, required: true, autocomplete: "email",
                  pattern: "[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$",
                  title: "Please enter a valid email address",
                  class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" %>
          </div>

          <%# Only show password fields if not coming from OAuth %>
          <% unless session[:omniauth_data].present? %>
            <div class="md:col-span-2">
              <%= f.label :password, class: "block text-sm font-medium text-dark mb-2" %>
              <% if @minimum_password_length %>
                <p class="text-xs text-gray-500 mb-1">(<%= @minimum_password_length %> characters minimum)</p>
              <% end %>
              <%= f.password_field :password, required: true, autocomplete: "new-password", 
                    class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" %>
            </div>

            <div class="md:col-span-2">
              <%= f.label :password_confirmation, class: "block text-sm font-medium text-dark mb-2" %>
              <%= f.password_field :password_confirmation, required: true, autocomplete: "new-password", 
                    class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Business Information Section -->
      <div class="border-b border-gray-200 pb-8">
        <h3 class="text-xl font-semibold text-dark mb-6 flex items-center">
          <svg class="h-6 w-6 text-primary mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
          </svg>
          Business Information
        </h3>

        <%= f.fields_for :business_attributes, resource.business || resource.build_business do |business_f| %>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="md:col-span-2">
              <%= business_f.label :name, "Business Name", class: "block text-sm font-medium text-dark mb-2" %>
              <%= business_f.text_field :name, required: true, 
                    class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" %>
            </div>

            <div>
              <%= business_f.label :industry, class: "block text-sm font-medium text-dark mb-2" do %>
                Industry
              <% end %>
              <%= business_f.text_field :industry, list: "industry-list", required: true, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" %>
              <datalist id="industry-list">
                <% Business.industries.values.sort.each do |industry_name| %>
                  <option value="<%= industry_name %>"><%= industry_name %></option>
                <% end %>
              </datalist>
            </div>

            <div>
              <%= business_f.label :phone, "Business Phone", class: "block text-sm font-medium text-dark mb-2" %>
              <%= business_f.telephone_field :phone, required: true,
                    pattern: "^(\+1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})$",
                    title: "Please enter a valid US phone number (e.g., (555) 123-4567 or 555-123-4567)",
                    placeholder: "(555) 123-4567",
                    class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" %>
            </div>

            <div class="md:col-span-2">
              <%= business_f.label :email, "Business Contact Email", class: "block text-sm font-medium text-dark mb-2" %>
              <%= business_f.email_field :email, required: true,
                    pattern: "[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$",
                    title: "Please enter a valid business email address",
                    class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" %>
            </div>

            <div>
              <%= business_f.label :address, class: "block text-sm font-medium text-dark mb-2" %>
              <%= business_f.text_field :address, required: true, 
                    class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" %>
            </div>

            <div>
              <%= business_f.label :city, class: "block text-sm font-medium text-dark mb-2" %>
              <%= business_f.text_field :city, required: true, 
                    class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" %>
            </div>

            <div>
              <%= business_f.label :state, class: "block text-sm font-medium text-dark mb-2" %>
              <%= business_f.text_field :state, list: "state-list", required: true, 
                    class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" %>
              <datalist id="state-list">
                <% %w[Alabama Alaska Arizona Arkansas California Colorado Connecticut Delaware Florida Georgia Hawaii Idaho Illinois Indiana Iowa Kansas Kentucky Louisiana Maine Maryland Massachusetts Michigan Minnesota Mississippi Missouri Montana Nebraska Nevada New\ Hampshire New\ Jersey New\ Mexico New\ York North\ Carolina North\ Dakota Ohio Oklahoma Oregon Pennsylvania Puerto\ Rico Rhode\ Island South\ Carolina South\ Dakota Tennessee Texas Utah Vermont Virginia Washington West\ Virginia Wisconsin Wyoming].each do |state_name| %>
                  <option value="<%= state_name %>"><%= state_name %></option>
                <% end %>
              </datalist>
            </div>

            <div>
              <%= business_f.label :zip, class: "block text-sm font-medium text-dark mb-2" %>
              <%= business_f.text_field :zip, required: true,
                    pattern: "[0-9]{5}(-[0-9]{4})?",
                    title: "Please enter a valid ZIP code (5 digits or 5+4 format, e.g., 12345 or 12345-6789)",
                    maxlength: "10",
                    class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" %>
            </div>

            <div class="md:col-span-2">
              <%= business_f.label :description, class: "block text-sm font-medium text-dark mb-2" %>
              <%= business_f.text_area :description, required: true, rows: 4, 
                    class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors resize-none" %>
            </div>

          </div>

          <!-- Simple pricing (no tiers) -->
          <div class="mt-8">
            <div class="p-5 bg-blue-50 border border-blue-200 rounded-xl">
              <h3 class="text-lg font-semibold text-dark mb-2">Simple, Transparent Pricing</h3>
              <ul class="text-sm text-gray-700 space-y-1">
                <li><span class="text-primary font-semibold">$0/month</span> to use BizBlasts</li>
                <li><span class="text-primary font-semibold">1% platform fee</span> on transactions you process through BizBlasts</li>
                <li><span class="text-gray-700 font-semibold">+ Stripe processing fees</span> (charged by Stripe)</li>
              </ul>
            </div>
          </div>

          <!-- Host Type Handling -->
          <%= business_f.hidden_field :host_type, value: 'subdomain', id: 'host_type_input' %>

          <!-- Subdomain field for all tiers -->
          <div class="mt-6">
            <%= business_f.label :subdomain, "Subdomain", class: "block text-sm font-medium text-dark mb-1" %>
            <%= business_f.text_field :subdomain, placeholder: "your-biz", class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors", id: "registration_subdomain_field" %>
            <p class="text-xs text-gray-500 mt-1">Will appear as your-biz.bizblasts.com</p>
          </div>

          <!-- Custom Domain Ownership Checkbox -->
          <div class="mt-6">
            <div class="flex items-start">
              <%= business_f.check_box :custom_domain_owned, { class: "mt-1 h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary cursor-pointer", id: "custom_domain_owned_checkbox" }, "1", "0" %>
              <label for="custom_domain_owned_checkbox" class="ml-3 text-sm text-gray-700 cursor-pointer">
                <span class="font-medium">I have my own custom domain already</span>
                <br><span class="text-xs text-gray-500">Check this if you already own a domain you want to use (e.g., yourbusiness.com)</span>
              </label>
            </div>
          </div>

          <!-- Custom domain fields (shown when checkbox is checked) -->
          <div class="mt-4 hidden" id="custom_domain_fields">
            <div id="reg_custom_group" class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
              <%= business_f.label :hostname, "Your Custom Domain", class: "block text-sm font-medium text-dark mb-1" %>
              <%= business_f.text_field :hostname, placeholder: "yourdomain.com", class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors bg-white", id: "custom_domain_input" %>
              <p class="text-xs text-gray-500 mt-1">Enter the domain you own (without www or https://)</p>

              <!-- Advanced: Canonical Preference -->
              <div class="mt-4 p-3 bg-white border border-gray-200 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                  <%= business_f.label :canonical_preference, "Canonical URL (Advanced)", class: "text-sm font-medium text-dark" %>
                  <span class="text-xs text-gray-500">Optional</span>
                </div>
                <div class="space-y-2">
                  <div class="flex items-center">
                    <%= business_f.radio_button :canonical_preference, 'www', checked: true, class: "h-4 w-4 text-primary border-gray-300 focus:ring-primary cursor-pointer" %>
                    <label for="user_business_attributes_canonical_preference_www" class="ml-2 text-sm text-gray-700 cursor-pointer">
                      <code class="bg-gray-100 px-1 rounded text-primary">www.yourdomain.com</code> (Recommended)
                    </label>
                  </div>
                  <div class="flex items-center">
                    <%= business_f.radio_button :canonical_preference, 'apex', class: "h-4 w-4 text-primary border-gray-300 focus:ring-primary cursor-pointer" %>
                    <label for="user_business_attributes_canonical_preference_apex" class="ml-2 text-sm text-gray-700 cursor-pointer">
                      <code class="bg-gray-100 px-1 rounded text-primary">yourdomain.com</code> (Advanced)
                    </label>
                  </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">Choose your preferred canonical URL. Both versions will work, but one will redirect to the other for SEO consistency.</p>
              </div>
            </div>
          </div>

        <% end %>
      </div>

      <!-- Customize Your Dashboard Section (Collapsible) -->
      <div class="border-t border-gray-200 pt-6 mt-6">
        <div class="cursor-pointer" id="sidebar-section-toggle">
          <h3 class="text-lg font-semibold text-dark mb-2 flex items-center justify-between">
            <span class="flex items-center">
              <svg class="h-6 w-6 text-primary mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
              </svg>
              Customize Your Dashboard
              <span class="text-sm font-normal text-gray-500 ml-2">(Optional)</span>
            </span>
            <svg id="sidebar-section-chevron" class="h-5 w-5 text-gray-500 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </h3>
        </div>
        <p class="text-sm text-gray-600 mb-4">Choose which features appear in your sidebar. You can change this later in Settings.</p>

        <div id="sidebar-selection-content" class="hidden">
          <!-- Hidden field to track if user interacted with sidebar selection -->
          <%= hidden_field_tag :sidebar_customized, "0", id: "sidebar_customized" %>

          <!-- Select All / Deselect All Toggle -->
          <div class="flex items-center mb-4 pb-3 border-b border-gray-100">
            <button type="button" id="select-all-sidebar" class="text-sm text-primary hover:text-blue-700 font-medium mr-4 cursor-pointer">
              Select All
            </button>
            <button type="button" id="deselect-all-sidebar" class="text-sm text-gray-600 hover:text-gray-800 font-medium cursor-pointer">
              Deselect All
            </button>
          </div>

          <!-- Sidebar Items Grid -->
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
            <% sidebar_registration_items.each do |item| %>
              <div class="flex items-center">
                <%= check_box_tag "sidebar_items[]", item[:key], true,
                      id: "sidebar_item_#{item[:key]}",
                      class: "sidebar-item-checkbox h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary" %>
                <label for="sidebar_item_<%= item[:key] %>" class="ml-2 text-sm text-gray-700 cursor-pointer">
                  <%= item[:label] %>
                </label>
              </div>
            <% end %>
          </div>

          <p class="text-xs text-gray-500 mt-4">
            Note: Some items may not appear if they require specific features to be enabled.
          </p>
        </div>
      </div>

      <!-- Legal Agreement Section -->
      <div class="border-t border-gray-200 pt-6">
        <h3 class="text-lg font-semibold text-dark mb-4 flex items-center">
          <svg class="h-6 w-6 text-primary mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Legal Agreements
        </h3>
        <div class="space-y-3 bg-gray-50 p-4 rounded-lg">
          <div class="flex items-start">
            <%= check_box_tag 'policy_acceptances[terms_of_service]', '1', false, 
                  required: true, 
                  class: "mt-1 h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary" %>
            <label for="policy_acceptances_terms_of_service" class="ml-3 text-sm text-gray-700">
              I agree to the 
              <%= link_to "Terms of Service", terms_path, target: "_blank", 
                    class: "text-primary hover:underline font-medium" %>
              (platform usage rules, billing terms)
              <span class="text-red-500">*</span>
            </label>
          </div>
          
          <div class="flex items-start">
            <%= check_box_tag 'policy_acceptances[privacy_policy]', '1', false, 
                  required: true, 
                  class: "mt-1 h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary" %>
            <label for="policy_acceptances_privacy_policy" class="ml-3 text-sm text-gray-700">
              I agree to the 
              <%= link_to "Privacy Policy", privacypolicy_path, target: "_blank", 
                    class: "text-primary hover:underline font-medium" %>
              (how you handle business data)
              <span class="text-red-500">*</span>
            </label>
          </div>
          
          <div class="flex items-start">
            <%= check_box_tag 'policy_acceptances[acceptable_use_policy]', '1', false, 
                  required: true, 
                  class: "mt-1 h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary" %>
            <label for="policy_acceptances_acceptable_use_policy" class="ml-3 text-sm text-gray-700">
              I agree to the 
              <%= link_to "Acceptable Use Policy", acceptableusepolicy_path, target: "_blank", 
                    class: "text-primary hover:underline font-medium" %>
              (what you can/cannot do on platform)
              <span class="text-red-500">*</span>
            </label>
          </div>
          
          <div class="flex items-start">
            <%= check_box_tag 'policy_acceptances[return_policy]', '1', false, 
                  required: true, 
                  class: "mt-1 h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary" %>
            <label for="policy_acceptances_return_policy" class="ml-3 text-sm text-gray-700">
              I agree to the 
              <%= link_to "Return Policy", returnpolicy_path, target: "_blank", 
                    class: "text-primary hover:underline font-medium" %>
              (subscription cancellation/refund terms)
              <span class="text-red-500">*</span>
            </label>
          </div>
          
          <!-- Notification Consent Checkbox -->
          <div class="flex items-start border-t border-gray-200 pt-3 mt-3">
            <%= f.check_box :bizblasts_notification_consent, 
                  { class: "mt-1 h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary" }, 
                  "1", "0" %>
            <label for="user_bizblasts_notification_consent" class="ml-3 text-sm text-gray-700">
              I would like to receive notifications from BizBlasts (email confirmations, text alerts, system updates, business tips, etc.)
              <br><span class="text-xs text-gray-500">You can change this preference anytime in your account settings. Unchecking this will disable all notifications (email and text).</span>
            </label>
          </div>
        </div>
      </div>

      <br>

      <!-- Submit Button -->
      <div class="text-center">
        <%= f.submit "Create Business Account", class: "bg-secondary hover:bg-teal-600 text-white font-bold py-4 px-8 rounded-lg text-lg transition-colors focus:outline-none focus:ring-2 focus:ring-secondary focus:ring-offset-2 cursor-pointer" %>
      </div>
    <% end %>

    <%# Remove the Devise shared links section %>
    <%# render "devise/shared/links" %>
  </div>
</div>

<%# Basic controller for toggling fields %>
<div data-controller="business-registration">
  <%# Controller target is implicitly the form fields_for :business %>
</div>

<script type="text/javascript">
  (function() {
    const HOST_TYPE_INIT_KEY = 'hostTypeInitialized';
    const VALIDATION_INIT_KEY = 'validationInitialized';
    
    function initializeBusinessRegistrationHostType() {
      const hostTypeHidden = document.getElementById('host_type_input');
      const subdomainField = document.querySelector('input[name*="[subdomain]"]');
      const customDomainField = document.querySelector('input[name*="[hostname]"]');

      if (!hostTypeHidden) return;
      
      // Prevent duplicate initialization
      if (hostTypeHidden.dataset[HOST_TYPE_INIT_KEY]) return;
      hostTypeHidden.dataset[HOST_TYPE_INIT_KEY] = 'true';

      function recomputeHostType() {
        const hasCustomDomain = customDomainField && customDomainField.value && customDomainField.value.trim().length > 0;
        const hasSubdomain = subdomainField && subdomainField.value && subdomainField.value.trim().length > 0;

        if (hasCustomDomain) {
          hostTypeHidden.value = 'custom_domain';
        } else if (hasSubdomain) {
          hostTypeHidden.value = 'subdomain';
        } else {
          hostTypeHidden.value = 'subdomain';
        }
      }

      if (customDomainField) customDomainField.addEventListener('input', recomputeHostType);
      if (subdomainField) subdomainField.addEventListener('input', recomputeHostType);
      recomputeHostType();
    }

    // Enhanced form validation functions
    function validateField(input, isValid, errorMessage) {
      const existingError = input.parentElement.querySelector('.field-error');
      if (existingError) {
        existingError.remove();
      }

      if (!isValid) {
        input.classList.add('border-red-500', 'ring-red-500');
        input.classList.remove('border-gray-300', 'focus:border-primary', 'focus:ring-primary');
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'field-error text-red-500 text-xs mt-1';
        errorDiv.textContent = errorMessage;
        input.parentElement.appendChild(errorDiv);
      } else {
        input.classList.remove('border-red-500', 'ring-red-500');
        input.classList.add('border-gray-300', 'focus:border-primary', 'focus:ring-primary');
      }
    }

    function validateEmail(email) {
      const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;
      return emailRegex.test(email);
    }

    function validatePhone(phone) {
      const phoneRegex = /^(\+1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})$/;
      return phoneRegex.test(phone);
    }

    function validateZip(zip) {
      const zipRegex = /^[0-9]{5}(-[0-9]{4})?$/;
      return zipRegex.test(zip);
    }

    // Add real-time validation listeners
    function initializeBusinessRegistrationValidation() {
      const form = document.querySelector('form[action*="business"]');
      if (!form) return;
      
      // Prevent duplicate initialization
      if (form.dataset[VALIDATION_INIT_KEY]) return;
      form.dataset[VALIDATION_INIT_KEY] = 'true';
      
      // Email validation
      const emailFields = document.querySelectorAll('input[type="email"]');
      emailFields.forEach(field => {
        field.addEventListener('blur', function() {
          if (this.value) {
            const isValid = validateEmail(this.value);
            validateField(this, isValid, 'Please enter a valid email address');
          }
        });
      });

      // Phone validation
      const phoneFields = document.querySelectorAll('input[type="tel"]');
      phoneFields.forEach(field => {
        field.addEventListener('blur', function() {
          if (this.value) {
            const isValid = validatePhone(this.value);
            validateField(this, isValid, 'Please enter a valid US phone number (e.g., (555) 123-4567)');
          }
        });
      });

      // ZIP code validation
      const zipFields = document.querySelectorAll('input[name*="[zip]"]');
      zipFields.forEach(field => {
        field.addEventListener('blur', function() {
          if (this.value) {
            const isValid = validateZip(this.value);
            validateField(this, isValid, 'Please enter a valid ZIP code (5 digits or 5+4 format)');
          }
        });
      });

      // Phone number formatting
      phoneFields.forEach(field => {
        field.addEventListener('input', function() {
          let value = this.value.replace(/\D/g, ''); // Remove non-digits
          if (value.length >= 6) {
            value = value.replace(/(\d{3})(\d{3})(\d+)/, '($1) $2-$3');
          } else if (value.length >= 3) {
            value = value.replace(/(\d{3})(\d+)/, '($1) $2');
          }
          this.value = value;
        });
      });

      // ZIP code formatting
      zipFields.forEach(field => {
        field.addEventListener('input', function() {
          // Remove all non-digits and hyphens, then remove any hyphens that aren't in the right place
          let value = this.value.replace(/[^0-9-]/g, '').replace(/-+/g, '-');
          
          // Remove hyphens that aren't after exactly 5 digits
          value = value.replace(/^(\d{1,4})-/, '$1').replace(/(\d{5})-+(\d)/, '$1-$2');
          
          // If we have more than 5 digits without a hyphen, add one
          if (value.length > 5 && !value.includes('-')) {
            value = value.replace(/(\d{5})(\d+)/, '$1-$2');
          }
          
          // Limit to 10 characters max (12345-6789)
          if (value.length > 10) {
            value = value.substring(0, 10);
          }
          
          this.value = value;
        });
      });
    }

    function initAll() {
      initializeBusinessRegistrationHostType();
      initializeBusinessRegistrationValidation();
    }

    // Run immediately if DOM is ready (handles Turbo navigation)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAll);
    } else {
      initAll();
    }
    
    // Also listen for turbo:load for subsequent Turbo navigations
    document.addEventListener('turbo:load', initAll);
  })();
</script>

<!-- Subdomain Availability Checker for Registration -->
<script type="text/javascript">
  (function() {
    const SUBDOMAIN_INIT_KEY = 'subdomainCheckerInitialized';
    
    function initializeRegistrationSubdomainChecker() {
      const subdomainInput = document.getElementById('registration_subdomain_field');
      
      if (!subdomainInput) return;
      
      // Prevent duplicate initialization
      if (subdomainInput.dataset[SUBDOMAIN_INIT_KEY]) return;
      subdomainInput.dataset[SUBDOMAIN_INIT_KEY] = 'true';
      
      let checkTimeout;
      let lastCheckedValue = '';
      
      function showValidationMessage(input, message, type = 'error') {
        // Remove existing validation messages
        const existingMessage = input.parentNode.querySelector('.subdomain-validation');
        if (existingMessage) {
          existingMessage.remove();
        }

        if (!message) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = `subdomain-validation text-xs mt-1 ${type === 'success' ? 'text-green-600' : type === 'warning' ? 'text-yellow-600' : 'text-red-600'}`;

        // SECURITY FIX (Alert #25 - CWE-79): Use textContent instead of innerHTML
        // This prevents XSS attacks by treating the message as plain text only.
        // Validation messages don't need HTML rendering - they're all plain text.
        messageDiv.textContent = message;

        input.parentNode.appendChild(messageDiv);
      }
      
      function validateSubdomainFormat(subdomain) {
        if (!subdomain) return { valid: false, message: '' };
        
        // Check length (3-63 characters)
        if (subdomain.length < 3) {
          return { valid: false, message: 'Subdomain must be at least 3 characters long' };
        }
        if (subdomain.length > 63) {
          return { valid: false, message: 'Subdomain must be 63 characters or less' };
        }
        
        // Check format: alphanumeric and hyphens, no hyphens at start/end
        const validFormat = /^[a-z0-9]([a-z0-9-]*[a-z0-9])?$/.test(subdomain);
        if (!validFormat) {
          return { valid: false, message: 'Only lowercase letters, numbers, and hyphens allowed. Cannot start or end with hyphen' };
        }
        
        // Check for reserved words
        const reserved = ['www', 'mail', 'ftp', 'admin', 'root', 'api', 'app', 'support', 'help', 'blog', 'shop', 'store', 'manage', 'settings', 'dashboard'];
        if (reserved.includes(subdomain.toLowerCase())) {
          return { valid: false, message: 'This subdomain is reserved and cannot be used' };
        }
        
        return { valid: true, message: '' };
      }
      
      async function checkSubdomainAvailability(subdomain) {
        try {
          const response = await fetch(`/subdomains/check?subdomain=${encodeURIComponent(subdomain)}`, {
            method: 'GET',
            headers: { 'Accept': 'application/json' }
          });
          
          const data = await response.json();
          return data;
        } catch (error) {
          console.error('Error checking subdomain availability:', error);
          return { available: false, message: 'Unable to check availability. Please try again.' };
        }
      }
      
      function handleSubdomainCheck() {
        const currentValue = subdomainInput.value.toLowerCase().trim();
        
        // Skip if value hasn't changed or is empty
        if (currentValue === lastCheckedValue || !currentValue) {
          if (!currentValue) showValidationMessage(subdomainInput, '');
          return;
        }
        
        lastCheckedValue = currentValue;
        
        // Format validation first
        const formatCheck = validateSubdomainFormat(currentValue);
        if (!formatCheck.valid) {
          showValidationMessage(subdomainInput, formatCheck.message, 'error');
          return;
        }
        
        // Show checking message
        showValidationMessage(subdomainInput, '⏳ Checking availability...', 'warning');
        
        // Check availability
        checkSubdomainAvailability(currentValue).then(result => {
          if (result.available) {
            showValidationMessage(subdomainInput, '✅ Available! Will appear as ' + currentValue + '.bizblasts.com', 'success');
          } else {
            showValidationMessage(subdomainInput, '❌ ' + (result.message || 'This subdomain is not available'), 'error');
          }
        });
      }
      
      // Add event listeners
      subdomainInput.addEventListener('input', function() {
        clearTimeout(checkTimeout);
        checkTimeout = setTimeout(handleSubdomainCheck, 500); // Debounce 500ms
      });
      
      subdomainInput.addEventListener('blur', function() {
        clearTimeout(checkTimeout);
        handleSubdomainCheck();
      });
    }
    
    // Run immediately if DOM is ready (handles Turbo navigation)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeRegistrationSubdomainChecker);
    } else {
      initializeRegistrationSubdomainChecker();
    }
    
    // Also listen for turbo:load for subsequent Turbo navigations
    document.addEventListener('turbo:load', initializeRegistrationSubdomainChecker);
  })();
</script>

<script type="text/javascript">
  (function() {
    const CUSTOM_DOMAIN_INIT_KEY = 'customDomainToggleInitialized';
    
    function initializeCustomDomainToggle() {
      const checkbox = document.getElementById('custom_domain_owned_checkbox');
      const customDomainFields = document.getElementById('custom_domain_fields');

      if (!checkbox || !customDomainFields) return;
      
      // Prevent duplicate initialization
      if (checkbox.dataset[CUSTOM_DOMAIN_INIT_KEY]) return;
      checkbox.dataset[CUSTOM_DOMAIN_INIT_KEY] = 'true';

      function toggleCustomDomainFields() {
        if (checkbox.checked) {
          customDomainFields.classList.remove('hidden');
        } else {
          customDomainFields.classList.add('hidden');
          // Clear the custom domain input when hiding
          const customDomainInput = document.getElementById('custom_domain_input');
          if (customDomainInput) {
            customDomainInput.value = '';
          }
        }
      }

      // Listen for checkbox changes
      checkbox.addEventListener('change', toggleCustomDomainFields);

      // Handle initial state (in case checkbox is pre-checked)
      toggleCustomDomainFields();
    }

    // Run immediately if DOM is ready (handles Turbo navigation)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeCustomDomainToggle);
    } else {
      initializeCustomDomainToggle();
    }
    
    // Also listen for turbo:load for subsequent Turbo navigations
    document.addEventListener('turbo:load', initializeCustomDomainToggle);
  })();
</script>

<script type="text/javascript">
  (function() {
    // Use a flag to prevent duplicate event listener attachment
    const INIT_KEY = 'sidebarSelectionInitialized';
    
    function initializeSidebarSelection() {
      const sectionToggle = document.getElementById('sidebar-section-toggle');
      const sectionContent = document.getElementById('sidebar-selection-content');
      const chevron = document.getElementById('sidebar-section-chevron');
      const selectAllBtn = document.getElementById('select-all-sidebar');
      const deselectAllBtn = document.getElementById('deselect-all-sidebar');
      const checkboxes = document.querySelectorAll('.sidebar-item-checkbox');
      const sidebarCustomizedField = document.getElementById('sidebar_customized');

      if (!sectionToggle || !sectionContent) return;
      
      // Prevent duplicate initialization
      if (sectionToggle.dataset[INIT_KEY]) return;
      sectionToggle.dataset[INIT_KEY] = 'true';

      // Mark sidebar as customized when user interacts
      function markAsCustomized() {
        if (sidebarCustomizedField) {
          sidebarCustomizedField.value = "1";
        }
      }

      // Toggle section visibility
      sectionToggle.addEventListener('click', function() {
        sectionContent.classList.toggle('hidden');
        if (chevron) chevron.classList.toggle('rotate-180');
      });

      // Track checkbox changes to mark as customized
      checkboxes.forEach(cb => {
        cb.addEventListener('change', markAsCustomized);
      });

      // Select All functionality
      if (selectAllBtn) {
        selectAllBtn.addEventListener('click', function(e) {
          e.preventDefault();
          markAsCustomized();
          checkboxes.forEach(cb => cb.checked = true);
        });
      }

      // Deselect All functionality
      if (deselectAllBtn) {
        deselectAllBtn.addEventListener('click', function(e) {
          e.preventDefault();
          markAsCustomized();
          checkboxes.forEach(cb => cb.checked = false);
        });
      }
    }

    // Run immediately if DOM is ready (handles Turbo navigation)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeSidebarSelection);
    } else {
      // DOM is already ready, run now
      initializeSidebarSelection();
    }
    
    // Also listen for turbo:load for subsequent Turbo navigations
    document.addEventListener('turbo:load', initializeSidebarSelection);
  })();
</script> 