<!DOCTYPE html>
<html>
  <head>
    <% unless Rails.env.test? %>
      <script src="https://app.termly.io/resource-blocker/a04fa7ee-1569-4641-a484-951b2d9c587e?autoBlock=on"></script>
    <% end %>
    <title><%= content_for(:title) || "BizBlasts" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%= favicon_link_tag "icon.png", rel: "icon", type: "image/png" %>
    <%= favicon_link_tag "icon.svg", rel: "icon", type: "image/svg+xml" %>
    <%= favicon_link_tag "icon.png", rel: "apple-touch-icon", sizes: "180x180" %>

    <%# Stylesheet: Tailwind output then custom application styles %>
    <%= stylesheet_link_tag "tailwind", data: { "turbo-track": "reload" } %>
    <%= stylesheet_link_tag "custom", data: { "turbo-track": "reload" } %>
    
    <% begin %>
      <%= javascript_include_tag "application", defer: true %>
    <% rescue => e %>
      <% Rails.logger.error "Failed to load JavaScript with helper: #{e.message}" %>
      <script src="/assets/application.js" defer></script>
    <% end %>
  </head>

  <body>
    <%# Navigation Header %>
    <nav class="bg-white border-b border-gray-200 px-4 py-3 mb-4 shadow-sm">
      <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center min-w-0 flex-shrink-0">
          <%# Logo and Home Link %>
          <% if request.subdomain.present? && request.subdomain != 'www' && ActsAsTenant.current_tenant %>
            <%= link_to tenant_root_path, class: "flex items-center hover:opacity-80 transition-opacity" do %>
              <% begin %>
                <%= image_tag "bizblasts-logo.svg", alt: "BizBlasts", class: "h-10 w-auto mr-3" %>
              <% rescue => e %>
                <img src="<%= asset_path('bizblasts-logo.svg') rescue '/bizblasts-logo.svg' %>" 
                     alt="BizBlasts" class="h-10 w-auto mr-3" />
              <% end %>
              <span class="font-bold text-lg text-primary whitespace-nowrap"><%= ActsAsTenant.current_tenant.name %></span>
            <% end %>
          <% else %>
            <%= link_to root_path, class: "flex items-center hover:opacity-80 transition-opacity" do %>
              <span class="font-bold text-lg text-primary whitespace-nowrap">BizBlasts</span>
            <% end %>
          <% end %>
        </div>
        <div>
          <% if user_signed_in? %>
            <span class="mr-4 text-gray-700">Welcome, <%= current_user.first_name %>!</span>
            
            <%# Conditional Dashboard Link %>
            <% dashboard_text = "Dashboard" %>
            <% dashboard_path = root_path # Default fallback %>
            
            <% if request.subdomain.present? && request.subdomain != 'www' %>
              <%# On a Tenant Subdomain %>
              <% if current_user.manager? || current_user.staff? %>
                <%# Business user on tenant page - link to manager dashboard %>
                <% dashboard_text = "Manage Business" %>
                <% dashboard_path = business_manager_dashboard_path # Relative path within subdomain %>
              <% else %>
                <%# Client or other user on tenant page - link to main dashboard %>
                <% dashboard_path = main_domain_url_for('/dashboard') %>
              <% end %>
            <% else %>
              <%# On Main Domain %>
              <% if current_user.client? %>
                <%# Client on main page - link to client dashboard %>
                <% dashboard_path = dashboard_path() %>
              <% elsif current_user.manager? || current_user.staff? %>
                <%# Business user on main page - link to their tenant's management dashboard %>
                <% business = current_user.business %>
                <% dashboard_text = "Manage Business" %>
                <% if Rails.env.development? || Rails.env.test? %>
                  <% if business.host_type_subdomain? %>
                    <% dashboard_path = "http://#{business.hostname}.lvh.me:#{request.port}/manage/dashboard" %>
                  <% else %>
                    <% dashboard_path = "http://#{business.hostname}:#{request.port}/manage/dashboard" %>
                  <% end %>
                <% else %>
                  <% if business.host_type_custom_domain? %>
                    <% dashboard_path = "#{request.protocol}#{business.hostname}/manage/dashboard" %>
                  <% else %>
                    <% dashboard_path = "#{request.protocol}#{business.hostname}.bizblasts.com/manage/dashboard" %>
                  <% end %>
                <% end %>
              <% else %>
                <%# Other user with no business - fallback %>
                <% dashboard_path = root_path %>
              <% end %>
            <% end %>
            
            <%= link_to dashboard_text, dashboard_path, class: "mr-4 text-primary hover:underline" %>
            <%= link_to "Sign out", destroy_user_session_path, data: { turbo_method: :delete }, class: "text-error hover:underline" %>
          <% else %>
            <%# Show login and signup buttons when user is not signed in %>
            <div class="flex items-stretch md:items-center space-x-2 md:space-x-0 md:space-x-3">
              <%= link_to "Sign In", new_user_session_path, class: "bg-white border border-primary text-primary px-1 py-1 md:px-4 md:py-2 rounded-lg font-medium hover:bg-gray-50 transition-colors duration-200 text-center text-xs md:text-base" %>
              <%= link_to "Client Sign Up", new_client_registration_path, class: "bg-accent hover:bg-orange-600 text-white px-1 py-1 md:px-4 md:py-2 rounded-lg font-medium transition-colors duration-200 text-center text-xs md:text-base" %>
              <%= link_to "Business Sign Up", new_business_registration_path, class: "bg-secondary hover:bg-teal-600 text-white px-1 py-1 md:px-4 md:py-2 rounded-lg font-medium transition-colors duration-200 text-center text-xs md:text-base" %>
            </div>
          <% end %>
        </div>
      </div>
      
      <div class="container mx-auto mt-2">
        <ul class="flex space-x-4">
          <%# Show cart link if there are items in the session cart (for both signed-in and guest users) %>
          <% if session[:cart].present? && session[:cart].any? %>
            <li><%= link_to "Cart", cart_path, class: "text-primary hover:underline" %></li>
          <% end %>
          
          <% if user_signed_in? %>
            <% if current_user.client? %>
              <% if request.subdomain.present? && request.subdomain != 'www' && ActsAsTenant.current_tenant %>
                <li><%= link_to "My Bookings", tenant_my_bookings_path, class: "text-primary hover:underline" %></li>
                <li><%= link_to "My Transactions", transactions_path, class: "text-primary hover:underline" %></li>
                <li><%= link_to "Book Appointment", tenant_calendar_path, class: "text-primary hover:underline" %></li>
                <li><%= link_to "View All Businesses", main_domain_url_for('/businesses'), class: "text-primary hover:underline" %></li>
                
                <li><%= link_to "Settings", settings_url_for_client, class: "text-primary hover:underline" %></li>
              <% else %>
                <li><%= link_to "My Bookings", client_bookings_path, class: "text-primary hover:underline" %></li>
                <li><%= link_to "My Transactions", transactions_path, class: "text-primary hover:underline" %></li>
                <li><%= link_to "Find Businesses", businesses_path, class: "text-primary hover:underline" %></li>
                
                <li><%= link_to "Settings", settings_url_for_client, class: "text-primary hover:underline" %></li>
              <% end %>
            <% end %>
          <% end %>
        </ul>
      </div>
    </nav>

    <%# Render flash messages %>
    <div class="container mx-auto px-4">
      <% flash.each do |type, msg| %>
        <div class="flash-message flash-<%= type %> mb-4 p-3 rounded 
                    <%= type == 'notice' ? 'bg-success text-white' : '' %> 
                    <%= type == 'alert' ? 'bg-error text-white' : '' %>
             role="alert">
          <%= msg %>
        </div>
      <% end %>
    </div>

    <main class="container mx-auto px-4">
      <%= yield %>
    </main>

    <div class="container mx-auto px-4 text-center text-sm text-gray-500 mt-8">
      <a href="#" class="termly-display-preferences">Consent Preferences</a>
    </div>

    <%# Policy Acceptance Modal %>
    <% if user_signed_in? %>
      <%= render 'shared/policy_acceptance_modal' %>
      
      <%# Fallback script to ensure modal shows when needed %>
      <script>
        // Fallback policy modal check
        document.addEventListener('DOMContentLoaded', function() {
          // Small delay to let other scripts initialize
          setTimeout(function() {
            const modal = document.getElementById('policy-acceptance-modal');
            if (modal) {
              console.log('[PolicyFallback] Checking if modal should be visible...');
              
              // Check if modal should be shown by calling the policy status
              fetch('/policy_status', {
                headers: {
                  'Accept': 'application/json',
                  'X-CSRF-Token': document.querySelector('[name="csrf-token"]')?.content || ''
                }
              })
              .then(response => {
                if (response.ok) {
                  return response.json();
                } else if (response.status === 401) {
                  console.log('[PolicyFallback] User not authenticated');
                  return null;
                }
                throw new Error('Failed to check policy status');
              })
              .then(data => {
                if (data && data.requires_policy_acceptance && data.missing_policies && data.missing_policies.length > 0) {
                  console.log('[PolicyFallback] User needs policy acceptance - ensuring modal is visible');
                  
                  // Force modal to be visible if the main script failed
                  if (modal.classList.contains('hidden')) {
                    console.log('[PolicyFallback] Main script failed - showing modal manually');
                    modal.classList.remove('hidden');
                    modal.style.display = 'block';
                    modal.style.zIndex = '9999';
                    document.body.style.overflow = 'hidden';
                    
                    // Add emergency styling to ensure visibility
                    modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100%';
                    modal.style.height = '100%';
                    
                    // Show a simple message if the dynamic content failed to load
                    const container = document.getElementById('policies-to-accept');
                    if (container && container.children.length === 0) {
                      container.innerHTML = `
                        <div class="text-center p-8 bg-yellow-50 border border-yellow-200 rounded">
                          <h3 class="text-lg font-medium text-yellow-800 mb-4">Policy Acceptance Required</h3>
                          <p class="text-yellow-700 mb-4">You need to accept our updated policies to continue using BizBlasts.</p>
                          <a href="/policy_acceptances" class="inline-block bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                            Accept Policies â†’
                          </a>
                        </div>
                      `;
                    }
                  }
                } else {
                  console.log('[PolicyFallback] No policy acceptance required');
                }
              })
              .catch(error => {
                console.log('[PolicyFallback] Error checking policy status:', error);
              });
            }
          }, 500);
        });
      </script>
    <% end %>
  </body>
</html>
