<%
  # Shared booking details partial
  # Required parameter:
  # - booking: The booking to display
  # Optional parameters:
  # - show_actions: Whether to show action buttons (default: false)
  # - admin_mode: Whether details are shown in admin view (default: false)
  # - show_customer: Whether to show customer details (default: true)
  # - condensed: Whether to show a condensed version (default: false)
  # - show_product_addons: Whether to show product add-ons (default: true)
  
  # Set defaults
  show_actions = false if show_actions.nil?
  admin_mode = false if admin_mode.nil?
  show_customer = true if show_customer.nil?
  condensed = false if condensed.nil?
  show_product_addons = true if show_product_addons.nil?
  
  # Helper to determine status color class
  def status_color(status)
    case status
    when 'pending'
      'text-yellow-600 bg-yellow-100'
    when 'confirmed'
      'text-green-600 bg-green-100'
    when 'cancelled'
      'text-red-600 bg-red-100'
    when 'completed'
      'text-blue-600 bg-blue-100'
    when 'no_show'
      'text-gray-600 bg-gray-100'
    else
      'text-gray-700'
    end
  end
%>

<div class="booking-details <%= condensed ? 'text-sm' : '' %>">
  <div class="<%= condensed ? 'flex justify-between mb-2' : 'flex justify-between mb-4' %>">
    <h2 class="<%= condensed ? 'text-lg font-semibold' : 'text-xl font-semibold' %>">
      <%= service_with_variant(booking) %>
    </h2>
    <span class="px-3 py-1 rounded-full text-sm font-medium <%= status_color(booking.status) %>">
      <%= booking.status.capitalize %>
    </span>
  </div>

  <%# Display Service Image if available %>
  <% if booking.service.present? && booking.service.primary_image&.attached? %>
    <div class="mb-4">
      <% img = booking.service.primary_image %>
      <%= image_tag(
            rails_public_blob_url(img.variant(:thumb)),
            srcset: [
              "#{rails_public_blob_url(img.variant(:thumb))} 400w",
              "#{rails_public_blob_url(img.variant(:medium))} 1200w"
            ].join(', '),
            sizes: '(max-width: 768px) 100vw, 300px',
            class: "rounded shadow-md object-cover"
          ) %>
    </div>
  <% end %>

  <% if booking.respond_to?(:quantity) && booking.quantity.to_i > 1 %>
    <div class="<%= condensed ? '' : 'mb-4' %>">
      <h3 class="text-sm font-medium text-gray-500 <%= condensed ? 'inline mr-1' : 'mb-1' %>">Quantity:</h3>
      <p class="<%= condensed ? 'inline text-gray-900' : 'text-gray-900' %>"><%= booking.quantity %></p>
    </div>
  <% end %>

  <div class="<%= condensed ? 'space-y-1' : 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-4' %>">
    <% unless condensed %>
      <div>
        <h3 class="text-sm font-medium text-gray-500 mb-1">Business</h3>
        <p class="text-gray-900"><%= booking.business.name %></p>
      </div>
    <% end %>

    <div>
      <h3 class="text-sm font-medium text-gray-500 <%= condensed ? 'inline mr-1' : 'mb-1' %>">Staff Member:</h3>
      <p class="<%= condensed ? 'inline text-gray-900' : 'text-gray-900' %>"><%= booking.staff_member_name %></p>
    </div>

    <div>
      <h3 class="text-sm font-medium text-gray-500 <%= condensed ? 'inline mr-1' : 'mb-1' %>">Date & Time:</h3>
      <p class="<%= condensed ? 'inline text-gray-900' : 'text-gray-900' %>">
        <% if condensed %>
          <%= booking.local_start_time.strftime("%b %d, %Y at %I:%M %p") %>
        <% else %>
                <%= booking.local_start_time.strftime("%A, %B %d, %Y") %><br>
      <%= booking.local_start_time.strftime("%I:%M %p") %> - <%= booking.local_end_time.strftime("%I:%M %p") %>
        <% end %>
      </p>
    </div>

    <% unless condensed %>
      <div>
        <h3 class="text-sm font-medium text-gray-500 mb-1">Duration</h3>
        <p class="text-gray-900"><%= service_duration(booking) %> minutes</p>
      </div>
    <% end %>

    <% if booking.respond_to?(:amount) && booking.amount.present? && !condensed %>
      <div>
        <h3 class="text-sm font-medium text-gray-500 mb-1">Price</h3>
        <p class="text-gray-900"><%= number_to_currency(booking.amount) %></p>
      </div>
    <% end %>
    
    <% if show_customer && booking.tenant_customer.present? %>
      <% unless condensed %>
        <div class="<%= admin_mode ? 'md:col-span-2' : '' %>">
          <h3 class="text-sm font-medium text-gray-500 mb-1">Customer</h3>
          <p class="text-gray-900">
            <%= booking.customer_full_name %> 
            <% if admin_mode %>
              <br><%= mail_to booking.customer_email, booking.customer_email %>
              <% if booking.tenant_customer.phone.present? %>
                <br><%= booking.tenant_customer.phone %>
              <% end %>
            <% end %>
          </p>
        </div>
      <% else %>
        <div>
          <h3 class="text-sm font-medium text-gray-500 inline mr-1">Customer:</h3>
          <p class="inline text-gray-900"><%= booking.customer_full_name %></p>
        </div>
      <% end %>
    <% end %>
  </div>

  <% if booking.notes.present? && !condensed %>
    <div class="mt-4">
      <h3 class="text-sm font-medium text-gray-500 mb-1">Notes</h3>
      <p class="text-gray-900 whitespace-pre-line"><%= booking.notes %></p>
    </div>
  <% end %>

  <%# Video Meeting Section %>
  <% if booking.has_video_meeting? && !condensed %>
    <div class="mt-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
      <div class="flex items-center mb-3">
        <svg class="w-6 h-6 text-indigo-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
        </svg>
        <h3 class="text-lg font-semibold text-indigo-800">Video Meeting</h3>
        <span class="ml-2 px-2 py-0.5 text-xs font-medium rounded-full bg-indigo-100 text-indigo-700">
          <%= booking.video_meeting_provider_name %>
        </span>
      </div>

      <div class="space-y-3">
        <div>
          <h4 class="text-sm font-medium text-indigo-700 mb-1">Join URL (for customer)</h4>
          <div class="flex items-center">
            <a href="<%= booking.video_meeting_url %>" target="_blank" rel="noopener noreferrer"
               class="text-indigo-600 hover:text-indigo-800 underline break-all mr-2">
              <%= booking.video_meeting_url %>
            </a>
            <button type="button"
                    class="inline-flex items-center px-2 py-1 text-xs font-medium text-indigo-700 bg-indigo-100 hover:bg-indigo-200 rounded cursor-pointer"
                    onclick="navigator.clipboard.writeText('<%= j(booking.video_meeting_url) %>'); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy', 2000);">
              Copy
            </button>
          </div>
        </div>

        <% if booking.video_meeting_host_url.present? %>
          <div>
            <h4 class="text-sm font-medium text-indigo-700 mb-1">Host URL (for staff)</h4>
            <div class="flex items-center">
              <a href="<%= booking.video_meeting_host_url %>" target="_blank" rel="noopener noreferrer"
                 class="text-indigo-600 hover:text-indigo-800 underline break-all mr-2">
                <%= booking.video_meeting_host_url %>
              </a>
              <button type="button"
                      class="inline-flex items-center px-2 py-1 text-xs font-medium text-indigo-700 bg-indigo-100 hover:bg-indigo-200 rounded cursor-pointer"
                      onclick="navigator.clipboard.writeText('<%= j(booking.video_meeting_host_url) %>'); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy', 2000);">
                Copy
              </button>
            </div>
          </div>
        <% end %>

        <% if booking.video_meeting_password.present? %>
          <div>
            <h4 class="text-sm font-medium text-indigo-700 mb-1">Meeting Password</h4>
            <div class="flex items-center">
              <span class="text-indigo-900 font-mono bg-indigo-100 px-2 py-1 rounded mr-2">
                <%= booking.video_meeting_password %>
              </span>
              <button type="button"
                      class="inline-flex items-center px-2 py-1 text-xs font-medium text-indigo-700 bg-indigo-100 hover:bg-indigo-200 rounded cursor-pointer"
                      onclick="navigator.clipboard.writeText('<%= j(booking.video_meeting_password) %>'); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy', 2000);">
                Copy
              </button>
            </div>
          </div>
        <% end %>

        <% if booking.video_meeting_id.present? %>
          <div>
            <h4 class="text-sm font-medium text-indigo-700 mb-1">Meeting ID</h4>
            <span class="text-indigo-900 font-mono"><%= booking.video_meeting_id %></span>
          </div>
        <% end %>
      </div>

      <div class="mt-4 pt-3 border-t border-indigo-200">
        <a href="<%= booking.video_meeting_url %>" target="_blank" rel="noopener noreferrer"
           class="inline-flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-md transition-colors">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
          </svg>
          Join Video Meeting
        </a>
      </div>
    </div>
  <% elsif booking.video_meeting_video_pending? && !condensed %>
    <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
      <div class="flex items-center">
        <svg class="w-5 h-5 text-yellow-600 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-yellow-800 text-sm font-medium">Video meeting is being created...</span>
      </div>
    </div>
  <% elsif booking.video_meeting_video_failed? && !condensed %>
    <div class="mt-6 p-4 bg-red-50 border border-red-200 rounded-lg">
      <div class="flex items-center">
        <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span class="text-red-800 text-sm font-medium">Failed to create video meeting. Please contact support.</span>
      </div>
    </div>
  <% end %>

  <% if show_product_addons %>
    <div class="mt-4">
      <h3 class="text-lg font-semibold mb-2">Product Add-ons</h3>
      <% if booking.booking_product_add_ons.any? %>
        <table class="min-w-full divide-y divide-gray-200 mb-4">
          <thead>
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Variant</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Price</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
            </tr>
          </thead>
          <tbody>
            <% booking.booking_product_add_ons.each do |add_on| %>
              <tr>
                <td class="px-4 py-2 align-top"><%= add_on.product_variant.product.name %></td>
                <td class="px-4 py-2 align-top"><%= add_on.product_variant.name %></td>
                <td class="px-4 py-2 align-top"><%= add_on.quantity %></td>
                <td class="px-4 py-2 align-top"><%= number_to_currency(add_on.price) %></td>
                <td class="px-4 py-2 align-top"><%= number_to_currency(add_on.total_amount) %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p class="text-gray-500 italic mb-4">No product add-ons have been added to this booking.</p>
      <% end %>
    </div>
  <% end %>

  <!-- Related Invoice Section -->
  <% if booking.invoice %>
    <div class="mt-6 p-4 bg-purple-50 border border-purple-200 rounded">
      <h3 class="text-lg font-semibold mb-2 text-purple-800">Related Invoice</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <p><span class="font-medium">Invoice Number:</span> <%= booking.invoice.invoice_number %></p>
          <p><span class="font-medium">Status:</span> 
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
              <%= booking.invoice.status == 'pending' ? 'bg-yellow-100 text-yellow-800' : '' %>
              <%= booking.invoice.status == 'paid' ? 'bg-green-100 text-green-800' : '' %>
              <%= booking.invoice.status == 'overdue' ? 'bg-red-100 text-red-800' : '' %>
              <%= booking.invoice.status == 'cancelled' ? 'bg-gray-100 text-gray-800' : '' %>
            ">
              <%= booking.invoice.status.titleize %>
            </span>
          </p>
          <% if booking.service.present? %>
            <p><span class="font-medium">Service Cost:</span> <%= number_to_currency service_price(booking) %></p>
          <% end %>
        </div>
        <div>
          <p><span class="font-medium">Total Items:</span> <%= number_to_currency booking.invoice.original_amount %></p>
          <% if booking.invoice.discount_amount&.positive? %>
            <p><span class="font-medium">Discount Applied:</span> <%= number_to_currency booking.invoice.discount_amount %></p>
            <p><span class="font-medium">Net Amount:</span> <%= number_to_currency booking.invoice.amount %></p>
          <% end %>
          <% if booking.invoice.tax_amount&.positive? %>
            <p><span class="font-medium">Tax:</span> <%= number_to_currency booking.invoice.tax_amount %></p>
          <% end %>
          <p><span class="font-medium">Grand Total:</span> <%= number_to_currency booking.invoice.total_amount %></p>
        </div>
      </div>
      <div class="mt-3">
        <% if request.subdomain.present? && request.subdomain != 'www' %>
          <%= link_to 'View Invoice Details', transaction_path(booking.invoice, type: 'invoice'), 
              class: "bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm" %>
        <% else %>
          <%= link_to 'View Invoice Details', transaction_path(booking.invoice, type: 'invoice'), 
              class: "bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm" %>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Tips Section -->
  <% if !admin_mode && booking.eligible_for_tips? && !booking.tip_processed? %>
    <div class="<%= condensed ? 'mt-2' : 'mt-6' %> p-4 bg-blue-50 border border-blue-200 rounded">
      <h3 class="text-lg font-semibold mb-2 text-blue-800">Add a Tip</h3>
      <p class="text-blue-700 text-sm mb-3">
        Enjoyed your experience? Show your appreciation with a tip for your service provider.
      </p>
      <div class="flex justify-start">
        <%= link_to "Add Tip", new_booking_tip_path(booking), 
            class: "bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-4 rounded" %>
      </div>
    </div>
  <% end %>

  <% if show_actions && booking.can_cancel? %>
    <div class="<%= condensed ? 'mt-2' : 'mt-6' %>">
      <% if booking.status == 'pending' %>
        <p class="text-yellow-700 text-sm mb-2">
          This booking is pending confirmation.
        </p>
      <% end %>
      
      <div class="<%= condensed ? '' : 'flex justify-end' %>">
        <% if admin_mode %>
          <%= button_to "Cancel Booking", admin_cancel_booking_path(booking), method: :patch,
                      class: "cursor-pointer bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-1 px-3 rounded",
                      data: { confirm: "Are you sure you want to cancel this booking?" } %>
        <% else %>
          <%# Show this client-side cancel button only if the current user is a client. Business-manager users already have their own actions elsewhere. %>
          <% if current_user&.client? %>
            <%= button_to "Cancel Booking", cancel_tenant_my_booking_path(booking), method: :patch,
                        class: "cursor-pointer bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-1 px-3 rounded",
                        data: { confirm: "Are you sure you want to cancel this booking?" } %>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>
</div> 