<% @business = current_tenant %>
<div class="container mx-auto px-4 py-8" data-product-id="<%= @product.id %>">
  <h1 class="text-3xl font-bold mb-6"><%= @product.name %></h1>
  <div class="product-detail flex gap-8">
    <div class="product-images flex-1">
      <% if @product.images.attached? %>
        <% @product.images.each do |img| %>
          <%= image_tag rails_public_blob_url(img.variant(resize_to_limit: [400, 400])), style: 'margin: 0 10px 10px 0;' %>
        <% end %>
      <% end %>
    </div>
    <div class="product-info flex-2">
      <p class="text-gray-700 mt-1"><%= @product.description %></p>
      
      <!-- Promotional Pricing Display -->
      <div class="pricing-section mt-4">
        <% if @product.on_promotion? %>
          <!-- Show promotional badge -->
          <div class="mb-2">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
              <%= @product.promotion_display_text %>
            </span>
          </div>
          
          <!-- Show promotional price and original price -->
          <div class="price-display">
            <span class="text-2xl font-bold text-green-600">
              <%= number_to_currency(@product.promotional_price) %>
            </span>
            <span class="text-lg text-gray-500 line-through ml-2">
              <%= number_to_currency(@product.price) %>
            </span>
            <span class="text-sm text-green-600 ml-2">
              (Save <%= @product.savings_percentage %>%)
            </span>
          </div>
        <% else %>
          <!-- Regular pricing -->
          <p class="text-gray-900 font-medium text-xl">
            Price: <%= number_to_currency(@product.price) %>
          </p>
        <% end %>
      </div>
      
      <% if @product.product_variants.any? %>
        <%= form_tag line_items_path, method: :post do %>
          <div class="mt-4">
            <label for="variant" class="block text-sm font-medium text-gray-700">Choose a variant:</label>
            <%
              variant_collection = @product.product_variants.map do |variant|
                price_modifier = variant.price_modifier || 0
                variant_price = @product.on_promotion? ? @product.promotional_price + price_modifier : variant.final_price
                OpenStruct.new(
                  id: variant.id,
                  name: variant.name,
                  price: variant_price,
                  description: @product.on_promotion? && price_modifier != 0 ? "promotional price" : nil
                )
              end
            %>
            <%= render 'shared/rich_dropdown',
                collection: variant_collection,
                field_name: "product_variant_id",
                selected_value: nil,
                prompt_text: "Select a variant",
                value_method: :id,
                text_method: :name,
                price_method: :price,
                description_method: :description,
                dropdown_id: "product_variant_dropdown" %>
          </div>
          <div class="mt-4">
            <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity:</label>
            <input type="number" name="quantity" id="quantity" value="1" min="1" 
                   class="mt-1 block w-20 border-gray-300 rounded-md shadow-sm">
          </div>
          <%= submit_tag 'Add to Cart', class: 'mt-4 px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors' %>
        <% end %>
      <% end %>
      <% if @product.product_type == 'service' || @product.product_type == 'mixed' %>
        <% if @product.add_on_services.any? %>
          <hr class="my-4" />
          <h2 class="text-xl font-semibold mb-2">Associated Services</h2>
          <ul class="list-disc ml-6">
            <% @product.add_on_services.each do |service| %>
              <li><%= link_to service.name, service_path(service), class: "text-blue-600 hover:text-blue-800" %></li>
            <% end %>
          </ul>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<style>
.product-detail {
  display: flex;
  gap: 2rem;
}
.product-images {
  flex: 1;
}
.product-info {
  flex: 2;
}
</style> 