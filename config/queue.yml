default: &default
  dispatchers:
    - polling_interval: 1
      batch_size: 500
      concurrency_maintenance_interval: 300
  workers:
    # Dedicated worker for email jobs - 1 thread to enforce serial execution
    # This prevents hitting Resend's 2 requests/second rate limit
    # The EmailRateLimiter enforces 2 req/sec PER THREAD, so with 1 thread
    # we guarantee max 2 emails/sec globally
    - queues: [ mailers ]
      threads: 1
      processes: 1
      polling_interval: 0.95

    # Dedicated worker for image processing jobs - 1 thread to prevent memory spikes
    # Image processing is memory-intensive: a 4000x3000 image decompresses to ~48MB
    # Running multiple jobs concurrently can easily exceed memory limits
    # Serial processing ensures stable memory usage
    - queues: [ image_processing ]
      threads: 1
      processes: 1
      polling_interval: 1

    # Default worker for all other jobs - higher concurrency for throughput
    - queues: [ default, low_priority ]
      threads: 3
      processes: <%= ENV.fetch("JOB_CONCURRENCY", 1) %>
      polling_interval: .75

development:
  <<: *default

test:
  <<: *default

production:
  <<: *default
