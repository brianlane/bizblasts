default: &default
  dispatchers:
    - polling_interval: 1
      batch_size: 500
      concurrency_maintenance_interval: 300
  workers:
    # Dedicated worker for email jobs - 1 thread to enforce serial execution
    # This prevents hitting Resend's 2 requests/second rate limit
    # The EmailRateLimiter enforces 2 req/sec PER THREAD, so with 1 thread
    # we guarantee max 2 emails/sec globally
    - queues: [ mailers ]
      threads: 1
      processes: 1
      polling_interval: 0.5

    # Default worker for all other jobs - higher concurrency for throughput
    - queues: [ default, low_priority ]
      threads: 3
      processes: <%= ENV.fetch("JOB_CONCURRENCY", 1) %>
      polling_interval: 0.1

development:
  <<: *default

test:
  <<: *default

production:
  <<: *default
