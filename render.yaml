services:
  - type: web
    name: bizblasts
    env: ruby
    buildCommand: "./bin/render-build.sh"
    startCommand: "bundle exec puma -C config/puma.rb"
    healthCheckPath: /healthcheck
    domains:
      - bizblasts.com
      - "*.bizblasts.com"  # Add this for subdomain support
    envVars:
      - key: PORT
        value: 10000
      - key: SECRET_KEY_BASE
        sync: false
      - key: DATABASE_URL
        fromDatabase:
          name: bizblast-postgresql
          property: connectionString
      - key: DATABASE_HOST
        fromDatabase:
          name: bizblast-postgresql
          property: host  
      - key: DATABASE_PORT
        fromDatabase:
          name: bizblast-postgresql
          property: port
      - key: DATABASE_NAME
        fromDatabase:
          name: bizblast-postgresql
          property: database
      - key: DATABASE_USERNAME
        fromDatabase:
          name: bizblast-postgresql
          property: user
      - key: DATABASE_PASSWORD
        fromDatabase:
          name: bizblast-postgresql
          property: password
      - key: RAILS_MASTER_KEY
        sync: false
      - key: RAILS_ENV
        value: production
      - key: RAILS_LOG_LEVEL
        value: info
      - key: RESEND_API_KEY
        sync: false
      - key: MAILER_EMAIL
        sync: false
      - key: ADMIN_EMAIL
        sync: false
      - key: SOLID_QUEUE_IN_PUMA
        value: "true"
      # Memory optimization settings
      - key: SOLID_QUEUE_JOB_TIMEOUT
        value: "300" # 5 minute timeout
      # Ruby GC optimization
      - key: RUBY_GC_HEAP_INIT_SLOTS
        value: "10000"
      - key: RUBY_GC_HEAP_FREE_SLOTS
        value: "3000"
      - key: RUBY_GC_HEAP_GROWTH_FACTOR
        value: "1.25"
      - key: RUBY_GC_MALLOC_LIMIT
        value: "16000000"

  # Separate background job worker (optional - if you want dedicated worker)
  # Uncomment this section if you prefer separate worker processes
  # - type: worker
  #   name: bizblasts-worker
  #   env: ruby
  #   buildCommand: "./bin/render-build.sh"
  #   startCommand: "bundle exec rails solid_queue:start"
  #   envVars:
  #     - key: DATABASE_URL
  #       fromDatabase:
  #         name: bizblast-postgresql
  #         property: connectionString
  #     # ... copy other necessary env vars from web service

databases:
  - name: bizblast-postgresql
    plan: free